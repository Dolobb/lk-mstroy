# Geo-Admin ‚Äî –ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

## –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ

**geo-admin** ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –≤–Ω—É—Ç—Ä–∏ –º–æ–Ω–æ—Ä–µ–ø–æ `lk-mstroy`.
–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–µ–æ–∑–æ–Ω–∞–º–∏: –∫–∞—Ä—å–µ—Ä—ã, –Ω–∞–∫–æ–ø–∏—Ç–µ–ª–∏, –±–∞–∑—ã, –æ—Ç–≤–∞–ª—ã –∏ –¥—Ä—É–≥–∏–µ –æ–±—ä–µ–∫—Ç—ã —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
–î–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞–º–∏: –ö–ò–ü —Ç–µ—Ö–Ω–∏–∫–∏, –¢—è–≥–∞—á–∏, –°–∞–º–æ—Å–≤–∞–ª—ã.

---

## –°—Ç–µ–∫

| –°–ª–æ–π | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è |
|------|-----------|
| –°–µ—Ä–≤–µ—Ä | Node.js + Express + TypeScript (tsx watch) |
| –ë–î | PostgreSQL 17 (–ø–æ—Ä—Ç 5433), —Å—Ö–µ–º–∞ `geo`, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ PostGIS 3.6 |
| –ö–ª–∏–µ–Ω—Ç | Vanilla TypeScript ‚Üí ES-–º–æ–¥—É–ª–∏, Leaflet 1.9.4, Leaflet.draw 1.0.4 |
| –ü–æ—Ä—Ç | :3003 |

**–ü–æ—á–µ–º—É PG17, –∞ –Ω–µ PG16?**
Homebrew-–±—É—Ç—ã–ª–∫–∞ PostGIS 3.6.2 —Å–æ–±—Ä–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –ø–æ–¥ PG17/18. PG16 –æ—Å—Ç–∞–ª—Å—è –¥–ª—è `kip_vehicles`.

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
geo-admin/
‚îú‚îÄ‚îÄ package.json              # devDeps –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Ç–∏–ø–æ–≤ (@types/leaflet)
‚îú‚îÄ‚îÄ –ü–†–û–ì–†–ï–°–°.md               # —ç—Ç–æ—Ç —Ñ–∞–π–ª
‚îÇ
‚îú‚îÄ‚îÄ server/
‚îÇ   ‚îú‚îÄ‚îÄ package.json          # –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îú‚îÄ‚îÄ .env                  # DB_PORT=5433, DB_USER=max, GEO_SERVER_PORT=3003
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 001_geo_schema.sql   # CREATE SCHEMA geo + 4 —Ç–∞–±–ª–∏—Ü—ã
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ index.ts              # Express —Å–µ—Ä–≤–µ—Ä, –≤—Å–µ —Ä–æ—É—Ç—ã
‚îÇ       ‚îú‚îÄ‚îÄ migrate.ts            # SQL –º–∏–≥—Ä–∞—Ü–∏–∏ (npm run migrate)
‚îÇ       ‚îú‚îÄ‚îÄ config/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ env.ts            # dotenv ‚Üí —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ database.ts       # pg.Pool singleton
‚îÇ       ‚îú‚îÄ‚îÄ utils/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ logger.ts         # console-–ª–æ–≥–≥–µ—Ä —Å —É—Ä–æ–≤–Ω—è–º–∏
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ slugify.ts        # —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è + uniqueObjectUid()
‚îÇ       ‚îú‚îÄ‚îÄ repositories/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ objectRepo.ts     # CRUD geo.objects
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ zoneRepo.ts       # CRUD geo.zones + —Ç–µ–≥–∏ + PostGIS
‚îÇ       ‚îî‚îÄ‚îÄ services/
‚îÇ           ‚îî‚îÄ‚îÄ migrationService.ts  # –∏–º–ø–æ—Ä—Ç geozones.geojson ‚Üí –ë–î
‚îÇ
‚îî‚îÄ‚îÄ client/
    ‚îú‚îÄ‚îÄ tsconfig.json         # target ES2020, moduleResolution node
    ‚îî‚îÄ‚îÄ src/
        ‚îú‚îÄ‚îÄ index.html        # CDN Leaflet + Leaflet.draw, —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
        ‚îú‚îÄ‚îÄ styles.css        # —Å—Ç–∏–ª–∏ sidebar + –∫–∞—Ä—Ç—ã + –º–æ–¥–∞–ª–æ–∫
        ‚îú‚îÄ‚îÄ api.ts            # —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ fetch-–æ–±—ë—Ä—Ç–∫–∏
        ‚îú‚îÄ‚îÄ map.ts            # –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã, —Ä–∏—Å–æ–≤–∞–Ω–∏–µ, —Å–ª–æ–∏
        ‚îú‚îÄ‚îÄ sidebar.ts        # –¥–µ—Ä–µ–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤, –º–æ–¥–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—ã
        ‚îî‚îÄ‚îÄ main.ts           # —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞, —Å–∫–ª–µ–π–∫–∞ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
    dist/                     # —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JS (npm run build:client)
        ‚îú‚îÄ‚îÄ api.js
        ‚îú‚îÄ‚îÄ map.js
        ‚îú‚îÄ‚îÄ sidebar.js
        ‚îî‚îÄ‚îÄ main.js
```

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞ `geo`

```sql
geo.objects     -- —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (–∫–∞—Ä—å–µ—Ä—ã, –±–∞–∑—ã –∏ —Ç.–¥.)
  id, uid, name, smu, region, created_at, updated_at

geo.zones       -- –ø–æ–ª–∏–≥–æ–Ω–∞–ª—å–Ω—ã–µ –≥–µ–æ–∑–æ–Ω—ã (GEOMETRY(Polygon, 4326))
  id, uid, object_id ‚Üí objects, name, geom, created_at, updated_at
  INDEX: GIST –Ω–∞ geom (–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫)

geo.zone_tags   -- —Ç–µ–≥–∏ –∑–æ–Ω (–º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º)
  zone_id ‚Üí zones, tag

geo._migrations -- —É—á—ë—Ç –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö SQL-–º–∏–≥—Ä–∞—Ü–∏–π
  name, applied_at
```

### –¢–µ–≥–∏ –∑–æ–Ω

| –¢–µ–≥ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –¶–≤–µ—Ç –Ω–∞ –∫–∞—Ä—Ç–µ |
|-----|-----------|---------------|
| `dst_zone` | –†–∞–±–æ—á–∞—è –∑–æ–Ω–∞ –ö–ò–ü/–î–°–¢ (–∏—Å—Ö–æ–¥–Ω—ã–µ –≥–µ–æ–∑–æ–Ω—ã –∏–∑ –ö–ò–ü) | –§–∏–æ–ª–µ—Ç–æ–≤—ã–π |
| `dt_boundary` | –ì—Ä–∞–Ω–∏—Ü–∞ –æ–±—ä–µ–∫—Ç–∞ (—Å–∞–º–æ—Å–≤–∞–ª—ã) | –°–µ—Ä—ã–π |
| `dt_loading` | –ó–æ–Ω–∞ –ø–æ–≥—Ä—É–∑–∫–∏ (—Å–∞–º–æ—Å–≤–∞–ª—ã) | –ó–µ–ª—ë–Ω—ã–π |
| `dt_unloading` | –ó–æ–Ω–∞ –≤—ã–≥—Ä—É–∑–∫–∏ (—Å–∞–º–æ—Å–≤–∞–ª—ã) | –û—Ä–∞–Ω–∂–µ–≤—ã–π |
| `dt_onsite` | –†–∞–±–æ—Ç–∞ –ø–æ –º–µ—Å—Ç—É (—Å–∞–º–æ—Å–≤–∞–ª—ã) | –°–∏–Ω–∏–π |

### –ó–∞–ø—É—Å–∫ psql

```bash
/usr/local/opt/postgresql@17/bin/psql -p 5433 -d mstroy
```

---

## API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –û–±—ä–µ–∫—Ç—ã

| –ú–µ—Ç–æ–¥ | URL | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|-----|---------|
| GET | `/api/geo/objects` | –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (—Å zone_count) |
| GET | `/api/geo/objects/:uid` | –û–±—ä–µ–∫—Ç + –µ–≥–æ –∑–æ–Ω—ã (GeoJSON FeatureCollection) |
| POST | `/api/geo/objects` | –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç `{name, smu?, region?}` |
| PUT | `/api/geo/objects/:uid` | –û–±–Ω–æ–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç |
| DELETE | `/api/geo/objects/:uid` | –£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç (cascade ‚Üí zones) |

### –ó–æ–Ω—ã

| –ú–µ—Ç–æ–¥ | URL | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|-----|---------|
| POST | `/api/geo/zones` | –°–æ–∑–¥–∞—Ç—å –∑–æ–Ω—É `{objectUid, name, tags[], geometry}` |
| PUT | `/api/geo/zones/:uid` | –û–±–Ω–æ–≤–∏—Ç—å –∑–æ–Ω—É |
| DELETE | `/api/geo/zones/:uid` | –£–¥–∞–ª–∏—Ç—å –∑–æ–Ω—É |
| GET | `/api/geo/zones/by-object/:objectUid` | –ó–æ–Ω—ã –æ–±—ä–µ–∫—Ç–∞ (GeoJSON FC), ?tags=dst_zone,dt_boundary |
| GET | `/api/geo/zones/by-tag/:tag` | –í—Å–µ –∑–æ–Ω—ã —Å —Ç–µ–≥–æ–º (GeoJSON FC) |

### –°–ª—É–∂–µ–±–Ω—ã–µ

| –ú–µ—Ç–æ–¥ | URL | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|-----|---------|
| GET | `/api/geo/health` | `{status: "ok"}` |
| POST | `/api/geo/admin/migrate-from-files` | –ó–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–∞ geozones.geojson |

### –°—Ç–∞—Ç–∏–∫–∞

| URL | –ß—Ç–æ –æ—Ç–¥–∞—ë—Ç |
|-----|-----------|
| `/admin/` | Admin UI (index.html) |
| `/admin/*.js` | –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TypeScript –∫–ª–∏–µ–Ω—Ç–∞ |
| `/admin/styles.css` | –°—Ç–∏–ª–∏ |

---

## –ò–º–ø–æ—Ä—Ç –≥–µ–æ–∑–æ–Ω (–≤—ã–ø–æ–ª–Ω–µ–Ω –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `kip/config/geozones.geojson` ‚Äî ~450 –∑–æ–Ω, –∏–∑ –Ω–∏—Ö 291 —Å `controlType === 1`

**–õ–æ–≥–∏–∫–∞ —Ä–∞–∑–±–∏–≤–∫–∏**:
- –ò–º—è –∑–æ–Ω—ã –≤–∏–¥–∞ `"–°–ú–£ –≥. –¢—é–º–µ–Ω—å, –ö–∞—Ä—å–µ—Ä –°–∏–Ω–≥–∞–ø–∞–π"`
- –ß–∞—Å—Ç—å –¥–æ –∑–∞–ø—è—Ç–æ–π ‚Üí `smu` –æ–±—ä–µ–∫—Ç–∞
- –ß–∞—Å—Ç—å –ø–æ—Å–ª–µ ‚Üí `name` –æ–±—ä–µ–∫—Ç–∞
- uid –æ–±—ä–µ–∫—Ç–∞ ‚Üí —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏ –æ–±—ä–µ–∫—Ç–∞ (slugify)
- –ï—Å–ª–∏ uid –∑–∞–Ω—è—Ç ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è `-2`, `-3` –∏ —Ç.–¥.

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: 291 –∑–æ–Ω–∞, 282 –æ–±—ä–µ–∫—Ç–∞, —Ç–µ–≥ `dst_zone` –Ω–∞ –∫–∞–∂–¥–æ–π –∑–æ–Ω–µ.

```bash
npm run migrate-geo   # –∏–∑ geo-admin/server/
```

---

## –ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Admin UI)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
index.html
  ‚îî‚îÄ‚îÄ <script type="module" src="main.js">
        ‚îú‚îÄ‚îÄ api.ts      ‚Äî fetch –∫ /api/geo/*
        ‚îú‚îÄ‚îÄ map.ts      ‚Äî Leaflet –∫–∞—Ä—Ç–∞ + —Ä–∏—Å–æ–≤–∞–Ω–∏–µ
        ‚îî‚îÄ‚îÄ sidebar.ts  ‚Äî UI –ø–∞–Ω–µ–ª–∏ –∏ –º–æ–¥–∞–ª–æ–∫
```

TypeScript –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è `tsc` –≤ `client/dist/*.js`.
–ë—Ä–∞—É–∑–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ—Ç ES-–º–æ–¥—É–ª–∏ –Ω–∞–ø—Ä—è–º—É—é (–±–µ–∑ –±–∞–Ω–¥–ª–µ—Ä–∞).

### –ö–∞—Ä—Ç–∞ (map.ts)

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:**
- –¶–µ–Ω—Ç—Ä: `[57.15, 65.55]` (–¢—é–º–µ–Ω—å), zoom 11
- –¢–∞–π–ª—ã: OpenStreetMap
- `L.FeatureGroup` ‚Äî —Å–ª–æ–π –¥–ª—è –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª–∏–≥–æ–Ω–æ–≤

**–†–∏—Å–æ–≤–∞–Ω–∏–µ –∑–æ–Ω:**
- `activateLeafletDraw()` ‚Äî —Å–æ–∑–¥–∞—ë—Ç `L.Draw.Polygon` –∏ —Å—Ä–∞–∑—É –≤—ã–∑—ã–≤–∞–µ—Ç `.enable()`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –ø–æ –∫–∞—Ä—Ç–µ ‚Äî —Å—Ç–∞–≤–∏—Ç –≤–µ—Ä—à–∏–Ω—ã, –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Äî –∑–∞–≤–µ—Ä—à–∞–µ—Ç
- –ö–Ω–æ–ø–∫–∞ ¬´‚úè –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –∑–æ–Ω—É¬ª –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è —Å–∏–Ω–∏–º, Escape ‚Äî –æ—Ç–º–µ–Ω—è–µ—Ç
- –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ `draw:created` –Ω–∞ –∫–∞—Ä—Ç–µ

**–¶–≤–µ—Ç–∞ –∑–æ–Ω** (colorByTags):
```
dst_zone      ‚Üí #6a1b9a (—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π, opacity 0.20)
dt_boundary   ‚Üí #888888 (—Å–µ—Ä—ã–π,      opacity 0.10)
dt_loading    ‚Üí #2e7d32 (–∑–µ–ª—ë–Ω—ã–π,    opacity 0.30)
dt_unloading  ‚Üí #e65100 (–æ—Ä–∞–Ω–∂–µ–≤—ã–π,  opacity 0.30)
dt_onsite     ‚Üí #1565c0 (—Å–∏–Ω–∏–π,      opacity 0.25)
```

**–ü–æ–ø–∞–ø –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–æ–Ω—É:**
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ç–µ–≥–∏ –∏ –∫–Ω–æ–ø–∫—É ¬´–£–¥–∞–ª–∏—Ç—å¬ª (–≤—ã–∑—ã–≤–∞–µ—Ç DELETE /api/geo/zones/:uid).

### –°–∞–π–¥–±–∞—Ä (sidebar.ts)

- –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–æ–º (–∫–ª–∏–∫ ‚Üí —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –∑–æ–Ω—ã –æ–±—ä–µ–∫—Ç–∞)
- –°—á—ë—Ç—á–∏–∫ –∑–æ–Ω —É –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (badge)
- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞: name, smu, region
- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–æ–Ω—ã: –≤—ã–±–æ—Ä –æ–±—ä–µ–∫—Ç–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ, —á–µ–∫–±–æ–∫—Å—ã —Ç–µ–≥–æ–≤
- Error banner (5 —Å–µ–∫ –∞–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ)

### –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (main.ts)

–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ:
1. `GET /api/geo/objects` ‚Üí —Ä–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤
2. `GET /api/geo/zones/by-tag/dst_zone` ‚Üí **–æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å** –Ω–∞ –≤—Å–µ 291 –∑–æ–Ω—É (–≤–º–µ—Å—Ç–æ 283 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö)
3. –í—Å–µ –∑–æ–Ω—ã —Ä–∏—Å—É—é—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ

---

## –ö–æ–º–∞–Ω–¥—ã

```bash
# –ò–∑ geo-admin/server/

npm run dev           # –∑–∞–ø—É—Å–∫ dev-—Å–µ—Ä–≤–µ—Ä–∞ —Å hot reload (tsx watch)
npm run build         # –∫–æ–º–ø–∏–ª—è—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –≤ dist/
npm run build:client  # –∫–æ–º–ø–∏–ª—è—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ client/src ‚Üí client/dist
npm run migrate       # –ø—Ä–∏–º–µ–Ω–∏—Ç—å SQL-–º–∏–≥—Ä–∞—Ü–∏–∏ (001_geo_schema.sql)
npm run migrate-geo   # –∏–º–ø–æ—Ä—Ç geozones.geojson (–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ)
```

---

## –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

| –®–∞–≥ | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|--------|---------|
| –ë–î –∏ —Å—Ö–µ–º–∞ | ‚úÖ –ì–æ—Ç–æ–≤–æ | PG17:5433, PostGIS, 4 —Ç–∞–±–ª–∏—Ü—ã |
| Express API | ‚úÖ –ì–æ—Ç–æ–≤–æ | 11 —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, PostGIS |
| –ò–º–ø–æ—Ä—Ç –∑–æ–Ω | ‚úÖ –ì–æ—Ç–æ–≤–æ | 291 –∑–æ–Ω–∞ –∏–∑ geozones.geojson |
| Admin UI | ‚úÖ –ì–æ—Ç–æ–≤–æ | Leaflet + —Ä–∏—Å–æ–≤–∞–Ω–∏–µ + CRUD |
| –†–∏—Å–æ–≤–∞–Ω–∏–µ –∑–æ–Ω | ‚úÖ –ì–æ—Ç–æ–≤–æ | L.Draw.Polygon –ø—Ä—è–º–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ |
| –°–∞–º–æ—Å–≤–∞–ª—ã-—Ç–µ–≥–∏ | üî≤ –°–ª–µ–¥—É—é—â–µ–µ | dt_boundary, dt_loading –∏ —Ç.–¥. |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ö–ò–ü | üî≤ –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è | API –¥–ª—è kip/server |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –°–∞–º–æ—Å–≤–∞–ª–∞–º–∏ | üî≤ –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è | API –¥–ª—è samosvaly/ |
| –î–µ–ø–ª–æ–π nginx | üî≤ –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è | `/geo-admin` ‚Üí Node:3003 |

---

## –°–ª–µ–¥—É—é—â–∏–µ —ç—Ç–∞–ø—ã (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)

### –≠—Ç–∞–ø 5 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–µ–≥–æ–≤ —Å–∞–º–æ—Å–≤–∞–ª–æ–≤ –≤ UI
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–¥–∞—Ç—å –∑–æ–Ω–µ —Ç–µ–≥–∏ `dt_boundary`, `dt_loading`, `dt_unloading`, `dt_onsite`
- –í–∏–∑—É–∞–ª—å–Ω–∞—è –ª–µ–≥–µ–Ω–¥–∞ –Ω–∞ –∫–∞—Ä—Ç–µ (—á—Ç–æ –∫–∞–∫–æ–π —Ü–≤–µ—Ç –æ–∑–Ω–∞—á–∞–µ—Ç)
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–æ–Ω –Ω–∞ –∫–∞—Ä—Ç–µ –ø–æ —Ç–µ–≥—É

### –≠—Ç–∞–ø 6 ‚Äî API –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º
- `GET /api/geo/zones/by-object/:objectUid?tags=dt_loading` ‚Äî –¥–ª—è –º–æ–¥—É–ª—è —Å–∞–º–æ—Å–≤–∞–ª–æ–≤
- `GET /api/geo/check-zone?lat=&lng=&tag=` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è —Ç–æ—á–∫–∏ –≤ –∑–æ–Ω—É (ST_Contains)
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (API –∫–ª—é—á –∏–ª–∏ shared secret)

### –≠—Ç–∞–ø 7 ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ö–ò–ü —Ç–µ—Ö–Ω–∏–∫–∏
- –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ `kip/config/geozones.geojson` –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã ‚Üí geo-admin API
- kip/server –¥—ë—Ä–≥–∞–µ—Ç `GET /api/geo/zones/by-tag/dst_zone` –≤–º–µ—Å—Ç–æ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞

### –≠—Ç–∞–ø 8 ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –°–∞–º–æ—Å–≤–∞–ª–∞–º–∏
- –ú–æ–¥—É–ª—å `samosvaly/` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç geo-admin API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–æ–Ω –æ–±—ä–µ–∫—Ç–∞
- –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–∫–æ–≤: –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ dt_loading / dt_unloading / dt_boundary

### –≠—Ç–∞–ø 9 ‚Äî –î–µ–ø–ª–æ–π
- nginx reverse proxy: `/geo-admin` ‚Üí `localhost:3003`
- PM2 –¥–ª—è –∑–∞–ø—É—Å–∫–∞ geo-admin —Å–µ—Ä–≤–µ—Ä–∞
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ
