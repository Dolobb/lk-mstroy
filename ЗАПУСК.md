# Запуск и выгрузка данных — ЛК Мстрой

## Первый запуск (один раз на новой машине)

```powershell
# 1. Получить репозиторий
git clone https://github.com/Dolobb/lk-mstroy.git
cd lk-mstroy

# 2. Установить зависимости Node.js
cd frontend && npm install && cd ..
cd kip && npm install && cd ..
cd dump-trucks/server && npm install && cd ../..
cd geo-admin/server && npm install && cd ../..

# 3. Собрать клиент geo-admin (dist/ не хранится в git)
cd geo-admin/client && npx tsc && cd ../..


# 4. Установить зависимости Python (тягачи)
cd tyagachi
python -m venv .venv
.venv\Scripts\activate        # Windows
pip install -r requirements.txt
cd ..
```

### Создать .env файлы (не хранятся в git)

**`kip/.env`**
```env
DB_NAME=kip_vehicles
DB_USER=postgres
DB_PASSWORD=ВАШ_ПАРОЛЬ_PG
DB_HOST=localhost
DB_PORT=5432

TIS_API_URL=https://tt.tis-online.com/tt/api/v3
TIS_API_TOKENS=6C72DAA5076B,8FE4AB7FA54C,79206427B583,333825C3820A,16B1EF2678AD,C47F3BB6DE85,8ABFA559284D,A84D5398F74E,0505CB134904,5F28AB5DB6CD,C8564A44FD67,7831D53E9DD0,3045540D6E2B,3CDD3FE02277,62AB1C7131F9,920DA1FD0B46,9AC0CADC0CE3,5455D081B637

SERVER_PORT=3001
NODE_ENV=development
```

**`dump-trucks/server/.env`**
```env
DB_HOST=localhost
DB_PORT=5433
DB_NAME=mstroy
DB_USER=postgres
DB_PASSWORD=ВАШ_ПАРОЛЬ_PG

TIS_API_URL=https://tt.tis-online.com/tt/api/v3
TIS_API_TOKENS=6C72DAA5076B,8FE4AB7FA54C,79206427B583,333825C3820A,16B1EF2678AD,C47F3BB6DE85,8ABFA559284D,A84D5398F74E,0505CB134904,5F28AB5DB6CD,C8564A44FD67,7831D53E9DD0,3045540D6E2B,3CDD3FE02277,62AB1C7131F9,920DA1FD0B46,9AC0CADC0CE3,5455D081B637

DT_SERVER_PORT=3002
NODE_ENV=development
```

> `tyagachi/config.yaml` уже содержит токены — отдельный env не нужен.

### Создать базы данных (один раз)

> На Windows обычно один PostgreSQL на порту 5432 — убери `-p 5433` из команд.

```powershell
# КИП
psql -U postgres -c "CREATE DATABASE kip_vehicles;"
cd kip && npm run migrate --workspace=server && cd ..

# Самосвалы + гео
psql -U postgres -c "CREATE DATABASE mstroy;"
cd dump-trucks/server && npm run migrate && cd ../..
cd geo-admin/server && npm run migrate && cd ../..

# Импорт геозон (зоны нарисованные в geo-admin, файл geo_export.sql из репо)
psql -U postgres -d mstroy -f geo_export.sql
```

---

## Обновление (после git pull)

```powershell
git pull origin main
# Перезапускать серверы нужно только если менялись файлы в server/ или src/web/
# Фронтенд (frontend/src/) — перезапуск не нужен при dev-режиме (hot reload)
```

---

## Ежедневный запуск (5 терминалов)

```powershell
# Терминал 1 — КИП бэкенд
cd kip;npm run dev:server

# Терминал 2 — Самосвалы бэкенд
cd dump-trucks/server;npm run dev

# Терминал 3 — Тягачи бэкенд
cd tyagachi;.venv\Scripts\python.exe main.py --web --port 8000

# Терминал 4 — Гео-админ
cd geo-admin/server && npm run dev

# Терминал 5 — Единый фронтенд (UI)
cd frontend && npm run dev
```

Открыть в браузере: http://localhost:5173

---

## Выгрузка данных

> Используй `curl.exe` (не `curl`) в PowerShell, или Invoke-RestMethod.
> Каждый вызов — асинхронный. Смотри прогресс в терминале сервера.

### Тягачи

```powershell
# 1 неделя
cd tyagachi && .venv\Scripts\python.exe main.py --fetch --from 19.02.2026 --to 25.02.2026

# Полный месяц
cd tyagachi && .venv\Scripts\python.exe main.py --fetch --from 01.02.2026 --to 25.02.2026
```

Или через веб-интерфейс: http://localhost:5173 → вкладка Тягачи → кнопка Синхронизация.

---

### КИП техники

Pipeline берёт **7 дней назад** от указанной даты. Запускай последовательно,
жди завершения каждого (смотри логи в терминале сервера КИП).

```powershell
# 1 неделя — один вызов
curl.exe -X POST "http://localhost:3001/api/admin/fetch?date=2026-02-25"

# Полный месяц — 4 вызова с интервалом 7 дней
curl.exe -X POST "http://localhost:3001/api/admin/fetch?date=2026-02-25"
# ... ждёшь завершения в логах терминала КИП ...
curl.exe -X POST "http://localhost:3001/api/admin/fetch?date=2026-02-18"
curl.exe -X POST "http://localhost:3001/api/admin/fetch?date=2026-02-11"
curl.exe -X POST "http://localhost:3001/api/admin/fetch?date=2026-02-04"
```

Проверить что данные пришли:
```powershell
curl.exe "http://localhost:3001/api/vehicles/weekly"
```

---

### Самосвалы

```powershell
# Запускать из корня репо (файл fetch-samosvaly.ps1)

# 1 неделя
.\fetch-samosvaly.ps1 -from 2026-02-19 -to 2026-02-25

# Полный месяц
.\fetch-samosvaly.ps1 -from 2026-02-01 -to 2026-02-25
```

> Если PowerShell ругается на политику выполнения скриптов:
> ```powershell
> Set-ExecutionPolicy -Scope CurrentUser RemoteSigned
> ```

---

## Диагностика ошибок

| Проблема | Причина | Решение |
|---|---|---|
| `Failed to resolve import` | Не установлены node_modules | `npm install` в нужной папке |
| `server running on port XXXX` сразу после старта | Краш + перезапуск nodemon | Смотри ошибку выше этой строки |
| PowerShell terminal exit code 2 | curl-алиас бросил исключение | Использовать `curl.exe` |
| `connection refused` на порту БД | PostgreSQL не запущен | Запустить службу PostgreSQL в Windows |
| `database does not exist` | БД не создана | Выполнить шаг "Создать базы данных" |
