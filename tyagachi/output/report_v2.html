<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Аналитика заявок (V2 - 3-колоночный layout)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            background: #f0f2f5;
            color: #1a1a1a;
        }

        /* Fixed Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #1a365d;
            color: white;
            padding: 12px 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header-content {
            max-width: 1920px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            white-space: nowrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            background: rgba(255,255,255,0.15);
            color: white;
        }

        .search-box input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .search-box input:focus {
            outline: none;
            background: rgba(255,255,255,0.25);
        }

        .header-stats {
            display: flex;
            gap: 20px;
            font-size: 13px;
        }

        .header-stats span {
            opacity: 0.8;
        }

        .header-stats strong {
            color: #63b3ed;
        }

        /* Filter Panel */
        .filter-panel {
            background: #1e4a7a;
            padding: 12px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .filter-panel-content {
            max-width: 1920px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            position: relative;
        }

        .filter-label {
            font-size: 11px;
            color: rgba(255,255,255,0.9);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-dropdown {
            position: relative;
        }

        .filter-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 180px;
            justify-content: space-between;
        }

        .filter-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        .filter-btn .count {
            background: #4299e1;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
        }

        .filter-popup {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            min-width: 280px;
            max-height: 350px;
            z-index: 2000;
            display: none;
            overflow: hidden;
        }

        .filter-popup.active {
            display: block;
        }

        .filter-search {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .filter-search input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 13px;
        }

        .filter-options {
            max-height: 250px;
            overflow-y: auto;
        }

        .filter-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            color: #2d3748;
        }

        .filter-option:hover {
            background: #f7fafc;
        }

        .filter-option input {
            margin-right: 10px;
        }

        .filter-option.hidden {
            display: none;
        }

        .filter-actions {
            padding: 10px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-actions button {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            min-width: 70px;
        }

        .filter-actions .apply-btn {
            background: #4299e1;
            color: white;
        }

        .filter-actions .clear-btn {
            background: #e2e8f0;
            color: #4a5568;
        }

        .filter-actions .select-all-btn {
            background: #48bb78;
            color: white;
        }

        .parking-time-filter {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .parking-time-filter input {
            width: 70px;
            padding: 8px 10px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            background: rgba(255,255,255,0.15);
            color: white;
            text-align: center;
        }

        .parking-time-filter input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .parking-time-filter span {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
        }

        /* Parking groups by day */
        .parking-day-group {
            margin-bottom: 12px;
        }

        .parking-day-header {
            font-size: 12px;
            font-weight: 600;
            color: #975a16;
            background: #fef5e7;
            padding: 6px 12px;
            border-radius: 4px 4px 0 0;
            border: 1px solid #fbd38d;
            border-bottom: none;
        }

        .parking-day-items {
            border: 1px solid #fbd38d;
            border-radius: 0 0 4px 4px;
        }

        .parking-item {
            background: #fffaf0;
            border-bottom: 1px solid #fbd38d;
            padding: 8px 12px;
            font-size: 13px;
        }

        .parking-item:last-child {
            border-bottom: none;
            border-radius: 0 0 4px 4px;
        }

        /* Main Content */
        .container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 140px 20px 40px;
        }

        .sort-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .sort-bar label {
            font-size: 13px;
            color: #666;
        }

        .sort-bar select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }

        .results-info {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
        }

        /* Request Card */
        .request {
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .request.hidden {
            display: none;
        }

        .request-header {
            background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%);
            color: white;
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }

        .request-header:hover {
            background: linear-gradient(135deg, #2b4c7e 0%, #1a365d 100%);
        }

        .request-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .request-route {
            font-size: 13px;
            opacity: 0.9;
        }

        .request-badges {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success { background: #48bb78; }
        .badge-info { background: #4299e1; }
        .badge-warning { background: #ed8936; }

        /* V2: Увеличенный хедер заявки */
        .request-header-v2 {
            background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%);
            color: white;
            padding: 16px 20px;
            cursor: pointer;
        }

        .request-header-v2:hover {
            background: linear-gradient(135deg, #2b4c7e 0%, #1a365d 100%);
        }

        .request-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .request-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }

        .request-header-top .request-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .request-header-top .request-route {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 13px;
            opacity: 0.95;
            max-width: 450px;
        }

        .route-line {
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .route-line .emoji {
            flex-shrink: 0;
        }

        .route-line .addr {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .request-header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        /* V2: Нижняя часть хедера - данные заявки */
        .request-header-data {
            display: flex;
            align-items: stretch;
            gap: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .header-data-main {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 20px;
            flex: 1;
        }

        .header-data-item {
            display: flex;
            flex-direction: column;
        }

        .header-data-item .label {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
        }

        .header-data-item .value {
            font-size: 14px;
            font-weight: 500;
        }

        /* Период с округлёнными рамками и метками от/до */
        .header-data-period {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .period-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .period-label {
            font-size: 10px;
            text-transform: lowercase;
            opacity: 0.7;
            min-width: 18px;
        }

        .period-date {
            background: rgba(255,255,255,0.15);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Груз с весом/объёмом справа от названия */
        .header-data-cargo {
            flex-direction: row !important;
            align-items: flex-start !important;
            gap: 12px;
        }

        .cargo-left {
            display: flex;
            flex-direction: column;
        }

        .cargo-left .label {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
        }

        .cargo-name {
            font-size: 14px;
            font-weight: 500;
            max-width: 180px;
            line-height: 1.3;
        }

        .cargo-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-shrink: 0;
        }

        .cargo-detail {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cargo-detail .cargo-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .cargo-detail .cargo-value {
            background: rgba(255,255,255,0.15);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Объект затрат - справа, 35%, с разделителем */
        .header-data-cost {
            flex: 0 0 35%;
            max-width: 35%;
            padding-left: 16px;
            border-left: 1px solid rgba(255,255,255,0.25);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .header-data-cost .label {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .header-data-cost .value {
            font-size: 13px;
            font-weight: 500;
            line-height: 1.3;
        }

        /* V2: Subheader - Расчёт план + ПЛ */
        .request-subheader {
            padding: 12px 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: none;
        }

        .request-subheader.active {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .subheader-section {
            flex: 1;
            min-width: 280px;
        }

        .subheader-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 8px 0;
        }

        .subheader-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .subheader-section-toggle {
            font-size: 11px;
            color: #718096;
        }

        .subheader-section-body {
            display: none;
            padding-top: 8px;
        }

        .subheader-section-body.active {
            display: block;
        }

        /* Compact calc plan in subheader */
        .subheader-calc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
        }

        .subheader-calc-item {
            background: white;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #e9d8fd;
        }

        .subheader-calc-item label {
            font-size: 10px;
            color: #805ad5;
            display: block;
        }

        .subheader-calc-item input {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid #d6bcfa;
            border-radius: 3px;
            font-size: 12px;
        }

        .subheader-calc-results {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .subheader-calc-result {
            font-size: 12px;
            color: #553c9a;
        }

        .subheader-calc-result .val {
            font-weight: 600;
        }

        /* Compact PL list in subheader */
        .subheader-pl-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .subheader-pl-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .subheader-pl-dates {
            color: #718096;
            font-size: 11px;
        }

        .subheader-pl-vehicle {
            color: #4a5568;
            font-weight: 500;
            font-size: 11px;
        }

        .subheader-pl-extra {
            color: #a0aec0;
            font-size: 10px;
        }

        .subheader-pl-number {
            font-weight: 600;
            color: #2d3748;
        }

        .subheader-pl-info {
            color: #718096;
            font-size: 11px;
        }

        .subheader-pl-vehicles {
            display: flex;
            gap: 4px;
            margin-left: 4px;
        }

        .subheader-pl-vehicle-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Vehicle toggle bar - compact checkboxes above map */
        .vehicle-toggle-bar {
            display: flex;
            gap: 4px;
            padding: 6px 10px;
            background: #f0f4f8;
            border-bottom: 1px solid #e2e8f0;
        }

        .vehicle-toggle-item {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .vehicle-toggle-item input {
            display: none;
        }

        .vehicle-toggle-dot {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            opacity: 1;
            transition: opacity 0.2s;
        }

        .vehicle-toggle-item input:not(:checked) + .vehicle-toggle-dot {
            opacity: 0.3;
        }

        /* Timeline parking filter in header */
        .timeline-parking-filter {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #718096;
        }

        .timeline-parking-filter label {
            display: flex;
            align-items: center;
            gap: 2px;
            cursor: pointer;
        }

        .timeline-parking-filter input[type="checkbox"] {
            margin: 0;
        }

        .timeline-parking-filter input[type="number"] {
            width: 40px;
            padding: 2px 4px;
            border: 1px solid #e2e8f0;
            border-radius: 3px;
            font-size: 11px;
        }

        /* V2: 2-колоночный layout (вместо 3) */
        .request-body-layout-v2 {
            display: none;
            grid-template-columns: 1fr 360px;
            gap: 16px;
            min-height: 600px;
            padding: 16px;
        }

        .request-body-layout-v2 .center-column {
            position: sticky;
            top: 140px;
            height: calc(100vh - 180px);
            align-self: flex-start;
            display: flex;
            flex-direction: column;
        }

        .request-body-layout-v2 .right-column {
            overflow-y: auto;
            max-height: calc(100vh - 180px);
            padding-left: 12px;
        }

        .request-body-layout-v2 .map-container {
            display: flex !important;
            flex-direction: column;
            height: 100%;
            margin: 0;
        }

        .request-body-layout-v2 .map-layout {
            flex: 1;
            min-height: 0;
        }

        .request-body-layout-v2 .map-display-params {
            display: block !important;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            padding: 10px;
        }

        @media (max-width: 992px) {
            .request-body-layout-v2 {
                grid-template-columns: 1fr;
            }

            .request-body-layout-v2 .center-column {
                height: 500px;
                position: static;
            }

            .request-body-layout-v2 .right-column {
                max-height: none;
            }
        }

        .request-body {
            padding: 20px;
        }

        /* Plan Container */
        .plan-section {
            background: #f7fafc;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #4299e1;
            border-radius: 2px;
        }

        .plan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .plan-item {
            background: white;
            padding: 10px 12px;
            border-radius: 6px;
            border-left: 3px solid #4299e1;
        }

        .plan-item .label {
            font-size: 11px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .plan-item .value {
            font-size: 14px;
            color: #1a202c;
            font-weight: 500;
            margin-top: 2px;
        }

        /* Calculated Plan */
        .calc-plan-section {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border: 1px solid #d6bcfa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .calc-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .calc-plan-title {
            font-size: 14px;
            font-weight: 600;
            color: #553c9a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calc-plan-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #805ad5;
            border-radius: 2px;
        }

        .calc-plan-toggle {
            font-size: 12px;
            color: #805ad5;
        }

        .calc-plan-body {
            display: none;
        }

        .calc-plan-body.active {
            display: block;
        }

        .calc-plan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
        }

        .calc-input-group {
            background: white;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #e9d8fd;
        }

        .calc-input-group label {
            font-size: 11px;
            color: #805ad5;
            display: block;
            margin-bottom: 4px;
        }

        .calc-input-group input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #d6bcfa;
            border-radius: 4px;
            font-size: 13px;
            color: #553c9a;
        }

        .calc-input-group input:focus {
            outline: none;
            border-color: #805ad5;
        }

        .calc-input-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .calc-input-row input {
            width: 80px;
        }

        .calc-results {
            background: white;
            border-radius: 6px;
            padding: 12px;
            border: 1px solid #d6bcfa;
        }

        .calc-results-title {
            font-size: 12px;
            font-weight: 600;
            color: #553c9a;
            margin-bottom: 8px;
        }

        .calc-result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
        }

        .calc-result-item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 4px 0;
            border-bottom: 1px dashed #e9d8fd;
        }

        .calc-result-item:last-child {
            border-bottom: none;
        }

        .calc-result-item .label {
            color: #718096;
        }

        .calc-result-item .value {
            font-weight: 600;
            color: #553c9a;
        }

        .calc-result-item.highlight {
            background: #faf5ff;
            padding: 6px 8px;
            border-radius: 4px;
            border: none;
            margin-top: 4px;
        }

        .calc-result-item.highlight .value {
            color: #38a169;
            font-size: 14px;
        }

        /* PL Card */
        .pl-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .pl-header {
            background: #edf2f7;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .pl-header:hover {
            background: #e2e8f0;
        }

        .pl-number {
            font-weight: 600;
            color: #2d3748;
        }

        .pl-meta {
            font-size: 13px;
            color: #718096;
        }

        .pl-body {
            padding: 16px;
        }

        /* Vehicle/Fact Section */
        .vehicle-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .vehicle-header {
            background: #f7fafc;
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .vehicle-name {
            font-weight: 600;
            color: #2d3748;
        }

        .vehicle-reg {
            font-size: 13px;
            color: #4a5568;
            font-family: monospace;
        }

        .fact-section {
            padding: 16px;
        }

        .fact-title {
            font-size: 13px;
            font-weight: 600;
            color: #38a169;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .fact-title::before {
            content: '';
            width: 4px;
            height: 14px;
            background: #38a169;
            border-radius: 2px;
        }

        .fact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 16px;
        }

        .fact-item {
            background: #f0fff4;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #48bb78;
        }

        .fact-item .label {
            font-size: 11px;
            color: #276749;
        }

        .fact-item .value {
            font-size: 14px;
            font-weight: 600;
            color: #22543d;
        }

        /* Parkings */
        .parkings-section {
            margin-top: 12px;
        }

        .parkings-title {
            font-size: 12px;
            font-weight: 600;
            color: #744210;
            margin-bottom: 8px;
        }

        .parking-time {
            font-weight: 500;
            color: #744210;
        }

        .parking-address {
            color: #975a16;
            font-size: 12px;
            margin-top: 2px;
        }

        /* Fuels */
        .fuels-section {
            margin-top: 12px;
        }

        .fuels-title {
            font-size: 12px;
            font-weight: 600;
            color: #553c9a;
            margin-bottom: 8px;
        }

        .fuel-item {
            background: #faf5ff;
            border: 1px solid #d6bcfa;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 6px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            font-size: 13px;
        }

        .fuel-stat {
            text-align: center;
        }

        .fuel-stat .label {
            font-size: 10px;
            color: #805ad5;
        }

        .fuel-stat .value {
            font-weight: 600;
            color: #553c9a;
        }

        /* No data */
        .no-data {
            color: #a0aec0;
            font-size: 13px;
            font-style: italic;
            padding: 10px;
        }

        /* Copy button styles */
        .copyable {
            cursor: pointer;
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .copyable:hover {
            opacity: 0.85;
        }

        .copy-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border: none;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 0.2s, background 0.2s;
        }

        .copy-btn:hover {
            opacity: 1;
            background: rgba(255,255,255,0.35);
        }

        .copy-btn.copied {
            background: #48bb78;
            opacity: 1;
        }

        .pl-header .copy-btn, .vehicle-header .copy-btn {
            background: rgba(0,0,0,0.08);
        }

        .pl-header .copy-btn:hover, .vehicle-header .copy-btn:hover {
            background: rgba(0,0,0,0.15);
        }

        /* Expand/collapse arrow indicators */
        .expand-arrow {
            display: inline-block;
            width: 16px;
            height: 16px;
            text-align: center;
            font-size: 10px;
            transition: transform 0.2s;
            color: rgba(255,255,255,0.7);
        }

        .expand-arrow.down {
            transform: rotate(0deg);
        }

        .expand-arrow.up {
            transform: rotate(180deg);
        }

        .pl-header .expand-arrow, .vehicle-header .expand-arrow {
            color: #718096;
        }

        /* Timezone tag style */
        .timezone-tag {
            font-size: 11px;
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 10px;
            font-weight: normal;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px;
            color: #a0aec0;
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
            .search-box {
                max-width: 100%;
            }
            .header-stats {
                flex-wrap: wrap;
                gap: 10px;
            }
        }

        /* Map styles */
        .map-container {
            display: none;
            height: 450px;
            margin: 12px 0;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .map-container.active {
            display: block;
        }

        .leaflet-map {
            height: 100%;
            width: 100%;
            border-radius: 8px;
        }

        .map-toggle-btn {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .map-toggle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(56, 161, 105, 0.3);
        }

        .map-toggle-btn.active {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        }

        .map-legend {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 12px;
            line-height: 1.6;
        }

        .map-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-legend-line {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        .map-legend-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Map display params panel */
        .map-display-params {
            display: none;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }

        .map-display-params.active {
            display: block;
        }

        .params-title {
            font-weight: 600;
            font-size: 13px;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .filter-label {
            font-size: 12px;
            color: #4a5568;
            min-width: 140px;
        }

        .filter-checkbox {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .filter-checkbox:hover {
            border-color: #cbd5e0;
            background: #edf2f7;
        }

        .filter-checkbox input {
            margin: 0;
        }

        .filter-checkbox .color-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .map-display-params input[type="number"] {
            width: 70px;
            padding: 4px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Map layout with timeline */
        .map-layout {
            display: flex;
            height: 100%;
        }

        .map-area {
            flex: 1;
            min-width: 0;
            height: 100%;
        }

        .map-area .leaflet-map {
            height: 100%;
            width: 100%;
            border-radius: 8px 0 0 8px;
        }

        .timeline-area {
            width: 280px;
            height: 100%;
            border-left: 1px solid #e2e8f0;
            overflow-y: auto;
            background: #fafafa;
            flex-shrink: 0;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #edf2f7;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .timeline-title {
            font-weight: 600;
            font-size: 12px;
            margin: 0;
        }

        .timeline-expand-btn {
            background: none;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 10px;
            cursor: pointer;
            color: #4a5568;
        }

        .timeline-expand-btn:hover {
            background: #e2e8f0;
        }

        .timeline-items {
            padding: 0;
        }

        .timeline-vehicle-group {
            border-bottom: 1px solid #e2e8f0;
        }

        .timeline-vehicle-header {
            font-weight: 600;
            font-size: 11px;
            padding: 8px 12px;
            background: #edf2f7;
            border-left: 4px solid #48bb78;
            color: #2d3748;
        }

        .timeline-item {
            padding: 6px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.15s;
        }

        .timeline-item:hover {
            background: #edf2f7;
        }

        .timeline-item.parking {
            background: #fffaf0;
            border-left: 3px solid #ed8936;
        }

        .timeline-item.point {
            border-left: 3px solid #48bb78;
        }

        .timeline-item .time {
            font-weight: 600;
            color: #2d3748;
        }

        .timeline-item .info {
            color: #718096;
            font-size: 10px;
            margin-top: 2px;
        }

        .timeline-item .info.address {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        /* Collapsed timeline - hide addresses */
        .timeline-area.collapsed .timeline-item .info.address {
            display: none;
        }

        /* Archive button styles */
        .archive-btn {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            margin-left: 8px;
        }

        .archive-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(237, 137, 54, 0.3);
        }

        .archive-btn.archived {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .archive-btn.archived:hover {
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
        }

        .request.is-archived {
            opacity: 0.6;
        }

        .request.is-archived .request-header {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
        }

        /* Hide archived filter */
        .hide-archived-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: rgba(255,255,255,0.8);
        }

        .hide-archived-toggle input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Day navigation tabs */
        .day-nav {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            background: #f7fafc;
            padding: 8px;
            border-radius: 8px;
        }

        .day-nav-btn {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.2s;
        }

        .day-nav-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .day-nav-btn.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }

        .day-nav-btn .day-stats {
            font-size: 10px;
            opacity: 0.8;
            margin-left: 4px;
        }

        .day-content {
            display: none;
        }

        .day-content.active {
            display: block;
        }

        /* Day summary card */
        .day-summary {
            background: linear-gradient(135deg, #ebf8ff 0%, #e6fffa 100%);
            border: 1px solid #81e6d9;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 12px;
        }

        .day-summary-title {
            font-size: 13px;
            font-weight: 600;
            color: #234e52;
            margin-bottom: 8px;
        }

        .day-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }

        .day-summary-item {
            text-align: center;
        }

        .day-summary-item .label {
            font-size: 10px;
            color: #285e61;
            text-transform: uppercase;
        }

        .day-summary-item .value {
            font-size: 14px;
            font-weight: 600;
            color: #234e52;
        }

        /* Shift loading styles */
        .shift-load-btn {
            background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .shift-load-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(128, 90, 213, 0.3);
        }

        .shift-load-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .shift-container {
            display: none;
            margin-top: 16px;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border: 1px solid #d6bcfa;
            border-radius: 8px;
            padding: 16px;
        }

        .shift-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .shift-tab {
            padding: 8px 16px;
            background: white;
            border: 1px solid #d6bcfa;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #553c9a;
            transition: all 0.2s;
        }

        .shift-tab:hover {
            background: #e9d8fd;
        }

        .shift-tab.active {
            background: #805ad5;
            color: white;
            border-color: #805ad5;
        }

        .shift-content {
            display: none;
        }

        .shift-content.active {
            display: block;
        }

        .shift-period {
            font-size: 12px;
            color: #805ad5;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .shift-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .shift-item {
            background: white;
            padding: 10px 12px;
            border-radius: 6px;
            border-left: 3px solid #805ad5;
        }

        .shift-item .label {
            font-size: 11px;
            color: #805ad5;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .shift-item .value {
            font-size: 14px;
            font-weight: 600;
            color: #553c9a;
            margin-top: 2px;
        }

        .cache-note {
            font-size: 11px;
            color: #805ad5;
            margin-bottom: 8px;
            font-style: italic;
        }

        /* === V2: 3-Column Layout === */
        .request-body-layout {
            display: none;  /* Hidden by default, toggled to grid */
            grid-template-columns: 320px 1fr 360px;
            gap: 16px;
            min-height: 600px;
            padding: 16px;
        }

        .left-column {
            overflow-y: auto;
            max-height: calc(100vh - 180px);
            padding-right: 12px;
        }

        .right-column {
            overflow-y: auto;
            max-height: calc(100vh - 180px);
            padding-left: 12px;
        }

        .center-column {
            position: sticky;
            top: 140px;
            height: calc(100vh - 180px);
            align-self: flex-start;
            display: flex;
            flex-direction: column;
        }

        /* Map always visible in v2 */
        .request-body-layout .map-container {
            display: flex !important;
            flex-direction: column;
            height: 100%;
            margin: 0;
        }

        .request-body-layout .map-layout {
            flex: 1;
            min-height: 0;
        }

        /* Compact PL list in left column */
        .pl-compact-list {
            margin-top: 12px;
        }

        .pl-compact-item {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .pl-compact-item:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .pl-compact-item.expanded {
            background: #ebf8ff;
            border-color: #4299e1;
        }

        .pl-compact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pl-compact-number {
            font-weight: 600;
            font-size: 13px;
            color: #2d3748;
        }

        .pl-compact-date {
            font-size: 11px;
            color: #718096;
        }

        .pl-compact-vehicles {
            margin-top: 8px;
            display: none;
        }

        .pl-compact-item.expanded .pl-compact-vehicles {
            display: block;
        }

        .pl-compact-vehicle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: white;
            border-radius: 4px;
            margin-top: 6px;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid transparent;
        }

        .pl-compact-vehicle:hover {
            background: #f0fff4;
        }

        .pl-compact-vehicle.selected {
            background: #ebf8ff;
            border-color: #3182ce;
        }

        .pl-vehicle-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .pl-vehicle-reg {
            font-size: 12px;
            font-weight: 500;
            font-family: monospace;
        }

        /* Vehicle selector in right column */
        .vehicle-selector {
            background: #f7fafc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .vehicle-selector-title {
            font-size: 12px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .vehicle-selector-item {
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.15s;
            border: 1px solid transparent;
        }

        .vehicle-selector-item:hover {
            background: #edf2f7;
        }

        .vehicle-selector-item.selected {
            background: #ebf8ff;
            border-color: #3182ce;
            border-left: 3px solid #3182ce;
        }

        .vehicle-selector-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .vehicle-selector-info {
            flex: 1;
        }

        .vehicle-selector-reg {
            font-weight: 600;
            font-size: 13px;
            font-family: monospace;
        }

        .vehicle-selector-name {
            font-size: 11px;
            color: #718096;
        }

        /* Active vehicle panel in right column */
        .active-vehicle-panel {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .vehicle-panels-cache {
            display: none;
        }

        /* Section headers in columns */
        .column-section {
            margin-bottom: 16px;
        }

        .column-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .column-section-title::before {
            content: '';
            width: 3px;
            height: 14px;
            background: #4299e1;
            border-radius: 2px;
        }

        /* Map params in center column - always visible */
        .request-body-layout .map-display-params {
            display: block !important;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            padding: 10px;
        }

        /* Timeline in center column */
        .request-body-layout .timeline-area {
            max-height: 200px;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .request-body-layout {
                grid-template-columns: 280px 1fr 320px;
            }
        }

        @media (max-width: 992px) {
            .request-body-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }

            .left-column, .center-column, .right-column {
                max-height: none;
                position: static;
            }

            .center-column {
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>📊 Аналитика заявок (V2 - 3-колоночный layout)</h1>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Поиск по номеру заявки, ПЛ или машины..." onkeyup="filterRequests()">
            </div>
            <div class="header-stats">
                <span>Заявок: <strong>27</strong></span>
                <span>ПЛ: <strong>34</strong></span>
                <span>ТС: <strong>34</strong></span>
            </div>
        </div>
        <div class="filter-panel">
            <div class="filter-panel-content">
                <div class="filter-group">
                    <div class="filter-label">Начало маршрута</div>
                    <div class="filter-dropdown">
                        <button class="filter-btn" onclick="toggleFilter('startAddr')">
                            <span>Все</span>
                            <span class="count" id="startAddrCount">0</span>
                        </button>
                        <div class="filter-popup" id="startAddrPopup">
                            <div class="filter-search">
                                <input type="text" placeholder="Поиск..." oninput="searchFilterOptions('startAddr', this.value)">
                            </div>
                            <div class="filter-options" id="startAddrOptions"></div>
                            <div class="filter-actions">
                                <button class="select-all-btn" onclick="selectAllFilter('startAddr')">Все</button>
                                <button class="clear-btn" onclick="clearFilter('startAddr')">Сбросить</button>
                                <button class="apply-btn" onclick="applyFilters()">Применить</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <div class="filter-label">Конец маршрута</div>
                    <div class="filter-dropdown">
                        <button class="filter-btn" onclick="toggleFilter('endAddr')">
                            <span>Все</span>
                            <span class="count" id="endAddrCount">0</span>
                        </button>
                        <div class="filter-popup" id="endAddrPopup">
                            <div class="filter-search">
                                <input type="text" placeholder="Поиск..." oninput="searchFilterOptions('endAddr', this.value)">
                            </div>
                            <div class="filter-options" id="endAddrOptions"></div>
                            <div class="filter-actions">
                                <button class="select-all-btn" onclick="selectAllFilter('endAddr')">Все</button>
                                <button class="clear-btn" onclick="clearFilter('endAddr')">Сбросить</button>
                                <button class="apply-btn" onclick="applyFilters()">Применить</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <div class="filter-label">Объект затрат</div>
                    <div class="filter-dropdown">
                        <button class="filter-btn" onclick="toggleFilter('costObj')">
                            <span>Все</span>
                            <span class="count" id="costObjCount">0</span>
                        </button>
                        <div class="filter-popup" id="costObjPopup">
                            <div class="filter-search">
                                <input type="text" placeholder="Поиск..." oninput="searchFilterOptions('costObj', this.value)">
                            </div>
                            <div class="filter-options" id="costObjOptions"></div>
                            <div class="filter-actions">
                                <button class="select-all-btn" onclick="selectAllFilter('costObj')">Все</button>
                                <button class="clear-btn" onclick="clearFilter('costObj')">Сбросить</button>
                                <button class="apply-btn" onclick="applyFilters()">Применить</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <div class="filter-label">Мин. время стоянки</div>
                    <div class="parking-time-filter">
                        <input type="number" id="minParkingTime" value="60" min="0" onchange="updateParkingDisplay()">
                        <span>мин</span>
                    </div>
                </div>
                <div class="filter-group">
                    <div class="filter-label">Архив</div>
                    <label class="hide-archived-toggle">
                        <input type="checkbox" id="hideArchived" onchange="filterRequests()">
                        <span>Скрыть просмотренные</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sort-bar">
            <label>Сортировка:</label>
            <select id="sortSelect" onchange="sortRequests()">
                <option value="date-desc">По дате (новые первые)</option>
                <option value="date-asc">По дате (старые первые)</option>
                <option value="number-asc">По номеру заявки</option>
            </select>
        </div>

        <div class="results-info" id="resultsInfo">
            Показано заявок: 27
        </div>

        <div id="requestsContainer">

        <div class="request" data-search="122189 1259067525 С725РН72 С/тягач Volvo FM Truck 6х4 12.8" data-date="09.02.2026" data-number="122189" data-start-addr="База МО36, Ялуторовский тракт 11-й км., с5/9, Тюмень" data-end-addr="Прииртышский, Р-404 Тюмень — Тобольск — Ханты-Мансийск" data-cost-obj="Строительство и реконструкция моста через р. Иртыш. А/д Р-404">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122189', this.querySelector('.copy-btn'));">
                                Заявка №122189
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">База МО36, Ялуторовский тракт 11-й км., с5/9, Тюмень</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Прииртышский, Р-404 Тюмень — Тобольск — Ханты-Мансийск</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122189', 'База МО36, Ялуторовский тракт 11-й км., с5/9, Тюмень', 'Прииртышский, Р-404 Тюмень — Тобольск — Ханты-Мансийск', '09.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">09.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">15.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">232.7 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">2ч 58м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">2 / 1</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">Завод ЖБИ перевозка арматурных каркасов БНС</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">69.12 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Строительство и реконструкция моста через р. Иртыш. А/д Р-404</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122189">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122189">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122189" value="2" min="1" onchange="updateCalcPlan('122189')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122189" value="1" min="1" onchange="updateCalcPlan('122189')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122189" value="233" min="1" onchange="updateCalcPlan('122189')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122189" value="65" min="10" max="120" onchange="updateCalcPlan('122189')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122189" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122189')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122189" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122189')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122189" value="09.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122189')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122189" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122189')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122189">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122189">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122189">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122189">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122189">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122189">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067525</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 04.02 20:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">С725РН72</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122189"></div>

                    <div id="map-122189" class="map-container active">
                        <div class="map-data"
                             data-polyline="{jn{IkayoKj@LPA\cF?o@Ac@ISSYiFsFuCqDo@m@vTcx@`AmCn@wB\u@`@a@XKJ?ZFXVLPPf@PnAVvF?j@E~@Kr@Ul@e@b@WHe@?y@KaCIyFe@aEMuELqBLaC\cGhAsl@dPaC^{BTkFH}DQ{AOeDm@cCq@sBs@kDaBmCcBmDmCiBiB}BeCmA{A{AwBmBwCsByDe^yt@gWkh@aAcBgBuCcByBw@}@aAaAyBoB_BeAcBaAgCeAcCs@iCc@mAMuBEcB@qAHmBTcB^_Bf@_Bn@uBfA_DzBgBbBiD~DyFxIgBdC{BvCqC~CyB|BiC~BoB`ByAdAgFbDoBdAkClAqUrIgj@`SuG|BeEnAs@Lsg@~FiFb@cBEgAe@[W]a@_@u@Oa@iE{PSkBC_CVaKh@ePbEgfAvGudBrA_\tCwv@tQiuE\aGt@_Kt@yPN{EL_KJmF~HgqBdFmpA`Bub@HmG?_FsAuxAa@__@i@qYcAab@q@eV[uIa@cIk@qIeA{LaAuIw@gGeB}KeBqJ_M_n@uYsyAoB_JuAeGiRou@}CaMm@kCuA_HwA{Ho@yDeBiLu@_Gek@caFk@iGkAoOmAqKoDkV}BcSyA}NcNqmAcIsq@mDcWw@oGs@iHc@kF]{FKmBYcJGgECcK@_EB_HVwUFgBJ{BPmCt@_Jv@iIv@kG|E}[|Ggh@nA}H\aBl@mClAuEr@sBdEyK|@oCbA_ElD{Q`A_Ej@mBzAkE|Mm^j@gBxBiInAcFfCeLpa@kpB|P}x@dB}GfEeOh@{Bb@{Bj@eEv@cIj@aFfAcIhImf@bBkL|@aHfA{J|@_KtD}c@`AuOTkGJ{GCaIIgHW_IgIycB}K}cCqBod@Q{FMsGGcN?_P@_KF{F\gNf@kLzBic@bT}yDvEk|@lE_w@j@qId@{Fn@{Fj@}DjDqR|@kF`AiGbCiRhAcHfDkR|@uFjA_J`Gsk@`Fmf@~@iIhAaIhBmK|@gErFuVzBqKzAsIfBaL|AeMnAeMh@{GfCi^rFyu@rC}a@zDam@hHydAZuFl@uML}CPcHJeGJiP@sQVoOB}G?eEGkEKqDIeC[gFg@uHa@qH[aJyAu]QiF[cNGmIAsE@yXNos@GoLIcGo@iVM}Cg@oJiGu~@iAyR_@mFYwCk@_E{Ck`@iJqnAs@_Kk@aKiQg~D[gIi@kPQsII_KDwk@KmMe@qXs@yTsBml@wNwpDmBcd@_@gHo@mJYiDuKegAmBqQ}@sHy@wFyA_JiAcGoCsM_AsDkAkEkDyL{A{EuCqIgAyC}B}FeCwFgQk^uB}D_FoI_JoN{BkE{@mBw@mBsCoIkE}NwBcJql@onCed@ssBmDoNoBoH_BoFiDuKc`@_iAkOgd@yf@axAw]mcAcOod@_^siA{BwGaKk\mBcGeEkNcCaHiD_Jw@yByDsL}Lib@sAeFyAiGcAmEwBeKw@gEoDgUqAmJwA}KmAoKcWedCsAsL}AgM}A_LmKir@wSqsAiO}aAa@_DwBeR}XqgCsBmPwB{NgA{GoAiHcC{LaCkK{CaMcCaJyCuJ{CiJad@grAkEwNsAyDkFcN{C}IguAgaEeGaR_GcRaHiU}Kc`@skA_fE{BwImAwFwBgKoBgI}AqFwAmE_BmEoBwEmCgGiIwS}BiFmB_EyDyHwCmF{CkF_EiG}EaH{GmIuCeD_~@{bAoAmAaDsC_E}C{AcAqGaEmFuCeCiAsFsB{GkBmIwAqRqByEs@kDq@kD_AuHmC{DgB{DsBmEsCmGyE{CkCkCgCsGmHgEqF{A{BsBiDiGkLgDqFgCqDgDaEeKaLgAsAmHeK{~@urAeEwG}F_KuFmKuAsCeGeNcCeGi`@}gAsEyLeEsK}BuG}BmFcAkB{@qAmPeRsGwGoGeGmsAulAy_@s]cYcWyOaN{I}GuJiHkD_Cgl@ib@kIsFaP{IwHwF{A}@wAq@kAc@iAWo@GkHY_Ge@{AS}KyBwj@qLgCm@eDcAuKoEqB}@cHwDyLuHcR_Lc^iSmPqHoSuHoMqDkPiDmOyBkDYoMuAsCOoEOkKi@iCC{XHsc@_@qh@sA{Ou@}Em@mB[cDu@uGkBoDqAqB{@mGcD}DiCqB_BmEaE}AiBcByBoFuHwAeCqAeCkAiCmBeFu@{BmBcHcBqHeCgMy@yFUsBe@iGSyE[iIMgFIqGcAc}AE_IMeIMwDk@kKYaE}AcPkBaQ{@oGcCsNwAkHuB_J}C}KaEqPw@yCa@iAaAwBg@cAaDwEgAiBsAkBsGkKiUi[y_A{oAcRmWiLmOwFaHoIsLa[cb@iL_OyNqPkKaLyEwE}JkKsL_KcLmImN{Lwg@wb@qHyGaF_FsGuHqBoCoHwKsDyF}CkFmDaHmDiHkG{NsCoHmCsHaCmHgGaTmB}Hwr@ucD_Hc[sBoIiBeHwHsVwZe~@qFaQsCmKaGgWeM}j@qFyWiDyOgHc\eJ_a@aPot@_D_NmGuTsJu]eAkEgDqOyAoGkBoJ{AcJ{Gmf@m@}EqFyi@_B}RoBiXo@eG{BsRiAyIeA}GsGc\cAoEkAoEiBgGwCaJwCmI}ByF}CcHeFmKqDmGgBqCga@ml@qSuZwSkZiA_AcR{XaE}GyCwFsCyFeCqFcC}FiGaPeCeHqBiGuEuOgAeE}DkPaE{RcAqF}@qFyDuW_AeIeCaW{B{Ww@wK{@eN_Dae@eRglCuDkg@uC}\cAeK}@iIgHum@gB_Ns@qEcCcNgHa_@{D}PsAmFgBoGsBeHyEmO}CaJkDmJqDeJkDcI{J_TwDqHeIqOmEwHoWo_@oCeEaDeEeBqBotA_sAci@eh@ucBebBqk@ik@cBmBwBoCqImMgCuEuBmEgBgEwAyDcEeMeFcPeBaGaBuGuJs`@wm@edCsMii@cAaFi@yCa@qCwAqLY{CW}DQwDKqDGmDGuH?qPPay@FkiBAed@IqgAAkFMaMmF{_FM}JW}J]qM_@{JeHiyAyPgiDw@kMc@yFu@kIa@}DgBsNaQmrAmOqjAoAsJaAyIW{CeBcX[_H[{HMmEc@qRaBew@m@uRWkGc@aIe@{GaAsKyYatCgAmJiAoIqCmQkAaH_BqIiA{FuAoGsCqLmDeNaBwFsBoGkCuH}GuQqHyQyx@yiByc@wbAiFwLsB_FsDaKeDoJiBcG}BeIwAmF{DgPcFwUwRy~@aUueA_Put@mBwHqAwEqBcHkBsFoAkDaDcI_CqFeCmFgC_FkCwEqb@it@uaBctC}B_EgDiGsEaJqD_ImDkI_HeRoCqIyBsH}A_GqCgLmFqVeBoJiXe}AgAeG{@gEkCkLoAaFsA}EiDoK{AeEkA_Da]ox@oG{Oi_A_zBcQ}a@wJgUuFoLgGwL}EmIuHcMaIoLuHiJwDaEaHaHyCmCyFmE_IwFcF_DgHcEaK}EqD{AwDuAap@wT_K_DyT}FqE{@oC]_DUkDQmBCyDJ_E\yGfAkF`BmE~AkEpBwDzBsDlCqPlNuDlCsHpEsFzBoBh@}cAjQqb@vHoe@bIaLtBgJpAiCXqH`@yFLwG@gHWgFe@qCe@sKwB_NyD{EmBkCsAeKeGmE_D_CiBeJuHksAojAuH{GuHoHqoA}qAkVwVyE_E}GgGyBgBwJmGmIiE}XiMwQqHy{@{^qOmFoEmAkJkByCa@qHu@wF[gt@aAmGa@qH_A}DgAqPmF_GeC_GkC}E_D{E}DeFgF{EwF{AwBoTe[k`@sl@mFuH{RwYoD{F_EaHkC_FmCsFoFsLqCaH_CcHuBgHwB}HiVodAsNgn@}Loh@}a@mfB{_@kbByCyNqC{OeA{GqCeSoBwOkDoZwG_n@wBwTqL_xAkEgg@}@wI_@iDoAmJeAoGu@sDaBgHyAwFkFgRsBgG_C_GmAmCsCcFuBeD}E{GgFiGcE_EyBoBiCmBuBiA_g@}Q"
                             data-route-points="[{&quot;lat&quot;: 57.095022993793975, &quot;lng&quot;: 65.66951751010494, &quot;address&quot;: &quot;База МО36, Ялуторовский тракт 11-й км., с5/9, Тюмень&quot;, &quot;date&quot;: &quot;09.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 58.15106659053312, &quot;lng&quot;: 68.36482524726308, &quot;address&quot;: &quot;Прииртышский, Р-404 Тюмень — Тобольск — Ханты-Мансийск&quot;, &quot;date&quot;: &quot;15.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122189">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122189" checked onchange="toggleParkings('122189')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122189" value="0" min="0" onchange="updateMapFilters('122189')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122189" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122189" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122189" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122189" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122189')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122189')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122189_0_v0" onclick="selectVehicleV2('122189', '122189_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">С725РН72</div>
                                <div class="vehicle-selector-name">С/тягач Volvo FM Truck 6х4 12.8 · ПЛ 1259067525</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122189">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">С725РН72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4 12.8</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">489.8 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">8.9 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">15.7 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">6.8 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">238.0 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">24</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122189_0_v0"
                                    onclick="loadShifts('122189_0_v0', '1259067525_03.02.2026', 2148, '03.02.2026 08:00:00', '04.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122189_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122189">
                        <div data-vehicle-uid="122189_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">С725РН72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4 12.8</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">489.8 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">8.9 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">15.7 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">6.8 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">238.0 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">24</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122189_0_v0"
                                    onclick="loadShifts('122189_0_v0', '1259067525_03.02.2026', 2148, '03.02.2026 08:00:00', '04.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122189_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="121973 1259067522 О445НХ72 С/тягач Volvo FM Truck 6х4 12.8 1259067521 С716РН72 С/тягач Volvo FM Truck 6х4 12.8" data-date="05.02.2026" data-number="121973" data-start-addr="Ялуторовский тракт 11-й км., 9 с41, Тюмень" data-end-addr="Красная Горка, Омский район, Омская область" data-cost-obj="Строительство автомобильной дороги «Северный обход г. Омска»">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('121973', this.querySelector('.copy-btn'));">
                                Заявка №121973
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">Ялуторовский тракт 11-й км., 9 с41, Тюмень</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Красная Горка, Омский район, Омская область</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '121973', 'Ялуторовский тракт 11-й км., 9 с41, Тюмень', 'Красная Горка, Омский район, Омская область', '05.02.2026', 2)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">05.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">05.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">594.4 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">8ч 2м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 1</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">2</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">груз сборный</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">14.4 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Строительство автомобильной дороги «Северный обход г. Омска»</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-121973">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-121973">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-121973" value="1" min="1" onchange="updateCalcPlan('121973')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-121973" value="1" min="1" onchange="updateCalcPlan('121973')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-121973" value="594" min="1" onchange="updateCalcPlan('121973')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-121973" value="65" min="10" max="120" onchange="updateCalcPlan('121973')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-121973" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('121973')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-121973" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('121973')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-121973" value="05.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('121973')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-121973" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('121973')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-121973">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-121973">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-121973">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-121973">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-121973">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-121973">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (2)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067522</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 06.02 20:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">О445НХ72</span>
                            </div>
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067521</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 06.02 20:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#ed64a6"></span><span class="subheader-pl-vehicle" style="color:#ed64a6">С716РН72</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-121973"></div>

                    <div id="map-121973" class="map-container active">
                        <div class="map-data"
                             data-polyline="een{IytxoK}AYPkEf@yEZcE]_@c@WQAISSYiFsFuCqDo@m@dY{cAx@oCxAoEbC}GrCuGtDeHhR}ZrLiQrLiRxLmQZm@tA}Cbm@s_AnByCvBwCtFoGlAmA~AsAfFuDjMcHrXyNjQaJrA_@zr@o_@nJaFh@[bA_Bt@e@xDeBdAA|HaE`PuIfG_Djp@s[`R{IlC}AhG_EbE_DrFiFzB}BtFiGbRkT|LyMnKuKnA{AjH}JxEiGzEaG`LuMxIyKzB{CtJ}NzFyJdXyf@rPg[nJgQrCcFjBwClGwIdCwCdDmDrD}C~AoAfCaBdBcAnEuBpBu@lBg@fFiA~Ei@nEIrBDfKl@`ZrAhKnA`Fv@lDP|CBlDEvF@bBIdBUlFiAbDaAnB_AfBgAlAgBlBsA|CiCnAkAnD}DhCuDtCeF|@eBrYmn@`MwWdc@{_AtCoFhHgPnDmHfKuTdBeD`B{CtBiDxAuBlA{AfAmAvAsApBeBtB}ArCaB~FcCrBi@rBa@vBUtBKdCCpBBjBJxBTxAVhAXhBhBjDpArFdC`DZnAh@rBzBjEdBhFfBzBl@nB\zBx@|Ax@zHhF|@ZzAJdAClC[tA]t@e@bAgAjByCdFeLtBoEbAaBrCuD|BoDjC{ElBaEnFsMt_Aw~BdMoZbBkDrDgG`HqIxC}CnCyBtA}@pEeCjAg@|Ai@fEcAxJeB|EcAdd@qHfLaClJ_DtC}ApBoA|B}AjCuBpBeBhBiBp`@sb@hJwJ`]o_@p`EimEzqCe{CrUiWnW{[|i@er@lYy^zsB_jC|SuWliBu}B|{@ugAvC{DdDyElxA{eCpdBqxCbIaN|BiE|B{ElFgMlNi^hMa[d}CmxH`CeHrOwi@fg@mgBlgA{yDj[mgAjIcYrHcUpQuf@xF}NxJkWdl@e}AtEeMdBaF~AkF|CwKhCiJxCsL|Quy@fJea@l@wArMak@rNao@tDyNfCkKjNan@zPkx@pTs`AfF_TrCmKhGeSvD}KlRyd@rzBeyE|S}b@~FsK|IkNhJ_NflCgsDxCcEFY`jAy~AdLkQdG_KzGiNpEaLpFsP~BgItCwLtCiNlBiMjAsIlB_QpAsQdBk[Z}HR_KLsN?_KYoRQeFYiHg@eJkAmNsAaMe@wDwLsy@cB}PcB{]e@e_@|@mj@dFubBfCst@j@eShGwoBn@oRvVo|HjGenBz@kQrAkPtCiZnBcPbAgHdB_LfFsZbLsr@bDkRn@kDtDyU`Mot@xBqNtBoO|AaNtBgUlCgc@bBil@fCscArLm~EdGshC|MclFfWysJfAic@^sL`Bsm@XkS|D{eMtG{kRhAmvCGsNi@}YSuHYwH}@oPcBiZuJ_|Aui@}{IcYouEyAqVqAeVkBo`@iA_\{@sYi@yRg@mVM_IQePWc`@G}RCmc@Fkf@JgxGHmiAb@}lJHso@?{TI}Oy@efCaAmaBaAsiC_CiyF`@aa@XqJr@{PbA{T~Bm`@dAgObD}i@rJw}ApHsoAnGaeA`HqjA~TmsD|@uMbCuc@j@}Lf@iQR{JHiJFqI@mG{@_hDiAglF{@ojCIqIe@sTm@{R{@eQaAkPqAiQmJ}_AuJc|@yRqjBmFui@cCm_@u@{Mc@oKw@}WkA_h@_CunA}@_o@Mcb@?q`@jAw}CHmo@AmTC_LaC{~CUa]U}i@?eg@t@wtCJs`Av@k_A~ByhAbS{nK~A{V`Eub@nFyYlEmPbHcSjJaRrSq]fVmc@bKwTzJoXfLea@tFiUhDwPhCkOrDwVbBgNlCwWbAaMvAsTx@gPdA{Yj@uYFwYFshANa[rFaiIr@ih@nAki@xI{bCxIw~BbR_jE|Cad@|AcSjF{e@x]_rC|LkcAnKyu@bDcT`QkfAxo@m~D~Icp@hTicBtYa~Bh@iD^aAjAcBLm@Da@Au@KsBAs@F_BLaB`D_WpJcw@lC{VpBiXd@qI^oJt@yWReML}KCo\IaKQ{Js@}Tm@eNiAwXi@wUMePBsY\gXdAy]xUu|GlE{mAl@aOj@oK|@mLfAmMjAkLnAuJvC{RrEmW|@qEdBeI`D_MjEaOjEcM`FsMpC{GzB{EzO_[pAwC`CaGtD{KvCgJlFaSlEeSdEoTvCySzB{VlBeY~MemDfJc~BhOwzDzJueClGgbBn@}Nr@qNp@wKjBoWlAmMnBcRtByQrHef@lA}F`E{QlHeZdEsOle@urAtPud@r`@cgA`HeRji@izAva@giA|FsPlDqK~Ncf@~HsYbcA}}D|Uu{@|Ze`Alq@isBjFiPj\obAjWsw@l\s_AtDuKzD_KfAgClDkHv@uAbEmGdYa`@lfAcxAxXw_@jAyA|CeDbC_ChB}AtByAvPkJ~QwLji@m\lAgAdFgFbBuBjAcBvA{BvB}DzAkDxBiGrCuI|@{CrA}FtAqHbBwLnA_KbLc`AdByLdB{KhBgKjC{LjDgNnOcj@|AoFtBaI`D_N~@aFjGi^xs@khEzh@}}CbC_PfAyIv@qHp@oH\{El@mJb@qHjJ}fBfEkw@rPoaDhAqUzBm`@xBma@fBm^jB_\|@{Kr@wHr@wGj@sEx@{FdAuGjEaWjJyh@~Nmy@pP{_AvS_kAhFgZvFk[tDgSdE}RvCeMvFuSlaAo`D`Xo{@hCwJjCuKz@cE`ByIbC_Oz@eGtAmLpa@woEfB}QhAaKbAaIlCkRpC_Qr[ufBvBgLlEkVx@aEdLko@bDaSp@sEdBiM`BqNzE}e@lFan@vDqa@~AcNvAaK~@sFlBwJ~D{QxRc{@hLgh@rGmXjf@uuBbDyOv@gEt@{EZkC~@{JbAuMRyFLiFDsI?_DEaDIgFO}Dc@sIaIgiAsLkeB}B_`@SyEqAk^gDgaAoEolAcF{vA]iIcAyQ[yEe@mF_AsI{ByQwAcKuDeVq@iEWsBQ_B_@cFSmDIuCAsCAkQJqoAFwIp@a^HyEDmF~@yeB@{QKwIk@iSQkEs@cNqB}ZaAoQ}A_UyI}uAe@cHUiCe@gEcO}~@_@qCWaCYmDcAeOe@uHeAqNwGwn@eEca@UmCwAaMg@kGGyBGaEEoIQsjAQio@FeIl@gTBuGAmB_@kY}A_gAImDKiC_@cFcM_qAcQazAgJcy@_E}[yAkMkGwl@gAsMmAwQgKatA_\kmEyBa[m@qHye@}|E_AeKq@qImBcWmCea@mE}p@ImB@oFn@qXFuDBiJWsg@a@ea@@gDl@k]`@ab@?aCKuF_GkgAi@kIaB}Tm@oG{D_]kA}I_Fe]{AwLaKa{@q@gEiQaw@eBeIiAeG[sB]kDMiBMgDIsE]cm@?gGDeERkH|@iWxBun@nDsiAb@uKF_C?sBIgD[aKgEqdAIgCEiCBiC\gRBwCAoCEeD_@_Pc@}LeAmSmDwo@I{BAwJBaBNiBTiB`@cBbD}Kv@yClBsItB}JbCgMlEcTr@sD^_Cz@_JnAiOdAeOx@}MTqEZwIBoC@yCAuCKyLM_FUyHSqDc@kFe@cFmAeKq@mEkAmGyBuIyDsOq@{CgAkEmAwF_A}Ew@aFcAuIm@sFaBeQ_Fgf@gBqOeBaMUqBcCmOkAcG{CoL{A_FeDcJiF{L{EkKiFyL}BwF}@oCsCeKgA{EiAkFeBsJo@aEe@qD}BqTgAyImJup@{@kFwCsNuDeN_BeFoC{HoB}EiB}DoT{`@cEoIuAkDaBoE_CuH}AwFgAqEqBgJu@cEk@oDqA{Jc@gE}Cw[{AgQcBcQaHgq@yCiWm@kGaBqTyLsdCkAyQeC}\eJenA{IerAwJutAg@}GaAkKqa@c{CcBeLeJud@{SocAoR}w@yl@ocC_Va{@u@uCgA}Ec@cCgAsHq@qFe@kGIyAKwCGgFEcf@@uFHmFFkBj@oMb@_IvAwSjE}i@~Cob@ZyEt@aNTcGVcJ~@wf@b@eQ`@qKf@kJVwDf@yG`AaLX}DR}Db@yO`GwtCPgEb@cGt@eGXcB`BcIjCuKdT_{@x`@w`BbP}p@zUaaApGmUnDuL|BoGpAoC`AkBxAkC~CeFrDuF`FkH`FwGpCmD~BoDb@w@\aA~@sCfAeE`CuL^aCV{Bl@eIJeCDyDCeHi@cq@eBklBc@mf@UuTKa[IckA_@smDEmGEkBi@_M[{E_AkKa@}Ds@wEs@uDaAoEqCmKaBkFiCwGaA}ByAsCaAaBsC{DqEqGsAuBsAmC{AwDw@yB{AaGcAqEaC{LcBsJSmBSiCOmCUsHAwBHkNF{CJkCdGogAb@mMf@}[DuEA{JE{GKcGQqG{VacHeC}n@qGqfBaAc_@_@cQS{KKoJ_AeeCYmo@QkRO_Hk@mTq@}Oa@_I}Coe@yBo[qAoPo@qNSsFc@}REkD?qMF}GJwIhBcz@rCk`Bh@mRlCubBZaLpFstCtAc{@`@oOVaHjBq_@p@yJdAcNf@cG`AoJjSamBhB}MvAiJ~CoRdA{F`@}AhCaIrIsVlC_HdDsHtFwLtZii@dDoG`DkH`GeOnC{HpB{GxAwFzBkJzA{Gv@gE|@qFxBkOdCaT`@mE~GchAdBq[v@mQl@wPnA_c@~F_kBpB{l@NqDn@yMf@}IrQghC|Kg_BzDch@|A_PtCgWpCqSfAqHfA{G|CcQ|AiItB}Jhx@y_DtAuEfBsF`C_HhCqGnCqGxCgGbCuEhGeKhCyDdMqOlAsAnCkCtBaB~FaEjWgQxtBevA`I}F~OkMlD{CnDiDbDgDfFcGxD}E`EoFlCcEfHoL~NcWzIyObdA}lBx\ym@zp@anAxZmj@~E}HhKsMtKoKrJ{G~JyFlMmEjNiDjYkA|WkB`OwDjIcEzJ}FjIoH`K{LdIgMnEoI~CgHdBkEvEwMjK}Zx_@mhA~Ko\xKo`@bDqIdBgD|AkCzBsCzB{BfKgJpWsTfRkOn[uWd~@yt@pf@m`@rFyEfCaCbFiFjCyCfFiGxEkGnEkG|EmHnCoEvCcFh^kq@pKyRlEkIzA}CrBsEnB{ErF_Orr@ylB|Ne]xMmXx\cq@~Xak@z[yn@jb@m{@|Vqf@|\yr@|DcJxCgIrD{LhCcJdEwPzBuKlAkHlAoIdBoN~BsXtAwTPqGZyR@uXW}VBmBHiAJONa@Dk@Co@Qk@a@oBQsBE_DaAo^s@m[S{M?yBLiHLsCNoC^qEj@oFbJ_m@x]m`Ch`@}hCxDiZtGsi@vCoYbBwP~AwR|Bi\nAsUpAcWxAa_@zC{dAd@gSn@iSr@cSdA}ShCe^r@aIvJe`AjBcQbBmOfVw_CfCqWrEeg@`BeTpBiYfFsv@xCaj@lAmVjA{W`B{a@f@gOfA_^hAuc@fHa~CjQyrHjEqsA|Cgu@rDcx@rBaZ`I_dAzAsQjCiZrFal@nEad@|CwYdYsdCjO}pA|h@gpErB_SpBkVbAiO`AePxToaE~ZguF~JuiBp@uKvDah@dAaM~AmP`BuOdOcuAlEs^`CmSvCiZtAkPxAsRnAwPfAwPdC_c@RgE~@kV^cL|@a]h@kYhFsrDRuKTgJ\}Jv@}PlAeTpAqTrA_RpGow@jAiOxFyq@|@a@jCcAt@S\A|Rt@lPZzPj@`FJtB?~@Q\Ub@i@t@mAbIqLpFyI`CaDj@e@LEl@AxS`BhNzAnPlARoQBeDJuGHuBr@_Zn@qY@oAjJ?tCSxC]jH_BzAa@tDsAvDgB~I}ExCqBzE}DpCeChCwCtUaYzJuKhGgGxGgGpD_DztBoaBf[yVhIuFbNuH~OkGnHyBfH{AhLqAzO[pQ|@pQzB`M`DjaAf\po@tTbHlBhEl@rEd@xJ?lHk@zFeAhF_B~aA_b@|H}C`EgB~t@uZdZoJxa@iMnMiFzFiDjE{ClByArBgBzEuE`DiDnCkDvM}QbUe]pq@gcA|r@kdAnLiPb{@wnAtfAi|AdFqHrDgGtCiFtDqH~CgHbB_ElDeJdA{CnCwI`AeDjBeHdByHv@wDr@eEjCqRrB{P|@eJp@_Jj@qIdVydEj@uLNwDv@mV`@gQhJocF^eNl@yN~@cPhJswA~AuRhA_LZ}BrBaMhDmR~BsJnAoEfAoDpBuFpAgDdBwDrSaa@r{AayClFaL~AsDzBaGvCeJzByGbB}FpEwRpAmGv@gEr@mE|OehAtDmXng@goDz`AaxGbDmRfCeMjEyP`F}Ony@aaCvMg_@|EoNpKo\xCyIjYqt@`C{G`CiHjFoQzk@euBxCeKpCeKzJ}]dNug@bN{e@`G_TfIoZno@_~BhBwFxEgMjDwIjEeJ|EkIfF}HvHqK~i@mr@vv@ccAzD_FtMuO|A}BfSs\vSa_@ta@qj@j[ee@`BqBnA}@`Bm@hDo@~cAcNn}@}Lnw@{Kpw@kKt|@cQja@_MzKcE|PkH|PuHnb@sQheA{`@pGgBlHeAhl@mF`cAsKde@sE~ViBxiEgLl~@oCfeAsCxCWpASfCo@xrCgcAlF_BhEq@xAGtDAtJx@b_BhXlGb@fKNfCGvGa@fCWlFaApDw@bFuAnO_Gx`@_PlU_KtQuHvd@cSrf@aS`HiC|Z}LvJuDvJmCpmAsX|I{BdHeCjB{@~EmCzEuDrEcEdDmD|CwDrCkEpCwE~BgE|B{E|AoDpAcDtAsDpAcEnAaEdA}DnFuSzEqRpIq[pMcg@Zm@RUl@[XGJGLMVi@Ju@@[E{@Ic@BqAPwAnH{Y~Kmb@zEcRrEuQtDuOpA_HfImg@r@gD`AwDl@wB~@kCpAaDpAkClGmKni@s|@vQoZzDcFnAoAdBsAfCuA~o@wYtLyFrEiClC}BfVeY~IuKxMcNfGoFna@yY|CcC`BaB|B{CjB{CvAqCh^k{@byAoaDnd@yaAvAiCjAaBzA{AnCwBdhE{vBrBcAj|@ea@nC{@nA[nC_@hCGbDLdBVjGdBnEbAdCVtC@tCSrDeAnB}@rDaCrGoFjAgApAyAfA{AxDeH~EeKxAkC~@iAPk@DWCUEKMEg@BwX|JcANO?]ESOg@w@oFmX{BiKqBaKwGa`@_A}GQeBGqAWgJeAgs@_@m^EsAI_ASeAa@wAUmAWuCA_DD}CA_BCqA_AeMEiA?_AJkCP_CPcBjEo\j@cFTiC?o@Kc@OSQGo@EmQJ{e@FgRH_PAKq]@cTJgT?}KQyGEg@O]UUUIwAWMM_@}AoBkFkGiOuCyFiBcEeBeFf@CbASzCmBb@OfG}@jHqAf@@p@kA`GwEu@q@"
                             data-route-points="[{&quot;lat&quot;: 57.09414, &quot;lng&quot;: 65.66722425212905, &quot;address&quot;: &quot;Ялуторовский тракт 11-й км., 9 с41, Тюмень&quot;, &quot;date&quot;: &quot;05.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 55.11383485, &quot;lng&quot;: 73.12837812620077, &quot;address&quot;: &quot;Красная Горка, Омский район, Омская область&quot;, &quot;date&quot;: &quot;05.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-121973">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-121973" checked onchange="toggleParkings('121973')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-121973" value="0" min="0" onchange="updateMapFilters('121973')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-121973" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-121973" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-121973" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-121973" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('121973')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('121973')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="121973_0_v0" onclick="selectVehicleV2('121973', '121973_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">О445НХ72</div>
                                <div class="vehicle-selector-name">С/тягач Volvo FM Truck 6х4 12.8 · ПЛ 1259067522</div>
                            </div>
                        </div>
                        <div class="vehicle-selector-item" data-vehicle-uid="121973_1_v0" onclick="selectVehicleV2('121973', '121973_1_v0', 1)">
                            <span class="vehicle-selector-color" style="background:#ed64a6"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">С716РН72</div>
                                <div class="vehicle-selector-name">С/тягач Volvo FM Truck 6х4 12.8 · ПЛ 1259067521</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-121973">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">О445НХ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4 12.8</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">891.8 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">14.9 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">24.9 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">10.1 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">412.7 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">35</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121973_0_v0"
                                    onclick="loadShifts('121973_0_v0', '1259067522_03.02.2026', 106, '03.02.2026 08:00:00', '06.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121973_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-121973">
                        <div data-vehicle-uid="121973_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">О445НХ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4 12.8</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">891.8 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">14.9 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">24.9 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">10.1 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">412.7 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">35</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121973_0_v0"
                                    onclick="loadShifts('121973_0_v0', '1259067522_03.02.2026', 106, '03.02.2026 08:00:00', '06.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121973_0_v0"></div>
                        </div>
                        </div>
                        <div data-vehicle-uid="121973_1_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">С716РН72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4 12.8</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">1345.9 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">20.1 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">26.4 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">6.2 ч</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">29</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121973_1_v0"
                                    onclick="loadShifts('121973_1_v0', '1259067521_03.02.2026', 2146, '03.02.2026 08:00:00', '06.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121973_1_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122302 823 С639ТВ86 С/тягач Scania P420-CA 6х6 EHZ" data-date="03.02.2026" data-number="122302" data-start-addr="Скания, Р351 300 километр, 2 ​Екатеринбург-Тюмень 301 км, 1 с1, Ушакова, Тюменский район, Тюменская область" data-end-addr="Ялуторовский тракт 11-й км., Тюмень" data-cost-obj="Услуги автотранспорта (с экипажем) (внутригрупповые)">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122302', this.querySelector('.copy-btn'));">
                                Заявка №122302
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">Скания, Р351 300 километр, 2 ​Екатеринбург-Тюмень 301 км, 1 с1, Ушакова, Тюменский район, Тюменская область</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Ялуторовский тракт 11-й км., Тюмень</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122302', 'Скания, Р351 300 километр, 2 ​Екатеринбург-Тюмень 301 км, 1 с1, Ушакова, Тюменский район, Тюменская область', 'Ялуторовский тракт 11-й км., Тюмень', '03.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">38.3 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 33м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 1</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">Порожний</span>
                            </div>
                            
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Услуги автотранспорта (с экипажем) (внутригрупповые)</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122302">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122302">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122302" value="1" min="1" onchange="updateCalcPlan('122302')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122302" value="1" min="1" onchange="updateCalcPlan('122302')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122302" value="38" min="1" onchange="updateCalcPlan('122302')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122302" value="65" min="10" max="120" onchange="updateCalcPlan('122302')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122302" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122302')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122302" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122302')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122302" value="03.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122302')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122302" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122302')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122302">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122302">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122302">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122302">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122302">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122302">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№823</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 03.02 23:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">С639ТВ86</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122302"></div>

                    <div id="map-122302" class="map-container active">
                        <div class="map-data"
                             data-polyline="{on{Is~ulKnCIEqD~@eA?iBBe@pA`@NTDNB`@LpLPbEvBvnB`@vd@FXFDJEHYOsMQoHeBa{A}EynEEmIE{EQeJMaJiDu}CI{OQyNS{K}Kc}JUaN[oGQyCs@sJyNm{BiA}Re@sHaAmOo@_Ii@qIy[ecFs\ajFwFw}@WcD{@qJuA_NwJ{{@}MgoAqDi\w@}Gw@iGoA{HmOq}@}@qFoRwsAeAsGuAeHaC{KqDaOwKob@yCyLuAiGaNip@wG}[]aCqF}b@cAwJs@cIw@oMYcFCkA@_@No@Bg@?YIc@Yo@Mq@MyBQeJ@eAPyAbBoNtEw^?o@AOKYWW]CsEjAy@L_ADeAEoASoBo@}@c@o@o@Ya@O[Qo@QqAIcAAuADsEL{CHsDBkEC}AQiC_@iCOo@k@cBmK_VkDoHk@wAg@{AaA{DoCqMwJ}c@?[Ha@jU_j@|c@}dAxa@aaAp@eBh\iv@^kAP_AdAoEr@gD|WsuAhH}^h@aBlAkG`A{CpD{I~BeGfAeCrAmDNaAnIe]vN_k@j@aDjBeQbB{Pd@eDr@yDb@wBbQ}g@jCeHjFcOpEuMpDyKpQeh@nF_PzBgHxPum@~@kCbAmDn@l@tCpDhFrFRXHR@b@?n@e@hH"
                             data-route-points="[{&quot;lat&quot;: 57.09582845, &quot;lng&quot;: 65.16259605127125, &quot;address&quot;: &quot;Скания, Р351 300 километр, 2 ​Екатеринбург-Тюмень 301 км, 1 с1, Ушакова, Тюменский район, Тюменская область&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 57.094759700000004, &quot;lng&quot;: 65.6690926, &quot;address&quot;: &quot;Ялуторовский тракт 11-й км., Тюмень&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;14:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122302">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122302" checked onchange="toggleParkings('122302')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122302" value="0" min="0" onchange="updateMapFilters('122302')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122302" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122302" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122302" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122302" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122302')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122302')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122302_0_v0" onclick="selectVehicleV2('122302', '122302_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">С639ТВ86</div>
                                <div class="vehicle-selector-name">С/тягач Scania P420-CA 6х6 EHZ · ПЛ 823</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122302">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">С639ТВ86</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Scania P420-CA 6х6 EHZ</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">280.4 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">3.8 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">10.2 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">6.4 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">41.4 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">6</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122302_0_v0"
                                    onclick="loadShifts('122302_0_v0', '823_03.02.2026', 728, '03.02.2026 08:00:00', '03.02.2026 23:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122302_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122302">
                        <div data-vehicle-uid="122302_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">С639ТВ86</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Scania P420-CA 6х6 EHZ</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">280.4 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">3.8 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">10.2 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">6.4 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">41.4 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">6</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122302_0_v0"
                                    onclick="loadShifts('122302_0_v0', '823_03.02.2026', 728, '03.02.2026 08:00:00', '03.02.2026 23:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122302_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122303 823 С639ТВ86 С/тягач Scania P420-CA 6х6 EHZ" data-date="03.02.2026" data-number="122303" data-start-addr="Ялуторовский тракт 11-й км., Тюмень" data-end-addr="Сумкино, Р-404 Тюмень — Тобольск — Ханты-Мансийск" data-cost-obj="Услуги автотранспорта (с экипажем) (внутригрупповые)">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122303', this.querySelector('.copy-btn'));">
                                Заявка №122303
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">Ялуторовский тракт 11-й км., Тюмень</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Сумкино, Р-404 Тюмень — Тобольск — Ханты-Мансийск</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122303', 'Ялуторовский тракт 11-й км., Тюмень', 'Сумкино, Р-404 Тюмень — Тобольск — Ханты-Мансийск', '03.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">231.0 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">2ч 57м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 1</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">арматурные каркасы</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">60.0 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Услуги автотранспорта (с экипажем) (внутригрупповые)</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122303">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122303">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122303" value="1" min="1" onchange="updateCalcPlan('122303')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122303" value="1" min="1" onchange="updateCalcPlan('122303')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122303" value="231" min="1" onchange="updateCalcPlan('122303')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122303" value="65" min="10" max="120" onchange="updateCalcPlan('122303')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122303" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122303')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122303" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122303')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122303" value="03.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122303')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122303" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122303')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122303">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122303">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122303">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122303">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122303">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122303">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№823</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 03.02 23:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">С639ТВ86</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122303"></div>

                    <div id="map-122303" class="map-container active">
                        <div class="map-data"
                             data-polyline="ein{Iy~xoKd@iH?o@Ac@ISSYiFsFuCqDo@m@vTcx@`AmCn@wB\u@`@a@XKJ?ZFXVLPPf@PnAVvF?j@E~@Kr@Ul@e@b@WHe@?y@KaCIyFe@aEMuELqBLaC\cGhAsl@dPaC^{BTkFH}DQ{AOeDm@cCq@sBs@kDaBmCcBmDmCiBiB}BeCmA{A{AwBmBwCsByDe^yt@gWkh@aAcBgBuCcByBw@}@aAaAyBoB_BeAcBaAgCeAcCs@iCc@mAMuBEcB@qAHmBTcB^_Bf@_Bn@uBfA_DzBgBbBiD~DyFxIgBdC{BvCqC~CyB|BiC~BoB`ByAdAgFbDoBdAkClAqUrIgj@`SuG|BeEnAs@Lsg@~FiFb@cBEgAe@[W]a@_@u@Oa@iE{PSkBC_CVaKh@ePbEgfAvGudBrA_\tCwv@tQiuE\aGt@_Kt@yPN{EL_KJmF~HgqBdFmpA`Bub@HmG?_FsAuxAa@__@i@qYcAab@q@eV[uIa@cIk@qIeA{LaAuIw@gGeB}KeBqJ_M_n@uYsyAoB_JuAeGiRou@}CaMm@kCuA_HwA{Ho@yDeBiLu@_Gek@caFk@iGkAoOmAqKoDkV}BcSyA}NcNqmAcIsq@mDcWw@oGs@iHc@kF]{FKmBYcJGgECcK@_EB_HVwUFgBJ{BPmCt@_Jv@iIv@kG|E}[|Ggh@nA}H\aBl@mClAuEr@sBdEyK|@oCbA_ElD{Q`A_Ej@mBzAkE|Mm^j@gBxBiInAcFfCeLpa@kpB|P}x@dB}GfEeOh@{Bb@{Bj@eEv@cIj@aFfAcIhImf@bBkL|@aHfA{J|@_KtD}c@`AuOTkGJ{GCaIIgHW_IgIycB}K}cCqBod@Q{FMsGGcN?_P@_KF{F\gNf@kLzBic@bT}yDvEk|@lE_w@j@qId@{Fn@{Fj@}DjDqR|@kF`AiGbCiRhAcHfDkR|@uFjA_J`Gsk@`Fmf@~@iIhAaIhBmK|@gErFuVzBqKzAsIfBaL|AeMnAeMh@{GfCi^rFyu@rC}a@zDam@hHydAZuFl@uML}CPcHJeGJiP@sQVoOB}G?eEGkEKqDIeC[gFg@uHa@qH[aJyAu]QiF[cNGmIAsE@yXNos@GoLIcGo@iVM}Cg@oJiGu~@iAyR_@mFYwCk@_E{Ck`@iJqnAs@_Kk@aKiQg~D[gIi@kPQsII_KDwk@KmMe@qXs@yTsBml@wNwpDmBcd@_@gHo@mJYiDuKegAmBqQ}@sHy@wFyA_JiAcGoAeG_AmE_AsDkAkEkDyL{A{EuCqIgAyC}B}FeCwFgQk^uB}D_FoI_JoN{BkE{@mBw@mBsCoIkE}NwBcJql@onCed@ssBmDoNoBoH_BoFiDuKc`@_iAkOgd@yf@axAw]mcAcOod@_^siA{BwGaKk\mBcGeEkNcCaHiD_Jw@yByDsL}Lib@sAeFyAiGcAmEwBeKw@gEoDgUqAmJwA}KmAoKcWedCsAsL}AgM}A_LmKir@wSqsAiO}aAa@_DwBeR}XqgCsBmPwB{NgA{GoAiHcC{LaCkK{CaMcCaJyCuJ{CiJad@grAkEwNsAyDkFcN{C}IguAgaEeGaR_GcRaHiU}Kc`@skA_fE{BwImAwFwBgKoBgI}AqFwAmE_BmEoBwEmCgGiIwS}BiFmB_EyDyHwCmF{CkF_EiG}EaH{GmIuCeD_~@{bAoAmAaDsC_E}C{AcAqGaEmFuCeCiAsFsB{GkBmIwAqRqByEs@kDq@kD_AuHmC{DgB{DsBmEsCmGyE{CkCkCgCsGmHgEqF{A{BsBiDiGkLgDqFgCqDgDaEeKaLgAsAmHeK{~@urAeEwG}F_KuFmKuAsCeGeNcCeGi`@}gAsEyLeEsK}BuG}BmFcAkB{@qAmPeRsGwGoGeGmsAulAy_@s]cYcWyOaN{I}GuJiHkD_Cgl@ib@kIsFaP{IwHwF{A}@wAq@kAc@iAWo@GkHY_Ge@{AS}KyBwj@qLgCm@eDcAuKoEqB}@cHwDyLuHcR_Lc^iSmPqHoSuHoMqDkPiDmOyBkDYoMuAsCOoEOkKi@iCC{XHsc@_@qh@sA{Ou@}Em@mB[cDu@uGkBoDqAqB{@mGcD}DiCqB_BmEaE}AiBcByBoFuHwAeCqAeCkAiCmBeFu@{BmBcHcBqHeCgMy@yFUsBe@iGSyE[iIMgFIqGcAc}AE_IMeIMwDk@kKYaE}AcPkBaQ{@oGcCsNwAkHuB_J}C}KaEqPw@yCa@iAaAwBg@cAaDwEgAiBsAkBsGkKiUi[y_A{oAcRmWiLmOwFaHoIsLa[cb@iL_OyNqPkKaLyEwE}JkKsL_KcLmImN{Lwg@wb@qHyGaF_FsGuHqBoCoHwKsDyF}CkFmDaHmDiHkG{NsCoHmCsHaCmHgGaTmB}Hwr@ucD_Hc[sBoIiBeHwHsVwZe~@qFaQsCmKaGgWeM}j@qFyWiDyOgHc\eJ_a@aPot@_D_NmGuTsJu]eAkEgDqOyAoGkBoJ{AcJ{Gmf@m@}EqFyi@_B}RoBiXo@eG{BsRiAyIeA}GsGc\cAoEkAoEiBgGwCaJwCmI}ByF}CcHeFmKqDmGgBqCga@ml@qSuZwSkZiA_AcR{XaE}GyCwFsCyFeCqFcC}FiGaPeCeHqBiGuEuOgAeE}DkPaE{RcAqF}@qFyDuW_AeIeCaW{B{Ww@wK{@eN_Dae@eRglCuDkg@uC}\cAeK}@iIgHum@gB_Ns@qEcCcNgHa_@{D}PsAmFgBoGsBeHyEmO}CaJkDmJqDeJkDcI{J_TwDqHeIqOmEwHoWo_@oCeEaDeEeBqBotA_sAci@eh@ucBebBqk@ik@cBmBwBoCqImMgCuEuBmEgBgEwAyDcEeMeFcPeBaGaBuGuJs`@wm@edCsMii@cAaFi@yCa@qCwAqLY{CW}DQwDKqDGmDGuH?qPPay@FkiBAed@IqgAAkFMaMmF{_FM}JW}J]qM_@{JeHiyAyPgiDw@kMc@yFu@kIa@}DgBsNaQmrAmOqjAoAsJaAyIW{CeBcX[_H[{HMmEc@qRaBew@m@uRWkGc@aIe@{GaAsKyYatCgAmJiAoIqCmQkAaH_BqIiA{FuAoGsCqLmDeNaBwFsBoGkCuH}GuQqHyQyx@yiByc@wbAiFwLsB_FsDaKeDoJiBcG}BeIwAmF{DgPcFwUwRy~@aUueA_Put@mBwHqAwEqBcHkBsFoAkDaDcI_CqFeCmFgC_FkCwEqb@it@seBczCgDiGsEaJqD_ImDkI_HeRoCqIyBsH}A_GqCgLmFqVeBoJqZkeB{@gEkCkLoAaFsA}EiDoKgDeJa]ox@oG{Oi_A_zBcQ}a@wJgUuFoLgGwL}EmIuHcMaIoLuHiJwDaEaHaHyCmCyFmE_IwFcF_DgHcEaK}EqD{AwDuAap@wT_K_DyT}FqE{@oC]_DUkDQmBCyDJ_E\yGfAkF`BmE~AkEpBwDzBsDlCqPlNuDlCsHpEsFzBoBh@}cAjQqb@vHoe@bIaLtBgJpAiCXqH`@yFLwG@gHWgFe@qCe@sKwB_NyD{EmBkCsAeKeGmE_D_CiBeJuHksAojAuH{GuHoHqoA}qAkVwVyE_E}GgGyBgBwJmGmIiE}XiMwQqHy{@{^qOmFoEmAkJkByCa@qHu@wF[gt@aAmGa@qH_A}DgAqPmF_GeC_GkC}E_D{E}DeFgF{EwF{AwBoTe[k`@sl@mFuH{RwYoD{F_EaHkC_FmCsFoFsLqCaH_CcHuBgHwB}HiVodAsNgn@}Loh@}a@mfB{_@kbByCyNqC{OeA{GqCeSoBwOkDoZwG_n@wBwTqL_xAkEgg@}@wI_@iDoAmJeAoGu@sDaBgHyAwFkFgRsBgGh@eA"
                             data-route-points="[{&quot;lat&quot;: 57.094759700000004, &quot;lng&quot;: 65.6690926, &quot;address&quot;: &quot;Ялуторовский тракт 11-й км., Тюмень&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;14:00&quot;}, {&quot;lat&quot;: 58.13519601546809, &quot;lng&quot;: 68.35693359375001, &quot;address&quot;: &quot;Сумкино, Р-404 Тюмень — Тобольск — Ханты-Мансийск&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;23:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122303">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122303" checked onchange="toggleParkings('122303')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122303" value="0" min="0" onchange="updateMapFilters('122303')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122303" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122303" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122303" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122303" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122303')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122303')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122303_0_v0" onclick="selectVehicleV2('122303', '122303_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">С639ТВ86</div>
                                <div class="vehicle-selector-name">С/тягач Scania P420-CA 6х6 EHZ · ПЛ 823</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122303">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">С639ТВ86</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Scania P420-CA 6х6 EHZ</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">280.4 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">3.8 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">10.2 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">6.4 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">41.4 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">6</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122303_0_v0"
                                    onclick="loadShifts('122303_0_v0', '823_03.02.2026', 728, '03.02.2026 08:00:00', '03.02.2026 23:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122303_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122303">
                        <div data-vehicle-uid="122303_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">С639ТВ86</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Scania P420-CA 6х6 EHZ</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">280.4 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">3.8 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">10.2 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">6.4 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">41.4 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">6</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122303_0_v0"
                                    onclick="loadShifts('122303_0_v0', '823_03.02.2026', 728, '03.02.2026 08:00:00', '03.02.2026 23:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122303_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122311 1259067566 О856МЕ72 С/тягач Volvo FM Truck 6х4 12.8" data-date="03.02.2026" data-number="122311" data-start-addr="Арматурный цех ВСЖМ, 46К-9253 Лотошино - Суворово - Клин (Клинский район)" data-end-addr="ВСЖМ, 6 этап, ПК5452, М-11 «Нева»" data-cost-obj="Создание высокоскоростной ж/д мгстр. Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап – Стр-во уч. Новая Тверь. Московская обл.">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122311', this.querySelector('.copy-btn'));">
                                Заявка №122311
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">Арматурный цех ВСЖМ, 46К-9253 Лотошино - Суворово - Клин (Клинский район)</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">ВСЖМ, 6 этап, ПК5452, М-11 «Нева»</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122311', 'Арматурный цех ВСЖМ, 46К-9253 Лотошино - Суворово - Клин (Клинский район)', 'ВСЖМ, 6 этап, ПК5452, М-11 «Нева»', '03.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">37.0 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 25м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 1</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">Арматурные каркасы</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">5.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">69.12 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Создание высокоскоростной ж/д мгстр. Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап – Стр-во уч. Новая Тверь. Московская обл.</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122311">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122311">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122311" value="1" min="1" onchange="updateCalcPlan('122311')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122311" value="1" min="1" onchange="updateCalcPlan('122311')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122311" value="37" min="1" onchange="updateCalcPlan('122311')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122311" value="65" min="10" max="120" onchange="updateCalcPlan('122311')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122311" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122311')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122311" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122311')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122311" value="03.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122311')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122311" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122311')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122311">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122311">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122311">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122311">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122311">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122311">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067566</span>
                                <span class="subheader-pl-dates">03.02 10:00 → 04.02 10:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">О856МЕ72</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122311"></div>

                    <div id="map-122311" class="map-container active">
                        <div class="map-data"
                             data-polyline="gqwvIwuk~Eh@k@p@g@\Sd@Mh@FfKtCpAPHmIBkGIcF[mIkG{qAsB_e@McBY{CmDqUcB_MyFm`@{@iHc@oFSqEOmH?qCJ_KPoFvDm{@bBgd@p@iPn@iQfEybAr@wMpBi]vDkk@Xm@VUXMb@Etn@xh@n@n@lDpCzCrBvDxAnFpAdGnAzHrBbDzAdIbEhGxBdCr@dKxBtA`AhAzBz@vD\`DJpCIdCUrBo@~CmBzKuA`JgAtGa@~A]|@UNu@T_@AmDkAgI{Bu@Y_@YO[Qe@Kw@@y@Bk@Lo@Tm@VWz@IZLj@~@Nt@Fr@?z@I`AkBdKsB`JkGjVaH~UyIxUaJdSiJbRgIdM{KdOyLzMmKjKgGzEwHjFq}CtrB}HzFgIrGsDzD}E|FeDhEqQdUmRpWqVh\}e@dp@uv@rbAqQxTcXhZuU~SgNnL_E|Cqf@j\mQdJwx@j`@uJ~EosAto@aRdIiPrGePjF{NlEkXxFoXvCsQ~AsNn@mOPccA_@sWNqLf@iCRcOjB}VzEcWxHqYnL{Q`Jg[pS}AjAiTtRsFlFiOjP{z@hgAwQxRcQvN"
                             data-route-points="[{&quot;lat&quot;: 56.32275780541066, &quot;lng&quot;: 36.60088348362479, &quot;address&quot;: &quot;Арматурный цех ВСЖМ, 46К-9253 Лотошино - Суворово - Клин (Клинский район)&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 56.5175951500802, &quot;lng&quot;: 36.50832367100521, &quot;address&quot;: &quot;ВСЖМ, 6 этап, ПК5452, М-11 «Нева»&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122311">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122311" checked onchange="toggleParkings('122311')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122311" value="0" min="0" onchange="updateMapFilters('122311')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122311" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122311" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122311" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122311" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122311')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122311')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122311_0_v0" onclick="selectVehicleV2('122311', '122311_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">О856МЕ72</div>
                                <div class="vehicle-selector-name">С/тягач Volvo FM Truck 6х4 12.8 · ПЛ 1259067566</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122311">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">О856МЕ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4 12.8</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="no-data">Нет данных мониторинга</div>

                            <button class="shift-load-btn" id="shift-btn-122311_0_v0"
                                    onclick="loadShifts('122311_0_v0', '1259067566_03.02.2026', 107, '03.02.2026 10:00:00', '04.02.2026 10:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122311_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122311">
                        <div data-vehicle-uid="122311_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">О856МЕ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4 12.8</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="no-data">Нет данных мониторинга</div>

                            <button class="shift-load-btn" id="shift-btn-122311_0_v0"
                                    onclick="loadShifts('122311_0_v0', '1259067566_03.02.2026', 107, '03.02.2026 10:00:00', '04.02.2026 10:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122311_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122324 1259047362 Р054МО186 С/Тягач MAN 6*6" data-date="03.02.2026" data-number="122324" data-start-addr="ВСЖМ, 6 этап, ПК5514, М-11 «Нева»" data-end-addr="ВСЖМ, 6 этап, ПК5600, М-11 «Нева»" data-cost-obj="Создание высокоскоростной ж/д мгстр. Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап – Стр-во уч. Новая Тверь. Московская обл.">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122324', this.querySelector('.copy-btn'));">
                                Заявка №122324
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">ВСЖМ, 6 этап, ПК5514, М-11 «Нева»</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">ВСЖМ, 6 этап, ПК5600, М-11 «Нева»</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122324', 'ВСЖМ, 6 этап, ПК5514, М-11 «Нева»', 'ВСЖМ, 6 этап, ПК5600, М-11 «Нева»', '03.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">15.3 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 29м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 1</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">перевозка частей СИНЕБОГЕНА</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">75.0 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Создание высокоскоростной ж/д мгстр. Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап – Стр-во уч. Новая Тверь. Московская обл.</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122324">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122324">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122324" value="1" min="1" onchange="updateCalcPlan('122324')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122324" value="1" min="1" onchange="updateCalcPlan('122324')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122324" value="15" min="1" onchange="updateCalcPlan('122324')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122324" value="65" min="10" max="120" onchange="updateCalcPlan('122324')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122324" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122324')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122324" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122324')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122324" value="03.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122324')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122324" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122324')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122324">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122324">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122324">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122324">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122324">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122324">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259047362</span>
                                <span class="subheader-pl-dates">03.02 10:00 → 03.02 22:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">Р054МО186</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122324"></div>

                    <div id="map-122324" class="map-container active">
                        <div class="map-data"
                             data-polyline="e~rwIgg`~EfK_ErDkDp@xALv@XC\MZkA|@wBdAgBR?|@j@VQZuAPgCHuDlBcElCkDvLwIfAcAVq@h@UAtBH~BVfC^tBp@pBbEdJjBfD`@b@p@j@rBzAnFhDjQlMp@|@rAfCt@jBj@|Bd@|Dx@zRPrGVhDtAlPX`F~Dg@bBKlQ|@b^hCbHl@|^i@z@Fb@RLz@ZhtA`@r@hA@dKiB~NmKjCkApr@yDzfCyMdAVbA~@zAbE~G`d@dBaBnB{CzBa@lAmA|n@yK^kBHwC_Acg@sAgDeAos@KwXYkLuEm^}Ag_Ah@}BnAm@zReG}F}JmNgUaKqO"
                             data-route-points="[{&quot;lat&quot;: 56.463391525144004, &quot;lng&quot;: 36.54384611764882, &quot;address&quot;: &quot;ВСЖМ, 6 этап, ПК5514, М-11 «Нева»&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 56.38290962839232, &quot;lng&quot;: 36.56990039744653, &quot;address&quot;: &quot;ВСЖМ, 6 этап, ПК5600, М-11 «Нева»&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122324">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122324" checked onchange="toggleParkings('122324')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122324" value="0" min="0" onchange="updateMapFilters('122324')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122324" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122324" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122324" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122324" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122324')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122324')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122324_0_v0" onclick="selectVehicleV2('122324', '122324_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">Р054МО186</div>
                                <div class="vehicle-selector-name">С/Тягач MAN 6*6 · ПЛ 1259047362</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122324">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">Р054МО186</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/Тягач MAN 6*6</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">160.9 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">5.3 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">10.4 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">5.1 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">88.9 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">19</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122324_0_v0"
                                    onclick="loadShifts('122324_0_v0', '1259047362_03.02.2026', 6155, '03.02.2026 10:00:00', '03.02.2026 22:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122324_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122324">
                        <div data-vehicle-uid="122324_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">Р054МО186</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/Тягач MAN 6*6</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">160.9 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">5.3 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">10.4 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">5.1 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">88.9 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">19</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122324_0_v0"
                                    onclick="loadShifts('122324_0_v0', '1259047362_03.02.2026', 6155, '03.02.2026 10:00:00', '03.02.2026 22:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122324_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122325 825 А531АР172 С/Тягач MAN 6*6" data-date="03.02.2026" data-number="122325" data-start-addr="ВСЖМ, НАкопитель песка и ЩПС, М-11 «Нева»" data-end-addr="ВСЖМ, 6 этап, ПК5555, М-11 «Нева»" data-cost-obj="Создание ВСМ Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап. Основные работы – Стр-во уч. Новая Тверь. Московская обл.">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122325', this.querySelector('.copy-btn'));">
                                Заявка №122325
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">ВСЖМ, НАкопитель песка и ЩПС, М-11 «Нева»</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">ВСЖМ, 6 этап, ПК5555, М-11 «Нева»</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122325', 'ВСЖМ, НАкопитель песка и ЩПС, М-11 «Нева»', 'ВСЖМ, 6 этап, ПК5555, М-11 «Нева»', '03.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">31.4 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 26м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 1</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">Свая</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">75.0 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Создание ВСМ Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап. Основные работы – Стр-во уч. Новая Тверь. Московская обл.</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122325">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122325">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122325" value="1" min="1" onchange="updateCalcPlan('122325')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122325" value="1" min="1" onchange="updateCalcPlan('122325')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122325" value="31" min="1" onchange="updateCalcPlan('122325')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122325" value="65" min="10" max="120" onchange="updateCalcPlan('122325')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122325" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122325')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122325" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122325')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122325" value="03.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122325')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122325" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122325')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122325">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122325">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122325">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122325">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122325">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122325">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№825</span>
                                <span class="subheader-pl-dates">03.02 10:00 → 03.02 22:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">А531АР172</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122325"></div>

                    <div id="map-122325" class="map-container active">
                        <div class="map-data"
                             data-polyline="gnrwIeda~EpAnMj@bC?nBXC\MZkA|@wBdAgBR?|@j@VQZuAPgCHuDlBcElCkDvLwIfAcAVq@h@UFiJQiD[wCe@_CcIiZgCoKoAaEa@kAeAuBc@c@oMwIs@s@Ya@aK{Ro@_AUGa@?{@FyKpAoDf@_AFaAEkAe@qRmQgHaH{@mAk@cAwDiQa@eA]aBWq@zu@wv@~QsRlPqPfc@ad@vKwKtToU~h@ui@pQuQ~xA{zAfEiEvOgPdHeHfxAuyAho@mp@h{Aw|AzIyIlAIxBHvAp@fAzAdAhDxDhWxAvI~BzKnKrd@r@rCniAz{EnEtQxGlWzAjHNhCA`EMhOObDs@`DsBrEqVh\}e@dp@uv@rbAqQxTcXhZuU~SgNnL_E|Cqf@j\gCrAeMpGwx@j`@uJ~EosAto@aRdIiPrGePjF{NlEkXxFoSzB"
                             data-route-points="[{&quot;lat&quot;: 56.460614085125115, &quot;lng&quot;: 36.54743186797045, &quot;address&quot;: &quot;ВСЖМ, НАкопитель песка и ЩПС, М-11 «Нева»&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 56.445120223360064, &quot;lng&quot;: 36.54432295892305, &quot;address&quot;: &quot;ВСЖМ, 6 этап, ПК5555, М-11 «Нева»&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122325">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122325" checked onchange="toggleParkings('122325')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122325" value="0" min="0" onchange="updateMapFilters('122325')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122325" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122325" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122325" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122325" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122325')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122325')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122325_0_v0" onclick="selectVehicleV2('122325', '122325_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">А531АР172</div>
                                <div class="vehicle-selector-name">С/Тягач MAN 6*6 · ПЛ 825</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122325">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">А531АР172</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/Тягач MAN 6*6</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">26.9 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">2.9 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">6.7 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">3.7 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">42.6 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">18</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122325_0_v0"
                                    onclick="loadShifts('122325_0_v0', '825_03.02.2026', 6156, '03.02.2026 10:00:00', '03.02.2026 22:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122325_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122325">
                        <div data-vehicle-uid="122325_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">А531АР172</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/Тягач MAN 6*6</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">26.9 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">2.9 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">6.7 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">3.7 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">42.6 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">18</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122325_0_v0"
                                    onclick="loadShifts('122325_0_v0', '825_03.02.2026', 6156, '03.02.2026 10:00:00', '03.02.2026 22:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122325_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122326 1259047364 К539АА186 С/тягач КамАЗ 44108-24" data-date="03.02.2026" data-number="122326" data-start-addr="ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»" data-end-addr="ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»" data-cost-obj="Создание ВСМ Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап. Основные работы – Стр-во уч. Новая Тверь. Тверская обл.">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122326', this.querySelector('.copy-btn'));">
                                Заявка №122326
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122326', 'ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»', 'ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»', '03.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">0.12 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 0м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 1</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">Свая</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">75.0 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Создание ВСМ Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап. Основные работы – Стр-во уч. Новая Тверь. Тверская обл.</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122326">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122326">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122326" value="1" min="1" onchange="updateCalcPlan('122326')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122326" value="1" min="1" onchange="updateCalcPlan('122326')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122326" value="0" min="1" onchange="updateCalcPlan('122326')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122326" value="65" min="10" max="120" onchange="updateCalcPlan('122326')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122326" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122326')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122326" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122326')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122326" value="03.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122326')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122326" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122326')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122326">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122326">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122326">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122326">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122326">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122326">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259047364</span>
                                <span class="subheader-pl-dates">03.02 10:00 → 03.02 22:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">К539АА186</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122326"></div>

                    <div id="map-122326" class="map-container active">
                        <div class="map-data"
                             data-polyline="srlxIalr}Ee@|CCpDB^"
                             data-route-points="[{&quot;lat&quot;: 56.59411075932014, &quot;lng&quot;: 36.47155242547397, &quot;address&quot;: &quot;ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 56.59411075932014, &quot;lng&quot;: 36.4702649751252, &quot;address&quot;: &quot;ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122326">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122326" checked onchange="toggleParkings('122326')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122326" value="0" min="0" onchange="updateMapFilters('122326')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122326" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122326" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122326" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122326" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122326')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122326')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122326_0_v0" onclick="selectVehicleV2('122326', '122326_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">К539АА186</div>
                                <div class="vehicle-selector-name">С/тягач КамАЗ 44108-24 · ПЛ 1259047364</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122326">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">К539АА186</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач КамАЗ 44108-24</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">2.5 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">0.6 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">12.0 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">11.4 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">33.2 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">12</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122326_0_v0"
                                    onclick="loadShifts('122326_0_v0', '1259047364_03.02.2026', 524, '03.02.2026 10:00:00', '03.02.2026 22:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122326_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122326">
                        <div data-vehicle-uid="122326_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">К539АА186</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач КамАЗ 44108-24</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">2.5 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">0.6 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">12.0 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">11.4 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">33.2 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">12</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122326_0_v0"
                                    onclick="loadShifts('122326_0_v0', '1259047364_03.02.2026', 524, '03.02.2026 10:00:00', '03.02.2026 22:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122326_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122328 1259067567 Р338ХС72 С/Тягач MAN TGS 33.480 6х6 BB" data-date="03.02.2026" data-number="122328" data-start-addr="ВСЖМ, 6 этап, ПК5514, М-11 «Нева»" data-end-addr="ВСЖМ, 7 этап, ПК5642, городской округ Клин, Московская область" data-cost-obj="Создание высокоскоростной ж/д мгстр. Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап – Стр-во уч. Новая Тверь. Московская обл.">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122328', this.querySelector('.copy-btn'));">
                                Заявка №122328
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">ВСЖМ, 6 этап, ПК5514, М-11 «Нева»</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">ВСЖМ, 7 этап, ПК5642, городской округ Клин, Московская область</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122328', 'ВСЖМ, 6 этап, ПК5514, М-11 «Нева»', 'ВСЖМ, 7 этап, ПК5642, городской округ Клин, Московская область', '03.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">46.5 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">1ч 7м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 1</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">гусеничный кран SENNEBOGEN 3300e</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">39.5 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">154.176 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Создание высокоскоростной ж/д мгстр. Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап – Стр-во уч. Новая Тверь. Московская обл.</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122328">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122328">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122328" value="1" min="1" onchange="updateCalcPlan('122328')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122328" value="1" min="1" onchange="updateCalcPlan('122328')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122328" value="47" min="1" onchange="updateCalcPlan('122328')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122328" value="65" min="10" max="120" onchange="updateCalcPlan('122328')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122328" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122328')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122328" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122328')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122328" value="03.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122328')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122328" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122328')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122328">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122328">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122328">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122328">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122328">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122328">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067567</span>
                                <span class="subheader-pl-dates">03.02 10:00 → 03.02 22:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">Р338ХС72</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122328"></div>

                    <div id="map-122328" class="map-container active">
                        <div class="map-data"
                             data-polyline="e~rwIgg`~EfK_ErDkDp@xALv@XC\MZkA|@wBdAgBR?|@j@VQZuAPgCHuDlBcElCkDvLwIfAcAVq@h@UAtBH~BVfC^tBp@pBbEdJjBfD`@b@p@j@rBzAnFhDjQlMp@|@rAfCt@jBj@|Bd@|Dx@zRPrGVhDtAlPX`F~Dg@bBKlQ|@b^hCbHl@|^i@z@Fb@RLz@ZhtA`@r@hA@dKiB~NmKjCkApr@yDzfCyMdAVbA~@zAbE~G`d@dBaBnB{CzBa@lAmA|n@yK^kBHwC_Acg@sAgDeAos@KwXYkLuEm^}Ag_Ah@}BnAm@zReG}F}JmNgUaKqO`KpOlNfU|F|JdB_@pqAk`@tSwGz\gKjkAsAjHWZO|@}@pJmLfCeDd@g@r@k@n@Wj@CfAFf@NbBlBlAbAb@l@dBbEx@kDLSj@HHA`Ao@L?tAf@NLfA~AVh@\`BTzAT~CHd@X|@^f@f@d@v@z@^Z`Ab@~AR~@t@Zd@^^RF^gFvIoxAZoDp@wF^}Bn@wCl@_Cx@qCdB}E~@mB|@aBvAqB~g@qk@VOt@B`ByOZ{EF{ALwHHmIBkGIcF[mIkG{qAsB_e@McBY{CmDqUcB_MyFm`@{@iHc@oFSqEOmH?qCJ_KPoFvDm{@bBgd@p@iPn@iQfEybAr@wMpBi]jEsp@_NcL{@i@i@i@oA_BuA{B}BiFmEgLoBsFeEkKcBuEo@yA[qA_@uCyAgNsBqQ}@kHYkBWPS@aMbHyFbDGPCA_Ioq@]cC_@iAoBjF_BzEe@lAYf@yA~ByBzCqG~I_FvGcAlAs@bAq@hA_AnAif@pf@iRbRokA~lAqLnLcm@xm@gg@pg@q@?WPSCa@W]o@Mg@Kq@CaBDk@Po@Tk@RSb@WX?\HVVTf@RlAPzAt@pErBtOdBlLrAzIxAvI~BzKnKrd@r@rCniAz{EnEtQxGlWrOjg@Xr@^b@\JXA\MTUR]Ng@Ho@LcBHsCHsAJ_AXuA\_AhCqFdNoQlDqDvHyGlDiChz@kk@zM{I"
                             data-route-points="[{&quot;lat&quot;: 56.463391525144004, &quot;lng&quot;: 36.54384611764882, &quot;address&quot;: &quot;ВСЖМ, 6 этап, ПК5514, М-11 «Нева»&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 56.38290962839232, &quot;lng&quot;: 36.56990039744653, &quot;address&quot;: &quot;ВСЖМ, 6 этап, ПК5600, М-11 «Нева»&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;17:00&quot;}, {&quot;lat&quot;: 56.361092, &quot;lng&quot;: 36.598291, &quot;address&quot;: &quot;ВСЖМ, 7 этап, ПК5642, городской округ Клин, Московская область&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122328">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122328" checked onchange="toggleParkings('122328')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122328" value="0" min="0" onchange="updateMapFilters('122328')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122328" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122328" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122328" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122328" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122328')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122328')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122328_0_v0" onclick="selectVehicleV2('122328', '122328_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">Р338ХС72</div>
                                <div class="vehicle-selector-name">С/Тягач MAN TGS 33.480 6х6 BB · ПЛ 1259067567</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122328">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">Р338ХС72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/Тягач MAN TGS 33.480 6х6 BB</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">18.8 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">0.3 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">11.6 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">11.2 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">50.9 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">2</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122328_0_v0"
                                    onclick="loadShifts('122328_0_v0', '1259067567_03.02.2026', 5789, '03.02.2026 10:00:00', '03.02.2026 22:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122328_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122328">
                        <div data-vehicle-uid="122328_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">Р338ХС72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/Тягач MAN TGS 33.480 6х6 BB</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">18.8 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">0.3 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">11.6 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">11.2 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">50.9 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">2</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122328_0_v0"
                                    onclick="loadShifts('122328_0_v0', '1259067567_03.02.2026', 5789, '03.02.2026 10:00:00', '03.02.2026 22:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122328_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122344 1259047373 Р152НК186 С/тягач MAN 6*4" data-date="03.02.2026" data-number="122344" data-start-addr="ВСЖМ 3 этап, ПК2694, 49Н-1234 Окуловка - Мельница" data-end-addr="Окуловка, Дубецкая дорога" data-cost-obj="Создание высокоскоростной ж/д мгстр. Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 3 Этап – Стр-во уч. Валдай ВСМ. Новгородская обл.">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122344', this.querySelector('.copy-btn'));">
                                Заявка №122344
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">ВСЖМ 3 этап, ПК2694, 49Н-1234 Окуловка - Мельница</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Окуловка, Дубецкая дорога</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122344', 'ВСЖМ 3 этап, ПК2694, 49Н-1234 Окуловка - Мельница', 'Окуловка, Дубецкая дорога', '03.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">01.03.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">5.5 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 5м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 28</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">Свая С14-35Т5</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">1023.4 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">411.74 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Создание высокоскоростной ж/д мгстр. Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 3 Этап – Стр-во уч. Валдай ВСМ. Новгородская обл.</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122344">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122344">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122344" value="1" min="1" onchange="updateCalcPlan('122344')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122344" value="28" min="1" onchange="updateCalcPlan('122344')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122344" value="6" min="1" onchange="updateCalcPlan('122344')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122344" value="65" min="10" max="120" onchange="updateCalcPlan('122344')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122344" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122344')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122344" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122344')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122344" value="03.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122344')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122344" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122344')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122344">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122344">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122344">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122344">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122344">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122344">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259047373</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 04.02 08:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">Р152НК186</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122344"></div>

                    <div id="map-122344" class="map-container active">
                        <div class="map-data"
                             data-polyline="i}ccJ_wfjEmC_@u@Ci@Nc@`@{@`BsAtAaChE}CdH}FvNu@`Cs@bAk@f@qCj@cCbA{@Ou@g@i@aAw@aBcBoF]o@_BgBsDsBmA[sAm@iDeAwEw@eA]g@k@wCcEgAu@kD}@Yd@g@Z_@DWGe@YeCeC[AuBjG{BzHmA~C_@n@SRJh@vAbEjC`O`BnIkKjOC|AOdAS|@iBtF_AxDu@xEoErUIl@IrAPjNXzJ?zAG|AO`C_@zEc@bE{@~FgAhI{A`I]vBm@|@eJvJYj@O~@}Bn{@kBbL[z@"
                             data-route-points="[{&quot;lat&quot;: 58.35221091545172, &quot;lng&quot;: 33.30190658394714, &quot;address&quot;: &quot;ВСЖМ 3 этап, ПК2694, 49Н-1234 Окуловка - Мельница&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;06:00&quot;}, {&quot;lat&quot;: 58.38295340115731, &quot;lng&quot;: 33.25462818145753, &quot;address&quot;: &quot;Окуловка, Дубецкая дорога&quot;, &quot;date&quot;: &quot;01.03.2026&quot;, &quot;time&quot;: &quot;06:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122344">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122344" checked onchange="toggleParkings('122344')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122344" value="0" min="0" onchange="updateMapFilters('122344')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122344" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122344" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122344" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122344" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122344')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122344')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122344_0_v0" onclick="selectVehicleV2('122344', '122344_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">Р152НК186</div>
                                <div class="vehicle-selector-name">С/тягач MAN 6*4 · ПЛ 1259047373</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122344">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">Р152НК186</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач MAN 6*4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">3.6 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">0.5 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">9.3 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">8.8 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">28.0 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">11</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122344_0_v0"
                                    onclick="loadShifts('122344_0_v0', '1259047373_03.02.2026', 6279, '03.02.2026 08:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122344_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122344">
                        <div data-vehicle-uid="122344_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">Р152НК186</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач MAN 6*4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">3.6 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">0.5 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">9.3 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">8.8 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">28.0 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">11</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122344_0_v0"
                                    onclick="loadShifts('122344_0_v0', '1259047373_03.02.2026', 6279, '03.02.2026 08:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122344_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122351 1259047387 В654ХН86 С/тягач Volvo FM Truck 6х4 12.8" data-date="03.02.2026" data-number="122351" data-start-addr="улица Бабушкина, Стерлитамак" data-end-addr="проспект Братьев Коростелёвых, 181, Оренбург" data-cost-obj="Реконструкция мостового перехода через реку Сакмара (верхового) на проспекте Братьев Коростылевых в городе Оренбурге (АВТОБАН ДСК АО)">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122351', this.querySelector('.copy-btn'));">
                                Заявка №122351
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">улица Бабушкина, Стерлитамак</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">проспект Братьев Коростелёвых, 181, Оренбург</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122351', 'улица Бабушкина, Стерлитамак', 'проспект Братьев Коростелёвых, 181, Оренбург', '03.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">28.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">246.0 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">3ч 25м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 20</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">груз сборный</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">75.0 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Реконструкция мостового перехода через реку Сакмара (верхового) на проспекте Братьев Коростылевых в городе Оренбурге (АВТОБАН ДСК АО)</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122351">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122351">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122351" value="1" min="1" onchange="updateCalcPlan('122351')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122351" value="20" min="1" onchange="updateCalcPlan('122351')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122351" value="246" min="1" onchange="updateCalcPlan('122351')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122351" value="65" min="10" max="120" onchange="updateCalcPlan('122351')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122351" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122351')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122351" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122351')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122351" value="03.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122351')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122351" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122351')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122351">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122351">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122351">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122351">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122351">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122351">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259047387</span>
                                <span class="subheader-pl-dates">03.02 10:00 → 03.02 22:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">В654ХН86</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122351"></div>

                    <div id="map-122351" class="map-container active">
                        <div class="map-data"
                             data-polyline="oiqfIc}wtIbLjDjFrBv@^t@f@|@dAj@dAzApEd@n@n@t@xFpFvB`C`GrEdGnDhD|AhD`ApF|@`CZdBBrHa@v@?pAPfBl@dCrB|AlBpCrCb@z@Rp@TnAHj@BlA?hBBjAhEfTZhBJ~AB~@\jF`AbJJ\|@zAZZxIlGtJxAjJ`AlLp@dM\|FJ~H~@~Cf@|ANhOjC`HjH|BfCpGcVxCoMfCaKjLxLvB~BRLdQzQle@df@`HnHlIpIhI~E\?RSPe@RqAL]^_@bFgBb@K\AjFV~ENnCb@z_A|FlJb@lA?zB}@pAu@pKeHdEiCtGqEfBgBxBkDpL{S|EuJjJmSzBoB|@]t@St@Gr@BfXrJdNlFve@dZ~G~E|QrOfApAj@|@vAzCpSra@lEbIlZfh@j@v@t@v@^^fAl@lQ`Gpa@dMdD|@v_@jLtD`AlIlC~d@hNvx@~UzJnCjBp@fGjBdQ`Ftr@`T~^hLrBd@~D^ve@|CdFb@|c@|CbBNrARnAXb@PnA`AjXhVz@p@fAp@hAf@bB\trAfMpHUjBUxPo@jG_@pBSfASr@[vEgCdDyAfKuF|PuJ`EsBtI_FfLeGlLwG`NqHzg@kXh@Sr@AxALlDb@|dAzO~En@hBPz[n@fh@t@~IFjN\zNh@z_AxApGRx\bBp@Pn@d@DLTV^HXBVGhBgAPC`o@`DnClA|BfCfEfInClG~E|JjAxB|@xBfAjBn@h@v@Vv@B|MGzHMxA?`BDfKz@lMd@pEHzZBhA^~@`Az@dAp@jAl@r@z@r@n@XfABb@Gj@Ur@w@jA_Cp@eBTc@LOx@[lB?nMOpKGx@@fB^`JjEdBt@t@PjALpVl@|AXrB`ArDrAhHZjCMbKaCnt@nApDLhDq@xAiBhH{KnNaXhQk[~EmHdBcAjB_@de@El@lB|Au@fCw@`FO~e@GbPz@th@rDveD|U~HnAne@dJnhBf\nLrBnAH`CHf^oKpQ_G~TgHvAMjLlBjHlBtH|BxTlGje@rN|TtGh]~Ixp@nPja@xJrDTvE?vGHx@Xn@dA|@|Bh@r@pA^fmBbI`ZbAnoD_HhDOzB_@fCs@pDcBfjBaoA|F}BdG{AnEs@pg@Urt@tFzV]hpA_DvEBjEV~i@bFh[|CrBFlACzAY~x@w^vUkFnDi@n^wD`EWdNfAhHr@xGvBdAf@xAz@xBhBt@~@|@tA|F|KrH`O~CdIjBpFhAxEbBpKrEr]hA|FrAjFbBvExBhFfCpEjDhExCbCfC`BhD~AbD~@xO~C|T~D`QxBdUtA`eBrInSI|z@yAjTQ|CZvFbBhB|@lBp@lMnFd}C`oAvBnApFjEhs@xo@lPpOfGnF`ChBnBlArBdAjBr@jEbAtBP`CCtBe@tBu@|DoBrA_AhAcAlAqAhAeB`CgEfk@qeAps@msAlFsJxByCpC_DvC}BvDeBjKgDnEkBvFmCpHyEjDeCnCaC`FyFvBqCdBoCdUcb@lB}BtAqA`BkA~Y}ObW{MlFiBjV}Hvk@{RvZ_KbCe@nCIjBPdJfBpcAtSxCr@fIlCjIbDtInDxJxDhAdAdBxB|JjNx@z@rAbAj_Aze@zAz@nDjCrBnBhrD`cEhXvb@hLpQnO`UlAzA|CpAjARtCVjPl@hNX~F_BjAa@fAu@dA_AhAwAbAqBr@mBn@mCt@qF|@kO`BaMdCcItGaLtFcL`CuDnDkDhDoBtEoAxGcAxGUpIrAxJtBfIzC|NpIzJhGjJnHdJfItEbFrDfGnEvIfCvFlFrHpI|DhPjHjCpA~GtCjBb@~~@`Jng@dFrl@lF`h@dFzTfCjABpAQpJkBfCa@`JkB~J_CnKmChLcDdTwFjn@}PnAQh@Cr@BlAVbAj@v@z@l@dAVn@t@`C|Krd@|@xCh@xArGjPnXrs@`AnB~KdQxEzHnAfBvAvA|BjBn@^p@\fBp@nAZxATvBRhABp[HpGAfBQrAe@pAu@`As@nCyCvL}OvA{Az@o@|@k@bA_@tBc@np@cKlDo@|CShB?jN`@fCEpBMlQwDh]{H~Da@dEMvLl@`KDrHk@pEs@v^}Gt_@oDrWkB`h@wCxFi@tFy@hTwEdQgDlRmBpCWr@AxB`@hrAjb@t_@`KjwBbd@tv@~Jdw@hInSrAvrBzOj\nCx`Aj@hMRlX|@`FElEk@lf@yHtBKp@DlAR~Af@xDhCbCrAdA^pBTvAC|@OfBg@pRsHvCcAfBi@dAUdAMbA@~@L`AV`A`@dAh@p@f@zAdBh@x@d@~@xKzY|FxOzBnFtBdEhDlFlTxZ|c@dp@tr@dbAlE|FpBrB|BlBjBnAjCpAdDnA|Ct@tZvF`D~@`Bn@zBfAlC~AhCxBbBfB|BzClBnCzCvFjItPjTvd@pJ~Rb@fAx@rBd@xAjA~E`t@ziDvZb_BrH|`@rFrXvM~o@f\~~ApWlnAtRz|@pEdSbPbq@fKpc@fXphA`p@noCbEtPpfAbqErGtXlA|EpsBrtIdAbEfEnQdBdHjDhOxLpg@bFhSzDxM|GnTvFzPrl@pjBps@l{Bz]rfApP`i@jGvQdGnOxDfI`\~o@zWbi@tFfLjXji@xVbf@vVve@jJzP~Z~i@bPvXrElHjOvTdApAp_@ni@xl@fz@f_@`h@tlC|uCrGjHpHhHvF|EdGrE~DnCxDxBdErBlJfEvFxBlRjF~FhBtD|AfD~A`CzAjChBpB|AjB`BlErE~D`Ffa@ni@lYp_@rH|JjMnPbRnVdEfFjF|E|FzDvGtD`FrBzDjA~Cz@dBzA\l@Pd@Ln@Dh@@f@Ar@Gt@Kt@Sv@[|@fEaDrAu@pCkAbBg@jBYzD]`@K~GVhGNnDNbHNrDXbCZroC|b@duB`\tsCzc@fDt@t@\nAXhDh@n@Bj@EtBTlHpA~A\hI~BjoDldApm@`Q~R|F~QhFp[nJ`XnHr^vK~GtCtFvDhDpCfDxC|BbClChDxC~D`DnFfCtEnAjCfBhE`BnEff@h}AlGxSb@zBdAzDrAnEt@tBz@nBjHfT`AbCvDtIxBdEvAbCxCvEdCdDrCbDdBdBvCfCnEfDdCzAfE|BnmAzl@fc@nTbq@j\|EjBfDx@nFdAxARnWzBza@vD`Cb@fDt@`Cn@zGlC|DvBdDzBdDbC|BrBvBxB`DtDvBnC~FlJ`DhGp_@n}@bIvRbBvD`LhX`HdPnJjU|Stf@zZht@lUpj@fHpPxDrIxDtHnGhKxBbDzXf_@tNvRp{DfmF~l@tx@nK~NnFfHtDfE|DtDPn@f@nAb@vA^rALlAH`BB|AE~AIfAS~BhAmCxBqHvEgNhBqE`CsFtDaI~LiVhKeSr@{ArCoF|DmGzD{GhFiKbCkFlAwCnc@m{@`i@giAxFkMpCsFpAsB`AsAh@m@~BgBtAq@bBm@pAWrCSjGBnIHxG`@xK@vAGzHC~L@BpBJpBRtB~@dH|@|Ft@tCp@nBt@dBT^l@f@b@VXHj@@XOd@u@|DiJdLwV^i@b@_@h@WjAYl@Cl@Fz@T\TvBlD`GvKrG|KhR|ZvQhYr@jAVj@mCjG}EhKOb@@`@Vr@hBxCHRDZFfKAlYBjAHTf@XJJHXB`@@bBCbBK|@o@`DyA~EgBhFiH|U}@jDEZoBtIMjAb@p@pDhDpKhLFr@Ap@a@lCNVxAdApBjAnBj@zBd@bACjC{Ad@OZDR\ZvB^xAv@xBfAnDhAdEhJb\jDfMrClJjBlEhDhHh@n@n@RfBFbAIn@O|@k@t@m@Jp@?l@Kh@C^g@xBMNKd@KR?f@BZET"
                             data-route-points="[{&quot;lat&quot;: 53.669678712685354, &quot;lng&quot;: 55.996060271538504, &quot;address&quot;: &quot;улица Бабушкина, Стерлитамак&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 51.81279293834748, &quot;lng&quot;: 55.04665851574317, &quot;address&quot;: &quot;проспект Братьев Коростелёвых, 181, Оренбург&quot;, &quot;date&quot;: &quot;28.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122351">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122351" checked onchange="toggleParkings('122351')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122351" value="0" min="0" onchange="updateMapFilters('122351')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122351" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122351" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122351" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122351" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122351')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122351')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122351_0_v0" onclick="selectVehicleV2('122351', '122351_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">В654ХН86</div>
                                <div class="vehicle-selector-name">С/тягач Volvo FM Truck 6х4 12.8 · ПЛ 1259047387</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122351">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">В654ХН86</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4 12.8</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">В движении</div><div class="value">0.0 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">0.8 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">0.7 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">1.9 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">1</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122351_0_v0"
                                    onclick="loadShifts('122351_0_v0', '1259047387_03.02.2026', 707, '03.02.2026 10:00:00', '03.02.2026 22:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122351_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122351">
                        <div data-vehicle-uid="122351_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">В654ХН86</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4 12.8</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">В движении</div><div class="value">0.0 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">0.8 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">0.7 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">1.9 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">1</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122351_0_v0"
                                    onclick="loadShifts('122351_0_v0', '1259047387_03.02.2026', 707, '03.02.2026 10:00:00', '03.02.2026 22:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122351_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122358 837 А252ВВ172 С/Тягач MAN 6*4" data-date="03.02.2026" data-number="122358" data-start-addr="Ялуторовский тракт 11-й км., 9, Тюмень" data-end-addr="Тобольск" data-cost-obj="Стр-во нового комплекса пр-ва пропилена дегидрированием пропана и деривативов пропилена (ДГП-2) на ООО «ЗапСибНефтехим».Общестр. работы выше отм. 0.00">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122358', this.querySelector('.copy-btn'));">
                                Заявка №122358
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">Ялуторовский тракт 11-й км., 9, Тюмень</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Тобольск</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122358', 'Ялуторовский тракт 11-й км., 9, Тюмень', 'Тобольск', '03.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">04.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">252.2 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">3ч 21м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 1</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">груз сборный</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">60.0 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Стр-во нового комплекса пр-ва пропилена дегидрированием пропана и деривативов пропилена (ДГП-2) на ООО «ЗапСибНефтехим».Общестр. работы выше отм. 0.00</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122358">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122358">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122358" value="1" min="1" onchange="updateCalcPlan('122358')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122358" value="1" min="1" onchange="updateCalcPlan('122358')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122358" value="252" min="1" onchange="updateCalcPlan('122358')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122358" value="65" min="10" max="120" onchange="updateCalcPlan('122358')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122358" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122358')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122358" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122358')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122358" value="03.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122358')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122358" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122358')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122358">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122358">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122358">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122358">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122358">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122358">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№837</span>
                                <span class="subheader-pl-dates">03.02 12:00 → 04.02 20:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">А252ВВ172</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122358"></div>

                    <div id="map-122358" class="map-container active">
                        <div class="map-data"
                             data-polyline="ijn{IopxoKJwBEq@NuDr@sK?o@Ac@ISSYiFsFuCqDo@m@vTcx@`AmCn@wB\u@`@a@XKJ?ZFXVLPPf@PnAVvF?j@E~@Kr@Ul@e@b@WHe@?y@KaCIyFe@aEMuELqBLaC\cGhAsl@dPaC^{BTkFH}DQ{AOeDm@cCq@sBs@kDaBmCcBmDmCiBiB}BeCmA{A{AwBmBwCsByDe^yt@gWkh@aAcBgBuCcByBw@}@aAaAyBoB_BeAcBaAgCeAcCs@iCc@mAMuBEcB@qAHmBTcB^_Bf@_Bn@uBfA_DzBgBbBiD~DyFxIgBdC{BvCqC~CyB|BiC~BoB`ByAdAgFbDoBdAkClAqUrIgj@`SuG|BeEnAs@Lsg@~FiFb@cBEgAe@[W]a@_@u@Oa@iE{PSkBC_CVaKh@ePbEgfAvGudBrA_\tCwv@tQiuE\aGt@_Kt@yPN{EL_KJmF~HgqBdFmpA`Bub@HmG?_FsAuxAa@__@i@qYcAab@q@eV[uIa@cIk@qIeA{LaAuIw@gGeB}KeBqJ_M_n@uYsyAoB_JuAeGiRou@}CaMm@kCuA_HwA{Ho@yDeBiLu@_Gek@caFk@iGkAoOmAqKoDkV}BcSyA}NcNqmAcIsq@mDcWw@oGs@iHc@kF]{FKmBYcJGgECcK@_EB_HVwUFgBJ{BPmCt@_Jv@iIv@kG|E}[|Ggh@nA}H\aBl@mClAuEr@sBdEyK|@oCbA_ElD{Q`A_Ej@mBzAkE|Mm^j@gBxBiInAcFfCeLpa@kpB|P}x@dB}GfEeOh@{Bb@{Bj@eEv@cIj@aFfAcIhImf@bBkL|@aHfA{J|@_KtD}c@`AuOTkGJ{GCaIIgHW_IgIycB}K}cCqBod@Q{FMsGGcN?_P@_KF{F\gNf@kLzBic@bT}yDvEk|@lE_w@j@qId@{Fn@{Fj@}DjDqR|@kF`AiGbCiRhAcHfDkR|@uFjA_J`Gsk@`Fmf@~@iIhAaIhBmK|@gErFuVzBqKzAsIfBaL|AeMnAeMh@{GfCi^rFyu@rC}a@zDam@hHydAZuFl@uML}CPcHJeGJiP@sQVoOB}G?eEGkEKqDIeC[gFg@uHa@qH[aJyAu]QiF[cNGmIAsE@yXNos@GoLIcGo@iVM}Cg@oJiGu~@iAyR_@mFYwCk@_E{Ck`@iJqnAs@_Kk@aKiQg~D[gIi@kPQsII_KDwk@KmMe@qXs@yTsBml@wNwpDmBcd@_@gHo@mJYiDuKegAmBqQ}@sHy@wFyA_JiAcGoCsM_AsDkAkEkDyL{A{EuCqIgAyC}B}FeCwFgQk^uB}D_FoI_JoN{BkE{@mBw@mBsCoIkE}NwBcJql@onCed@ssBmDoNoBoH_BoFiDuKc`@_iAkOgd@yf@axAw]mcAcOod@_^siA{BwGaKk\mBcGeEkNcCaHiD_Jw@yByDsL}Lib@sAeFyAiGcAmEwBeKw@gEoDgUqAmJwA}KmAoKcWedCsAsL}AgM}A_LmKir@wSqsAiO}aAa@_DwBeR}XqgCsBmPwB{NgA{GoAiHcC{LaCkK{CaMcCaJyCuJ{CiJad@grAkEwNsAyDkFcN{C}IguAgaEeGaR_GcRaHiU}Kc`@skA_fE{BwImAwFwBgKoBgI}AqFwAmE_BmEoBwEmCgGiIwS}BiFmB_EyDyHwCmF{CkF_EiG}EaH{GmIuCeD_~@{bAoAmAaDsC_E}C{AcAqGaEmFuCeCiAsFsB{GkBmIwAqRqByEs@kDq@kD_AuHmC{DgB{DsBmEsCmGyE{CkCkCgCsGmHgEqF{A{BsBiDiGkLgDqFgCqDgDaEeKaLgAsAmHeK{~@urAeEwG}F_KuFmKuAsCeGeNcCeGi`@}gAsEyLeEsK}BuG}BmFcAkB{@qAmPeRsGwGoGeGmsAulAy_@s]cYcWyOaN{I}GuJiHkD_Cgl@ib@kIsFaP{IwHwF{A}@wAq@kAc@iAWo@GkHY_Ge@{AS}KyBwj@qLgCm@eDcAuKoEqB}@cHwDyLuHcR_Lc^iSmPqHoSuHoMqDkPiDmOyBkDYoMuAsCOoEOkKi@iCC{XHsc@_@qh@sA{Ou@}Em@mB[cDu@uGkBoDqAqB{@mGcD}DiCqB_BmEaE}AiBcByBoFuHwAeCqAeCkAiCmBeFu@{BmBcHcBqHeCgMy@yFUsBe@iGSyE[iIMgFIqGcAc}AE_IMeIMwDk@kKYaE}AcPkBaQ{@oGcCsNwAkHuB_J}C}KaEqPw@yCa@iAaAwBg@cAaDwEgAiBsAkBsGkKiUi[y_A{oAcRmWiLmOwFaHoIsLa[cb@iL_OyNqPkKaLyEwE}JkKsL_KcLmImN{Lwg@wb@qHyGaF_FsGuHqBoCoHwKsDyF}CkFmDaHmDiHkG{NsCoHmCsHaCmHgGaTmB}Hwr@ucD_Hc[sBoIiBeHwHsVwZe~@qFaQsCmKaGgWeM}j@qFyWiDyOgHc\eJ_a@aPot@_D_NmGuTsJu]eAkEgDqOyAoGkBoJ{AcJ{Gmf@m@}EqFyi@_B}RoBiXo@eG{BsRiAyIeA}GsGc\cAoEkAoEiBgGwCaJwCmI}ByF}CcHeFmKqDmGgBqCga@ml@qSuZwSkZiA_AcR{XaE}GyCwFsCyFeCqFcC}FiGaPeCeHqBiGuEuOgAeE}DkPaE{RcAqF}@qFyDuW_AeIeCaW{B{Ww@wK{@eN_Dae@eRglCuDkg@uC}\cAeK}@iIgHum@gB_Ns@qEcCcNgHa_@{D}PsAmFgBoGsBeHyEmO}CaJkDmJqDeJkDcI{J_TwDqHeIqOmEwHoWo_@oCeEaDeEeBqBotA_sAci@eh@ucBebBqk@ik@cBmBwBoCqImMgCuEuBmEgBgEwAyDcEeMeFcPeBaGaBuGuJs`@wm@edCsMii@cAaFi@yCa@qCwAqLY{CW}DQwDKqDGmDGuH?qPPay@FkiBAed@IqgAAkFMaMmF{_FM}JW}J]qM_@{JeHiyAyPgiDw@kMc@yFu@kIa@}DgBsNaQmrAmOqjAoAsJaAyIW{CeBcX[_H[{HMmEc@qRaBew@m@uRWkGc@aIe@{GaAsKyYatCgAmJiAoIqCmQkAaH_BqIiA{FuAoGsCqLmDeNaBwFsBoGkCuH}GuQqHyQyx@yiByc@wbAiFwLsB_FsDaKeDoJiBcG}BeIwAmF{DgPcFwUwRy~@aUueA_Put@mBwHqAwEqBcHkBsFoAkDaDcI_CqFeCmFgC_FkCwEqb@it@uaBctC}B_EgDiGsEaJqD_ImDkI_HeRoCqIyBsH}A_GqCgLmFqVeBoJiXe}AgAeG{@gEkCkLoAaFsA}EiDoK{AeEkA_Da]ox@oG{Oi_A_zBcQ}a@wJgUuFoLgGwL}EmIuHcMaIoLuHiJwDaEaHaHyCmCyFmE_IwFcF_DgHcEaK}EqD{AwDuAap@wT_K_DyT}FqE{@oC]_DUkDQmBCyDJ_E\yGfAkF`BmE~AkEpBwDzBsDlCqPlNuDlCsHpEsFzBoBh@}cAjQqb@vHoe@bIaLtBgJpAiCXqH`@yFLwG@gHWgFe@qCe@sKwB_NyD{EmBkCsAeKeGmE_D_CiBeJuHksAojAuH{GuHoHqoA}qAkVwVyE_E}GgGyBgBwJmGmIiE}XiMwQqHy{@{^qOmFoEmAkJkByCa@qHu@wF[gt@aAmGa@qH_A}DgAqPmF_GeC_GkC}E_D{E}DeFgF{EwFkW}^k`@sl@mFuH{RwYoD{F_EaHkC_FmCsFoFsLqCaH_CcHuBgHwB}HiVodAsNgn@}Loh@ud@snBc]ezAyCyNqC{OeA{GqCeSoBwOkDoZwG_n@wBwTqL_xAkEgg@}@wI_@iDoAmJeAoGu@sDaBgHyAwFkFgRsBgG_C_GmAmCsCcFuBeD}E{GgFiGcE_EyBoBiCmBuBiAsg@gR}CmAyNoFgIqCyPsGqHmCkF{BgGoBkCo@_De@wDUcNWaM[cKD_CFsCXeFlAo[xJeH~A}E~@yDl@kD^sLh@}CVoEf@eDf@}HjBoBv@oBbAkBrAsDzC}HtHmDvDwCnDgB~BqAvBcIxPaGhO{BrGuCtHcCxEqAxBaG`JyFtH{DrE}A`BsCfCkA|@qC|AwEtBaC|@wC~@iBd@uDv@yCb@cBPiADqNH}M?oMJmACaB[iAKuGBcBMmGAc@GUGc@[{AoBYYo@a@m@QcC_@]Ki@[q@u@U_@_@cAMe@Q}@Ky@UgESk|CGcP_EkgDkEokDSaU@YHq@\{ALYr@uAVQ~@[vbAcHUcPkAmcAkaAlGiGl@q@_j@e\tBeAuz@QeA[}@"
                             data-route-points="[{&quot;lat&quot;: 57.094735850000006, &quot;lng&quot;: 65.66673305442129, &quot;address&quot;: &quot;Ялуторовский тракт 11-й км., 9, Тюмень&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;12:00&quot;}, {&quot;lat&quot;: 58.23557769695699, &quot;lng&quot;: 68.46692562103273, &quot;address&quot;: &quot;Тобольск&quot;, &quot;date&quot;: &quot;04.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122358">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122358" checked onchange="toggleParkings('122358')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122358" value="0" min="0" onchange="updateMapFilters('122358')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122358" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122358" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122358" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122358" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122358')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122358')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122358_0_v0" onclick="selectVehicleV2('122358', '122358_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">А252ВВ172</div>
                                <div class="vehicle-selector-name">С/Тягач MAN 6*4 · ПЛ 837</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122358">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">А252ВВ172</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/Тягач MAN 6*4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">298.9 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">5.3 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">12.1 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">6.8 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">134.7 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">12</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122358_0_v0"
                                    onclick="loadShifts('122358_0_v0', '837_03.02.2026', 6280, '03.02.2026 12:00:00', '04.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122358_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122358">
                        <div data-vehicle-uid="122358_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">А252ВВ172</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/Тягач MAN 6*4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">298.9 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">5.3 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">12.1 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">6.8 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">134.7 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">12</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122358_0_v0"
                                    onclick="loadShifts('122358_0_v0', '837_03.02.2026', 6280, '03.02.2026 12:00:00', '04.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122358_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122373 1259067732 О526МВ72 С/тягач Камаз 54105" data-date="03.02.2026" data-number="122373" data-start-addr="База МО36, Ялуторовский тракт 11-й км., 1 с17, Тюмень" data-end-addr="База МО36, Ялуторовский тракт 11-й км., 1А с7, Тюмень" data-cost-obj="Цех ЖБИ">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122373', this.querySelector('.copy-btn'));">
                                Заявка №122373
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">База МО36, Ялуторовский тракт 11-й км., 1 с17, Тюмень</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">База МО36, Ялуторовский тракт 11-й км., 1А с7, Тюмень</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122373', 'База МО36, Ялуторовский тракт 11-й км., 1 с17, Тюмень', 'База МО36, Ялуторовский тракт 11-й км., 1А с7, Тюмень', '03.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">04.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">0.17 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 0м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 56</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">Перевозка плит ПДН</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">60.0 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Цех ЖБИ</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122373">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122373">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122373" value="1" min="1" onchange="updateCalcPlan('122373')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122373" value="56" min="1" onchange="updateCalcPlan('122373')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122373" value="0" min="1" onchange="updateCalcPlan('122373')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122373" value="65" min="10" max="120" onchange="updateCalcPlan('122373')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122373" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122373')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122373" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122373')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122373" value="03.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122373')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122373" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122373')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122373">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122373">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122373">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122373">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122373">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122373">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067732</span>
                                <span class="subheader-pl-dates">03.02 20:00 → 04.02 08:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">О526МВ72</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122373"></div>

                    <div id="map-122373" class="map-container active">
                        <div class="map-data"
                             data-polyline="_im{IimyoK?_@EQkAiCgBuDEEOH"
                             data-route-points="[{&quot;lat&quot;: 57.089611245500016, &quot;lng&quot;: 65.67142009735109, &quot;address&quot;: &quot;База МО36, Ялуторовский тракт 11-й км., 1 с17, Тюмень&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}, {&quot;lat&quot;: 57.090707130725, &quot;lng&quot;: 65.6734585762024, &quot;address&quot;: &quot;База МО36, Ялуторовский тракт 11-й км., 1А с7, Тюмень&quot;, &quot;date&quot;: &quot;04.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122373">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122373" checked onchange="toggleParkings('122373')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122373" value="0" min="0" onchange="updateMapFilters('122373')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122373" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122373" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122373" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122373" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122373')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122373')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122373_0_v0" onclick="selectVehicleV2('122373', '122373_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">О526МВ72</div>
                                <div class="vehicle-selector-name">С/тягач Камаз 54105 · ПЛ 1259067732</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122373">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">О526МВ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Камаз 54105</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">0.1 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">0.0 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">2.7 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">2.7 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">11.5 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">2</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122373_0_v0"
                                    onclick="loadShifts('122373_0_v0', '1259067732_03.02.2026', 523, '03.02.2026 20:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122373_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122373">
                        <div data-vehicle-uid="122373_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">О526МВ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Камаз 54105</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">0.1 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">0.0 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">2.7 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">2.7 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">11.5 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">2</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122373_0_v0"
                                    onclick="loadShifts('122373_0_v0', '1259067732_03.02.2026', 523, '03.02.2026 20:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122373_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122377 845 А531АР172 С/Тягач MAN 6*6" data-date="03.02.2026" data-number="122377" data-start-addr="ВСЖМ, 6 этап, ПК5555, Нагорная улица, Решетниково" data-end-addr="ВСЖМ, 6 этап, ПК5555, Нагорная улица, Решетниково" data-cost-obj="Создание ВСМ Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап. Основные работы – Стр-во уч. Новая Тверь. Московская обл.">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122377', this.querySelector('.copy-btn'));">
                                Заявка №122377
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">ВСЖМ, 6 этап, ПК5555, Нагорная улица, Решетниково</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">ВСЖМ, 6 этап, ПК5555, Нагорная улица, Решетниково</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122377', 'ВСЖМ, 6 этап, ПК5555, Нагорная улица, Решетниково', 'ВСЖМ, 6 этап, ПК5555, Нагорная улица, Решетниково', '03.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">04.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">0.07 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 0м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 1</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">Свая</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">75.0 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Создание ВСМ Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап. Основные работы – Стр-во уч. Новая Тверь. Московская обл.</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122377">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122377">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122377" value="1" min="1" onchange="updateCalcPlan('122377')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122377" value="1" min="1" onchange="updateCalcPlan('122377')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122377" value="0" min="1" onchange="updateCalcPlan('122377')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122377" value="65" min="10" max="120" onchange="updateCalcPlan('122377')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122377" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122377')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122377" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122377')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122377" value="03.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122377')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122377" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122377')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122377">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122377">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122377">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122377">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122377">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122377">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№845</span>
                                <span class="subheader-pl-dates">03.02 22:00 → 04.02 10:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">А531АР172</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122377"></div>

                    <div id="map-122377" class="map-container active">
                        <div class="map-data"
                             data-polyline="_howIyva~Ea@Ce@Qu@?"
                             data-route-points="[{&quot;lat&quot;: 56.44405004678846, &quot;lng&quot;: 36.547346215019516, &quot;address&quot;: &quot;ВСЖМ, 6 этап, ПК5555, Нагорная улица, Решетниково&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}, {&quot;lat&quot;: 56.444951117212916, &quot;lng&quot;: 36.5470896722598, &quot;address&quot;: &quot;ВСЖМ, 6 этап, ПК5555, Нагорная улица, Решетниково&quot;, &quot;date&quot;: &quot;04.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122377">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122377" checked onchange="toggleParkings('122377')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122377" value="0" min="0" onchange="updateMapFilters('122377')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122377" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122377" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122377" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122377" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122377')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122377')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122377_0_v0" onclick="selectVehicleV2('122377', '122377_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">А531АР172</div>
                                <div class="vehicle-selector-name">С/Тягач MAN 6*6 · ПЛ 845</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122377">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">А531АР172</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/Тягач MAN 6*6</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">12.5 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">1.2 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">4.7 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">3.5 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">23.6 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">9</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122377_0_v0"
                                    onclick="loadShifts('122377_0_v0', '845_03.02.2026', 6156, '03.02.2026 22:00:00', '04.02.2026 10:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122377_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122377">
                        <div data-vehicle-uid="122377_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">А531АР172</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/Тягач MAN 6*6</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">12.5 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">1.2 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">4.7 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">3.5 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">23.6 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">9</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122377_0_v0"
                                    onclick="loadShifts('122377_0_v0', '845_03.02.2026', 6156, '03.02.2026 22:00:00', '04.02.2026 10:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122377_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122378 1259047400 К539АА186 С/тягач КамАЗ 44108-24" data-date="03.02.2026" data-number="122378" data-start-addr="ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»" data-end-addr="ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»" data-cost-obj="Создание ВСМ Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап. Основные работы – Стр-во уч. Новая Тверь. Тверская обл.">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122378', this.querySelector('.copy-btn'));">
                                Заявка №122378
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122378', 'ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»', 'ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»', '03.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">04.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">0.12 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 0м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 1</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">перевозка металлоконструкций</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">75.0 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Создание ВСМ Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап. Основные работы – Стр-во уч. Новая Тверь. Тверская обл.</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122378">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122378">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122378" value="1" min="1" onchange="updateCalcPlan('122378')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122378" value="1" min="1" onchange="updateCalcPlan('122378')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122378" value="0" min="1" onchange="updateCalcPlan('122378')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122378" value="65" min="10" max="120" onchange="updateCalcPlan('122378')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122378" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122378')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122378" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122378')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122378" value="03.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122378')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122378" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122378')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122378">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122378">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122378">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122378">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122378">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122378">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259047400</span>
                                <span class="subheader-pl-dates">03.02 22:00 → 04.02 10:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">К539АА186</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122378"></div>

                    <div id="map-122378" class="map-container active">
                        <div class="map-data"
                             data-polyline="srlxIalr}Ee@|CCpDB^"
                             data-route-points="[{&quot;lat&quot;: 56.59411075932014, &quot;lng&quot;: 36.47155242547397, &quot;address&quot;: &quot;ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}, {&quot;lat&quot;: 56.59411075932014, &quot;lng&quot;: 36.4702649751252, &quot;address&quot;: &quot;ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»&quot;, &quot;date&quot;: &quot;04.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122378">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122378" checked onchange="toggleParkings('122378')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122378" value="0" min="0" onchange="updateMapFilters('122378')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122378" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122378" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122378" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122378" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122378')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122378')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122378_0_v0" onclick="selectVehicleV2('122378', '122378_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">К539АА186</div>
                                <div class="vehicle-selector-name">С/тягач КамАЗ 44108-24 · ПЛ 1259047400</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122378">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">К539АА186</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач КамАЗ 44108-24</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">8.0 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">1.6 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">8.6 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">7.0 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">28.4 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">15</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122378_0_v0"
                                    onclick="loadShifts('122378_0_v0', '1259047400_03.02.2026', 524, '03.02.2026 22:00:00', '04.02.2026 10:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122378_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122378">
                        <div data-vehicle-uid="122378_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">К539АА186</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач КамАЗ 44108-24</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">8.0 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">1.6 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">8.6 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">7.0 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">28.4 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">15</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122378_0_v0"
                                    onclick="loadShifts('122378_0_v0', '1259047400_03.02.2026', 524, '03.02.2026 22:00:00', '04.02.2026 10:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122378_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122382 1259067566 О856МЕ72 С/тягач Volvo FM Truck 6х4 12.8" data-date="03.02.2026" data-number="122382" data-start-addr="ВСЖМ, 6 этап, ПК5452, М-11 «Нева»" data-end-addr="Вельмогово, М-11 «Нева»" data-cost-obj="Создание высокоскоростной ж/д мгстр. Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап – Стр-во уч. Новая Тверь. Московская обл.">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122382', this.querySelector('.copy-btn'));">
                                Заявка №122382
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">ВСЖМ, 6 этап, ПК5452, М-11 «Нева»</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Вельмогово, М-11 «Нева»</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122382', 'ВСЖМ, 6 этап, ПК5452, М-11 «Нева»', 'Вельмогово, М-11 «Нева»', '03.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">03.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">04.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">27.0 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 31м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 1</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">Буровое оборудование</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">69.12 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Создание высокоскоростной ж/д мгстр. Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап – Стр-во уч. Новая Тверь. Московская обл.</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122382">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122382">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122382" value="1" min="1" onchange="updateCalcPlan('122382')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122382" value="1" min="1" onchange="updateCalcPlan('122382')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122382" value="27" min="1" onchange="updateCalcPlan('122382')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122382" value="65" min="10" max="120" onchange="updateCalcPlan('122382')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122382" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122382')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122382" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122382')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122382" value="03.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122382')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122382" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122382')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122382">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122382">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122382">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122382">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122382">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122382">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067566</span>
                                <span class="subheader-pl-dates">03.02 10:00 → 04.02 10:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">О856МЕ72</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122382"></div>

                    <div id="map-122382" class="map-container active">
                        <div class="map-data"
                             data-polyline="gl}wIw~x}EuAhAeShM}OvH{lA`c@cu@`V_dAja@wnAtj@wCTmAUo@Yc@WaByAUYWOUESB_@TOTSh@G\EbABdAdCnZz@hIBfCKhBS|A{A~DyEhIiElI}ArBwAlAeDaQgIw`@aJmb@yAyJW}BGy@A{@?gSL_Q@oDCkGK}I_@{NrFaDtUoN~dB}bAjj@k\dz@of@bkAgl@`N{GfHiDbAYxF_AfAIdBChHLp@Ep@ObAe@dAu@pFqFp^m_@~`@qa@xyAa|AraBmcBbX}XVp@\`B`@dAvDhQj@bAz@lAfH`HpRlQjAd@`AD~@GnDg@xKqAz@G`@?TFn@~@`KzRX`@r@r@nMvIb@b@dAtBpBlGfCnKbIhZd@~BZvCPhDGhJi@TWp@gAbAwLvImCjDmBbEItDQfC[tAWP}@k@S?eAfB}@vB[jA]LYBMw@q@yAsDjDqKdEwC`@iCFgBs@aEz@gOhCt@cA"
                             data-route-points="[{&quot;lat&quot;: 56.51744362624301, &quot;lng&quot;: 36.5084352493307, &quot;address&quot;: &quot;ВСЖМ, 6 этап, ПК5452, М-11 «Нева»&quot;, &quot;date&quot;: &quot;03.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}, {&quot;lat&quot;: 56.46876837112266, &quot;lng&quot;: 36.542707439545296, &quot;address&quot;: &quot;Вельмогово, М-11 «Нева»&quot;, &quot;date&quot;: &quot;04.02.2026&quot;, &quot;time&quot;: &quot;01:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122382">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122382" checked onchange="toggleParkings('122382')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122382" value="0" min="0" onchange="updateMapFilters('122382')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122382" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122382" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122382" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122382" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122382')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122382')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122382_0_v0" onclick="selectVehicleV2('122382', '122382_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">О856МЕ72</div>
                                <div class="vehicle-selector-name">С/тягач Volvo FM Truck 6х4 12.8 · ПЛ 1259067566</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122382">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">О856МЕ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4 12.8</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="no-data">Нет данных мониторинга</div>

                            <button class="shift-load-btn" id="shift-btn-122382_0_v0"
                                    onclick="loadShifts('122382_0_v0', '1259067566_03.02.2026', 107, '03.02.2026 10:00:00', '04.02.2026 10:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122382_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122382">
                        <div data-vehicle-uid="122382_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">О856МЕ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4 12.8</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="no-data">Нет данных мониторинга</div>

                            <button class="shift-load-btn" id="shift-btn-122382_0_v0"
                                    onclick="loadShifts('122382_0_v0', '1259067566_03.02.2026', 107, '03.02.2026 10:00:00', '04.02.2026 10:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122382_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="121369 798 В614СО89 С/тягач КамАЗ 44108-24 799 В614СО89 С/тягач КамАЗ 44108-24" data-date="01.02.2026" data-number="121369" data-start-addr="71Н-1656 Подъезд к промпорту, Тобольск" data-end-addr="Тобольск, Р-404 Тюмень — Тобольск — Ханты-Мансийск" data-cost-obj="Строительство и реконструкция моста через р. Иртыш. А/д Р-404">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('121369', this.querySelector('.copy-btn'));">
                                Заявка №121369
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">71Н-1656 Подъезд к промпорту, Тобольск</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Тобольск, Р-404 Тюмень — Тобольск — Ханты-Мансийск</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '121369', '71Н-1656 Подъезд к промпорту, Тобольск', 'Тобольск, Р-404 Тюмень — Тобольск — Ханты-Мансийск', '01.02.2026', 2)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">01.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">01.03.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">24.7 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 29м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 224</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">2</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">плита ПДН-14</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">3763.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">214.2 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Строительство и реконструкция моста через р. Иртыш. А/д Р-404</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-121369">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-121369">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-121369" value="1" min="1" onchange="updateCalcPlan('121369')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-121369" value="224" min="1" onchange="updateCalcPlan('121369')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-121369" value="25" min="1" onchange="updateCalcPlan('121369')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-121369" value="65" min="10" max="120" onchange="updateCalcPlan('121369')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-121369" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('121369')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-121369" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('121369')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-121369" value="01.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('121369')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-121369" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('121369')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-121369">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-121369">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-121369">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-121369">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-121369">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-121369">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (2)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№798</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 03.02 20:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">В614СО89</span>
                            </div>
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№799</span>
                                <span class="subheader-pl-dates">03.02 20:00 → 04.02 08:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#ed64a6"></span><span class="subheader-pl-vehicle" style="color:#ed64a6">В614СО89</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-121369"></div>

                    <div id="map-121369" class="map-container active">
                        <div class="map-data"
                             data-polyline="{rybJykk_LlGge@CsC@yBDeBJoBj@yFh@eD`AwFpEqU|EcXhRccA|BwMhR{mA|Gob@bAoHPq@Vo@p@eAdBaBaBwGkBuIyAqH_@oBs@cFaEkZo@aGEkA?}A^iCXeATq@Zk@h@o@^]rBo@hAWdAg@^]tN_Q|a@ah@~@mA|@sAdB_Dl@sAfc@wgAto@}`B|JuVbRqe@`C_G~@qBrAeCfAeBp@w@dAw@pAe@nBa@lBGnqAWtXMdx@Bbl@]bBDnMK|M?pNIhAEbBQxCc@~G}AvC_A`C}@vEuBpC}AjA}@rCgC|AaBzDsExFuH`GaJpAyBbCyEtCuHzBsG`GiOvGmNj@kApAwBfB_CvCoDlDwD|HuHrD{CjBsAnBcAnBw@|HkBdDg@nEg@|CWrLi@jD_@vKmBdH_Bn[yJdFmArCY~BGbKE`MZbNVvDT~Cd@jCn@fGnBjFzBpHlCxPrGfIpCxNnF|ClArg@fRtBhAhClBxBnBbE~DfFhG|EzGtBdDrCbFlAlC~B~F}@hBQFY[WOaDJa@N]p@Y\Wn@k@x@QH{@QW[Og@EqADcAXoAn@gBrAqBL_@h@qD?a@EW[o@WkAsE}GmAcAiCeDy@w@u@cAm@m@w@]{BiBo@jAuCfAiA?e@x@s@rB[hD"
                             data-route-points="[{&quot;lat&quot;: 58.299184389621146, &quot;lng&quot;: 68.21951866149904, &quot;address&quot;: &quot;71Н-1656 Подъезд к промпорту, Тобольск&quot;, &quot;date&quot;: &quot;01.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 58.14389475246397, &quot;lng&quot;: 68.35899353027345, &quot;address&quot;: &quot;Тобольск, Р-404 Тюмень — Тобольск — Ханты-Мансийск&quot;, &quot;date&quot;: &quot;01.03.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-121369">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-121369" checked onchange="toggleParkings('121369')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-121369" value="0" min="0" onchange="updateMapFilters('121369')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-121369" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-121369" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-121369" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-121369" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('121369')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('121369')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="121369_0_v0" onclick="selectVehicleV2('121369', '121369_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">В614СО89</div>
                                <div class="vehicle-selector-name">С/тягач КамАЗ 44108-24 · ПЛ 798</div>
                            </div>
                        </div>
                        <div class="vehicle-selector-item" data-vehicle-uid="121369_1_v0" onclick="selectVehicleV2('121369', '121369_1_v0', 1)">
                            <span class="vehicle-selector-color" style="background:#ed64a6"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">В614СО89</div>
                                <div class="vehicle-selector-name">С/тягач КамАЗ 44108-24 · ПЛ 799</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-121369">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">В614СО89</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач КамАЗ 44108-24</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">70.0 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">2.8 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">12.0 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">9.2 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">47.7 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">18</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121369_0_v0"
                                    onclick="loadShifts('121369_0_v0', '798_03.02.2026', 736, '03.02.2026 08:00:00', '03.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121369_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-121369">
                        <div data-vehicle-uid="121369_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">В614СО89</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач КамАЗ 44108-24</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">70.0 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">2.8 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">12.0 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">9.2 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">47.7 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">18</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121369_0_v0"
                                    onclick="loadShifts('121369_0_v0', '798_03.02.2026', 736, '03.02.2026 08:00:00', '03.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121369_0_v0"></div>
                        </div>
                        </div>
                        <div data-vehicle-uid="121369_1_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">В614СО89</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач КамАЗ 44108-24</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">52.9 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">1.1 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">12.0 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">10.9 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">36.2 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">4</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121369_1_v0"
                                    onclick="loadShifts('121369_1_v0', '799_03.02.2026', 736, '03.02.2026 20:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121369_1_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="121389 1259066955 У519ХУ72 С/тягач Volvo FM Truck 6х4 1259066998 У519ХУ72 С/тягач Volvo FM Truck 6х4" data-date="01.02.2026" data-number="121389" data-start-addr="Омск" data-end-addr="Харино" data-cost-obj="Строительство автомобильной дороги «Северный обход г. Омска»">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('121389', this.querySelector('.copy-btn'));">
                                Заявка №121389
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">Омск</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Харино</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '121389', 'Омск', 'Харино', '01.02.2026', 2)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">01.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">01.03.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">54.4 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">1ч 13м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 56</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">2</span>
                        </div>
                        
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Строительство автомобильной дороги «Северный обход г. Омска»</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-121389">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-121389">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-121389" value="1" min="1" onchange="updateCalcPlan('121389')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-121389" value="56" min="1" onchange="updateCalcPlan('121389')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-121389" value="54" min="1" onchange="updateCalcPlan('121389')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-121389" value="65" min="10" max="120" onchange="updateCalcPlan('121389')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-121389" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('121389')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-121389" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('121389')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-121389" value="01.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('121389')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-121389" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('121389')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-121389">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-121389">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-121389">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-121389">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-121389">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-121389">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (2)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259066955</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 04.02 08:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">У519ХУ72</span>
                            </div>
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259066998</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 04.02 08:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#ed64a6"></span><span class="subheader-pl-vehicle" style="color:#ed64a6">У519ХУ72</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-121389"></div>

                    <div id="map-121389" class="map-container active">
                        <div class="map-data"
                             data-polyline="ebnoIidm~LXFv@AxWgAtNu@z@AHr^?`p@AnMEjC?|Bh@dJ?`H\`Gd@~TPhYbBbcALxADrAFnAAb@GPSVc@XYb@b@vTTjIHt@pBkArK_IrIuGlc@}\vlAo_An@k@jE_F|UwXve@yj@~_@_d@dk@}p@~PqSzCiDfAcAtk@qc@t@s@X_@tCiFn@aAjBeBh@Yl@Qr@KfA?`@Bb@J~MvFxLjE`t@bV~[lKb\xKbm@`TdCv@zIzC~Ah@tPpDxD~@zEx@jE~@r@XnBlA~@v@zAxAnA`Bp^re@pMpQv[te@nG|JrCrDl@~@vCdFxKjPnE`GpEpFPk@PSnBsGtAvBpPhYn@x@pAzAfKdL~AvBxAxBsApDiArDuFhS]pA]|AKfAEn@yBzbA_GreCUbNGtJAnWAp@KpB}G~k@}Dj]SjCA`Bmb@hjAiMx\kBxFo@|Bo@rCmAjGi@nE_AbKaKvhAuCvZyDb_@gBnQk@lGu@|Ky@xM{HnyAiArRiAtU]`FeAhRq@rJkKvrAoA`Ok@nFi@fEe@~COx@m@hBsBlIo@xCqAbE}AdEwAbDuAnCuAfCiC|DsDxEaA|@cG~E_xAzfAs^zWyBnAsAdAaB`BaPpMoNlKgo@hf@uNpJuWtKw`Ax_@{fAh_@uErA_NbFoQnGcANO?]ESOg@w@oFmX{BiKqBaKwGa`@_A}GQeB_@yLeAgs@_@m^EsAI_ASeAa@wAUmAWuCA_DD}CA_BCqA_AeMEiA?_AJkCP_CPcBjEo\j@cFTiC?o@Kc@OSQGo@EmQJ{e@FgRHgXCk@Cc@Ma@UWYkHyLmAgBw@wA_@{@yCwKuBeI_@iA]w@iAiBa@k@g@]_@IsFNoAA{@ISM{@aA_@k@Ui@Sm@Mu@M_Ay@uKQoBcBiN_@_Fc@iHoAmPk@{GOaDIwDKcQA{JJ_Cx@wMJ_AF[HULQ\SJ{DD}CD_@\_B@]E[KWs@o@kCcDuA}@uB_Aw@k@mAgAm@_Ay@mBUWYI_@CcBBk@Ei@K{Ai@k@e@y@_AgBqCuBaEu@w@g@_@aIuB_HgA_JWiJ}@uHeAyAa@u@IkKj@{BB_Ha@yBNk@?WKGg@@o@vBuNB[?YGUMSc@KaAAiFF]GOOKWGyAEa@I_@{@aBc@e@k@_@qFuBqBiAgBwAcBsBYOo@OmI{@iAQgEgAcCy@_E{Ag@WoCuBkAeAa@c@aEoGmC_DyAoByAaBoGiEsA[}JcG]k@Kg@GgA?oAH_ANs@Ro@No@Bo@Ag@Mc@OSa@EgAL[?e@O}@c@u@e@Y_@KWEc@Bo@Fs@n@sERcC\eHjCmr@@iAMsB"
                             data-route-points="[{&quot;lat&quot;: 55.1286490684888, &quot;lng&quot;: 73.30078125000001, &quot;address&quot;: &quot;Омск&quot;, &quot;date&quot;: &quot;01.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 55.165338405970346, &quot;lng&quot;: 73.17752838134767, &quot;address&quot;: &quot;Харино&quot;, &quot;date&quot;: &quot;01.03.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-121389">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-121389" checked onchange="toggleParkings('121389')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-121389" value="0" min="0" onchange="updateMapFilters('121389')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-121389" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-121389" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-121389" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-121389" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('121389')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('121389')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="121389_0_v0" onclick="selectVehicleV2('121389', '121389_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">У519ХУ72</div>
                                <div class="vehicle-selector-name">С/тягач Volvo FM Truck 6х4 · ПЛ 1259066955</div>
                            </div>
                        </div>
                        <div class="vehicle-selector-item" data-vehicle-uid="121389_1_v0" onclick="selectVehicleV2('121389', '121389_1_v0', 1)">
                            <span class="vehicle-selector-color" style="background:#ed64a6"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">У519ХУ72</div>
                                <div class="vehicle-selector-name">С/тягач Volvo FM Truck 6х4 · ПЛ 1259066998</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-121389">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">У519ХУ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">88.4 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">2.6 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">5.7 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">3.2 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">61.7 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">16</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121389_0_v0"
                                    onclick="loadShifts('121389_0_v0', '1259066955_03.02.2026', 121, '03.02.2026 08:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121389_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-121389">
                        <div data-vehicle-uid="121389_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">У519ХУ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">88.4 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">2.6 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">5.7 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">3.2 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">61.7 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">16</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121389_0_v0"
                                    onclick="loadShifts('121389_0_v0', '1259066955_03.02.2026', 121, '03.02.2026 08:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121389_0_v0"></div>
                        </div>
                        </div>
                        <div data-vehicle-uid="121389_1_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">У519ХУ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">88.4 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">2.6 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">5.7 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">3.2 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">61.7 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">16</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121389_1_v0"
                                    onclick="loadShifts('121389_1_v0', '1259066998_03.02.2026', 121, '03.02.2026 08:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121389_1_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="121468 1259067401 А471ВК172 С/Тягач MAN 6*6" data-date="01.02.2026" data-number="121468" data-start-addr="ВСЖМ 3 этап, ПК2694, 49Н-1234 Окуловка - Мельница" data-end-addr="Окуловка, Дубецкая дорога" data-cost-obj="Создание высокоскоростной ж/д мгстр. Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 3 Этап – Стр-во уч. Валдай ВСМ. Новгородская обл.">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('121468', this.querySelector('.copy-btn'));">
                                Заявка №121468
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">ВСЖМ 3 этап, ПК2694, 49Н-1234 Окуловка - Мельница</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Окуловка, Дубецкая дорога</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '121468', 'ВСЖМ 3 этап, ПК2694, 49Н-1234 Окуловка - Мельница', 'Окуловка, Дубецкая дорога', '01.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">01.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">28.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">5.5 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 5м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 28</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">Свая С14-35Т5</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">924.5 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">375.659 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Создание высокоскоростной ж/д мгстр. Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 3 Этап – Стр-во уч. Валдай ВСМ. Новгородская обл.</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-121468">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-121468">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-121468" value="1" min="1" onchange="updateCalcPlan('121468')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-121468" value="28" min="1" onchange="updateCalcPlan('121468')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-121468" value="6" min="1" onchange="updateCalcPlan('121468')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-121468" value="65" min="10" max="120" onchange="updateCalcPlan('121468')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-121468" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('121468')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-121468" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('121468')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-121468" value="01.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('121468')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-121468" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('121468')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-121468">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-121468">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-121468">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-121468">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-121468">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-121468">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067401</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 04.02 08:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">А471ВК172</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-121468"></div>

                    <div id="map-121468" class="map-container active">
                        <div class="map-data"
                             data-polyline="i}ccJ_wfjEmC_@u@Ci@Nc@`@{@`BsAtAaChE}CdH}FvNu@`Cs@bAk@f@qCj@cCbA{@Ou@g@i@aAw@aBcBoF]o@_BgBsDsBmA[sAm@iDeAwEw@eA]g@k@wCcEgAu@kD}@Yd@g@Z_@DWGe@YeCeC[AuBjG{BzHmA~C_@n@SRJh@vAbEjC`O`BnIkKjOC|AOdAS|@iBtF_AxDu@xEoErUIl@IrAPjNXzJ?zAG|AO`C_@zEc@bE{@~FgAhI{A`I]vBm@|@eJvJYj@O~@}Bn{@kBbL[z@"
                             data-route-points="[{&quot;lat&quot;: 58.35221091545172, &quot;lng&quot;: 33.30190658394714, &quot;address&quot;: &quot;ВСЖМ 3 этап, ПК2694, 49Н-1234 Окуловка - Мельница&quot;, &quot;date&quot;: &quot;01.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 58.38295340115731, &quot;lng&quot;: 33.25462818145753, &quot;address&quot;: &quot;Окуловка, Дубецкая дорога&quot;, &quot;date&quot;: &quot;28.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-121468">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-121468" checked onchange="toggleParkings('121468')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-121468" value="0" min="0" onchange="updateMapFilters('121468')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-121468" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-121468" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-121468" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-121468" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('121468')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('121468')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="121468_0_v0" onclick="selectVehicleV2('121468', '121468_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">А471ВК172</div>
                                <div class="vehicle-selector-name">С/Тягач MAN 6*6 · ПЛ 1259067401</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-121468">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">А471ВК172</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/Тягач MAN 6*6</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">308.9 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">5.1 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">9.3 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">4.2 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">438.6 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">11</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121468_0_v0"
                                    onclick="loadShifts('121468_0_v0', '1259067401_03.02.2026', 6152, '03.02.2026 08:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121468_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-121468">
                        <div data-vehicle-uid="121468_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">А471ВК172</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/Тягач MAN 6*6</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">308.9 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">5.1 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">9.3 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">4.2 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">438.6 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">11</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121468_0_v0"
                                    onclick="loadShifts('121468_0_v0', '1259067401_03.02.2026', 6152, '03.02.2026 08:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121468_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="121830 1259067069 С299ОА72 С/тягач Mercedes-Benz Actros 3346S" data-date="01.02.2026" data-number="121830" data-start-addr="Пожарная улица, Красная Горка" data-end-addr="Омск" data-cost-obj="Строительство автомобильной дороги «Северный обход г. Омска»">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('121830', this.querySelector('.copy-btn'));">
                                Заявка №121830
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">Пожарная улица, Красная Горка</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Омск</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '121830', 'Пожарная улица, Красная Горка', 'Омск', '01.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">01.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">28.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">37.9 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">2ч 39м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 28</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">Раздвижной трал для подвоза трубы 1020, длина трубы - 40 м., вес 628,32 тонн, выработка в смену 22,4</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">538.5 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">250.0 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Строительство автомобильной дороги «Северный обход г. Омска»</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-121830">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-121830">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-121830" value="1" min="1" onchange="updateCalcPlan('121830')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-121830" value="28" min="1" onchange="updateCalcPlan('121830')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-121830" value="38" min="1" onchange="updateCalcPlan('121830')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-121830" value="65" min="10" max="120" onchange="updateCalcPlan('121830')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-121830" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('121830')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-121830" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('121830')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-121830" value="01.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('121830')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-121830" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('121830')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-121830">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-121830">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-121830">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-121830">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-121830">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-121830">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067069</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 04.02 08:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">С299ОА72</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-121830"></div>

                    <div id="map-121830" class="map-container active">
                        <div class="map-data"
                             data-polyline="s{loI}kj}LUDg@XaADgEGm@IyAk@sDgE_@k@Qg@oAoFQa@SYSM_@Gs@Bm@ZMPITGZK~@y@vMK~B@zJJbQHvDN`Dj@zGnAlPb@hH^~EbBhNPnBx@tKL~@Lt@Rl@Th@^j@z@`ARLz@HnA@rFO^Hf@\`@j@hAhB\v@^hAbEvOjAdE^z@pLxRVX`@Tb@Lj@BfXBfRIze@GlQKn@DPFNRJb@?n@UhCk@bFkEn\QbBQ~BKjC?~@DhA~@dMBpA@~AE|C@~CVtCTlA`@vARdAH~@DrA^l^dAfs@VfJFpAPdB~@|GvG``@pB`KzBhKnFlX@j@Cd@I^KXwAhA{k@pW_A~@K\C\Db@LZNPjA^dBVjGdBnEbAdCVtC@tCSrDeAnB}@rDaCrGoFjAgApAyAfA{AxDeH~EeKxAkC~@iA`B{AxA_AhFuCzfAi_@v`Ay_@tWuKtNqJfo@if@nNmK`PqMhBaArAcApBqBr^{W~wA{fAbG_F`A}@rDyEhC}DtAgCtAoCvAcD|AeElCqItBiIVsA|@_Gh@gEj@oFnAaOpDed@xEqm@p@sJdAiR\aFhAuUhAsRzHoyAx@yMt@}Kj@mGfBoQxDc_@tCwZ`KwhAwBb@cDf@kCNaDBu@JaYj@{K\}KRuLb@uC@sBKSCWS_@k@{HrTmErLm@}@yHwCaWxh@w_@fi@eXdMcp@jMiN]}QdXeT|OkXdBeRb@qg@vJ}APyDfAij@bMwkAt[gmApd@oa@~MoXeBe[{N"
                             data-route-points="[{&quot;lat&quot;: 55.12138568243934, &quot;lng&quot;: 73.13117980957033, &quot;address&quot;: &quot;Пожарная улица, Красная Горка&quot;, &quot;date&quot;: &quot;01.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 55.118637029676854, &quot;lng&quot;: 73.1407928466797, &quot;address&quot;: &quot;Омск&quot;, &quot;date&quot;: &quot;28.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-121830">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-121830" checked onchange="toggleParkings('121830')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-121830" value="0" min="0" onchange="updateMapFilters('121830')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-121830" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-121830" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-121830" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-121830" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('121830')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('121830')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="121830_0_v0" onclick="selectVehicleV2('121830', '121830_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">С299ОА72</div>
                                <div class="vehicle-selector-name">С/тягач Mercedes-Benz Actros 3346S · ПЛ 1259067069</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-121830">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">С299ОА72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Mercedes-Benz Actros 3346S</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">77.8 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">2.8 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">12.3 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">9.5 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">72.5 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">28</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121830_0_v0"
                                    onclick="loadShifts('121830_0_v0', '1259067069_03.02.2026', 1662, '03.02.2026 08:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121830_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-121830">
                        <div data-vehicle-uid="121830_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">С299ОА72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Mercedes-Benz Actros 3346S</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">77.8 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">2.8 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">12.3 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">9.5 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">72.5 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">28</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121830_0_v0"
                                    onclick="loadShifts('121830_0_v0', '1259067069_03.02.2026', 1662, '03.02.2026 08:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121830_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="121954 1259066309 У945ТХ72 С/тягач КамАЗ 53504-50" data-date="01.02.2026" data-number="121954" data-start-addr="Линево" data-end-addr="Линево" data-cost-obj="Создание ВСМ Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 3 Этап. Основные работы – Стр-во уч. Валдай ВСМ. Новгородская обл.">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('121954', this.querySelector('.copy-btn'));">
                                Заявка №121954
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">Линево</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Линево</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+7</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '121954', 'Линево', 'Линево', '01.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">01.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">15.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">205.3 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">3ч 36м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 15</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Создание ВСМ Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 3 Этап. Основные работы – Стр-во уч. Валдай ВСМ. Новгородская обл.</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-121954">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-121954">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-121954" value="1" min="1" onchange="updateCalcPlan('121954')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-121954" value="15" min="1" onchange="updateCalcPlan('121954')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-121954" value="205" min="1" onchange="updateCalcPlan('121954')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-121954" value="65" min="10" max="120" onchange="updateCalcPlan('121954')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-121954" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('121954')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-121954" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('121954')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-121954" value="01.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('121954')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-121954" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('121954')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-121954">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-121954">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-121954">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-121954">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-121954">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-121954">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259066309</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 04.02 08:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">У945ТХ72</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-121954"></div>

                    <div id="map-121954" class="map-container active">
                        <div class="map-data"
                             data-polyline="al_aJ}{slEqC{AcCs@{CcB{IgGoAaA{A}ASdAc@lFY~EWw@cAqAe@}@yBsJoB_GkAiB_AcCm@uB]aC[uDWwA[u@eAiAeGgEeBkBwBwCoA{BkCqGeBqDsHwPs@kB[mAoAeH]uAWq@cBsC{CyGqC}HuA{Eq@sBk@iAu@_AyBqB{AcBsAgAcBeAaC{@wB[}Fi@aEU}@_@g@g@o@cAy@iAmB_BkFkDsDqCmEaGcFmKsGiOyFgLsAaEcAcF_@gCS{BEsGR}Bn@cD`A_D^yBXoDXaC~BeJXaC^aKAqBQaBaGqVW_BUkE[qODiC\_HBcCE_CQeB[iBkAqJGeBNuGMuA[o@aE}EaFwFWc@Sm@eAoGi@wCU[?eBv@yOLkD?uBGiBCgFNkVMoG[uDe@sDkA_FsAuGQqBEyB@iBHiBh@eD|@kEfAmEZ}@rAcDdGgKx@{ArDiI|KmXhBgDhAcBz@y@pHcG~E_FtEcFhDsCnJcH|MyLrByB~@sA`AaBz@}AbDwG|JaUp@oBrAqFnFgUhC{Jb@mAb@aAhCcEvE}HzBgDnA{Br@eBjAwD\gBxIwg@fL}m@hEaVhB_QPmAd@cBrBiEzCeGpAmBvA_BnB_B`NgJxB_BnBaBlBqBxBoC|NuS|NgTtC{DpOiUx@aB\cAj@cCfCkLn@sDT}AVsBPuBJ{B@uAEeAYaD{AiKsI}f@WqCKyBK_EMsNOuAaEkOo@eBuAiE_@}AScBGaAC_ADq@VY~CgCpA}AjAwBrNoK\m@z@uBjBmCRc@DWCm@[eAu@qBwAcD[SaBiFsCsGmAiCgHkL}EiH_BaBmB{AeE{C{A_AwAs@{GqBoDyCqFyEcAoA_@s@qCuIcAkDk@mCKs@Aw@JuC`AgM\wCdDaQlAcGt@wELgAVuDf@{Ib@uEZmBXcA\_AZeA`@kBnCwQzBaNfLko@xFo\|AeK~AoIl@yBbA}C`FcLfD_JdAcD~AwG`BwHd@_Df@oHLcAf@uBp@eBhJgTvIeTrHwPlAcDdCcJtA_Gb@sCJeAJoA~@mTPkCVeD\cDjAsIPqBJyCHuG`@}QhAyp@DoEAgDI{BIiAQgBqBqLSaBY{E}A_n@g@iZMmLBcDN{CX{Dr@mHrAsKRyBFsBBiBCuBKuCScEoAqPGuAAkAD_DVyCZaCb@kAtEgKl@{A\eAXiAT}AP_BPgCJaCD}BBwHDkGDcB^}DRy@X_Ab@iArJkSrAkDdB}Ev@qBd@_A`@m@r@{@pCuB`JuD\]r@aAnIsPf@u@f@k@d@_@b@SzA]rAEzDJbDOnD[vBYtEiA|B[fAAdAJpAThI|CjFdBzAl@xG~B|@d@`Av@|@`AjClErEfIdAnArApA|ChB~PpGbEdBtBvAnEhDhCrAlBX|LTfLc@tKY|f@y@nHI|DKv@Ip@KlCw@xLcEnNqE~`@cMhAU`B?|Af@nSpHvDjBn@P\ARIlAw@nB{ApGwF~@k@hA_@r@Cl@RjF~Cz@bGnEne@ZbBNn@d@tA\r@V\~@r@dAf@hLfEjAn@bBzAj@t@j@lAzAbEdDlKnE|OdCdLHRPJHClAoAx@s@r@QlA?\IfBsBhGmIhCeELGNJ\j@`BhEh@dA~DzGhDpFxIdMJVD`@Aj@EVo@zB[x@AZFZbMnQ\p@p@|AhBmCX[\YlJ_CbAg@dA{A`AmBf@eAL]bAgHX_Cx@l@lEnCdChBxKbH`Ad@hFxCnJ~ErF`DhHrD`DdA|H~EjBp@tRtDpEf@p@?f@Kj@Wp@m@rB}Bx@cAd@a@~FiDlE_ChEiCd@O|@GdAFbIlA`Dv@dA`@ZRj@f@pE~Fh@j@|BlAlIdDjgBro@lUxId@`@\z@T~@Jx@Tr@Xd@f@Tf@Ad@]\q@RcADkAGiASaAQwAGqBr@}GRwAP{@Vy@Zs@p@cAh@_@l@Ud@Ef@FvAx@|AlB~GvH|EvDlArBZ~@XnAV`CDvBKjCWlBk@dBo@hAeAx@wBjAis@tYiu@lZeu@~[c~@la@qcCzfAePjIoHdEcI~EuIxFwLzIeN`L_I`HsG`GqHnHsHbIoSvUkMnP}MrRaNzSiIdNgIzN}I`QcJ~QcRhb@gGnOaHxQ}Svn@wHvVqHlXsH|YyHb\oEbTmEtTkI|d@cIpg@qJvn@wDhVeExV}H`b@}Ija@_AbEyHxZkKv_@oHlVcIhVwGpQiHhRmJ|TuMbZcNxWyJ~PoQ|YsbAdcB{`BjpCiSj^wXlg@ye@t}@yo@hkA{o@rlAos@brAoVnb@eRhZgOjUmLzPuLrP_MpPiMhPe\l`@_Z`\eUjUsU`UkRhPiStPyS~Osc@n\{z@xo@ce@t]yRhPaJrIaEhEkKrLqO~R{C`EmLpQoEnHqGbL_K~R_nAbeC{EjKyMtZiJrUaKtXyHpUkJfZuApE{Kba@y[hlA_Llb@oi@dqB__AjpDeGlScCxHsC~H_InRoIpQgEtHsEvHwEbHwElGeFhGyGhHsHbHoIvGmLnIwMlLgFnF}EzFyGpIgHhKqD`GqDrGqIbQmVzk@_CfFsDfHk@~@o@d@w@Ps@DkBUqHmB}@Ei@Ho@Pg@^c@d@i@x@i@xAYpAe@lDeAzLgB`RYpBk@rBq@vAm@~@W?GCIMGSGe@@oACs@Is@hAiAl@}Ad@aCPkC?cEg@yCgAgDqAqEoB_IwBmJs@gFa@yE[yGWoEMmFVeMrCyNxGmc@Fw\z@k\m@y[hAyPOcJC_ILuFd@_GdA_Kv@cHtAeFr@gAhAi@|BCrBg@lAyEz@_E?kHUwLl@}LdH}YrFiSzAuEnHsIfIcIpDaFjDuF|M_RpDeGzCkHnCwHfHkOlCiJpB{KzBqKdCsJdDeJhAiCnByDtCwBlCcBt@q@tA{Cj@oDrC}Vf@GrCcB~@SpACx@QdP{FpInB|HhNnMhVvIlEnGl@rKdEzIjFl@`Ns@pReCtWvC`|@j@vGj@nDxBjDzHvH~GtF~CpC~BdCjJjLTb@n@p@rOnKlF|A|DN|PrIjRjDrAz@sA{@kRkD}PsI}DOmF}AsOoKo@q@Uc@kJkL_CeC_DqC_HuF{HwHyBkDk@oDk@wGwCa|@dCuWr@qRm@aN{IkFsKeEoGm@wImEoMiV}HiNqIoBePzFy@PqAB_ARsCbBg@FsC|Vk@nDuAzCu@p@mCbBuCvBoBxDiAhCeDdJeCrJ{BpKqBzKmChJgHjOoCvH{CjHqDdG}M~QkDtFqD`FgIbIoHrI{AtEsFhSeH|Ym@|LTvL?jH{@~DmAxEsBf@}BBiAh@s@fAuAdFw@bHeA~Je@~FMtFB~HNbJiAxPl@x[{@j\Gv\yGlc@sCxNWdMLlFVnEZxG`@xEr@fFvBlJnB~HpApEfAfDf@xC?bEQjCe@`Cm@|AiAhAHr@Br@AnAGv@Sb@ONMXI^Cb@@b@F`@JZNPPHR?v@Pj@xBx@vDpCbPvCnUbBzJ`CvKfCrJhGnSl@tC\~C~@jW`@`FvGz`@`FdXbNlQxArDrAxEhPry@jAbFjAfDfG|KpArD`BtL~@lCzRjXpBzAfEPvA[bJsHtB}@vB]|Jj@nC^vAt@rP|UzKnF|LfVnChC`UhPfZ~P`DnDz@`Bp@`CnExW~@xK\rBf@rBj@dB`A|ApBdCvD~DpFzJ|CnGdCrD`BrB|IfIfD|FpAjDf@xAnD`MdAfCfZ|l@zA`EhPrpAn@rG@pGGfJ_H|iACjDrBnXDbDI|CkAbO[zFs@vRI`HZlHZlDf@|Cr@dC~@vBzHtLvEzHfDfFhBbBvBvAnBr@fWbElEx@zDpAzLlL~AdAjCjAd@JpKInB^lFfBpAFrA]pe@uWlAc@nAKtBRn@TnCvAz@r@h@p@`@l@`B`EThAVbBT`DLvEThN^fGb@`CdEfPtC`OnAfDjAvBx@bAfEpDxD~AfB|AhJdP~A|B|A|@rBXvMo@bBXjD~AlHnElBh@dB?rAYzD_CbAmAt@qA|C_JhBmChDgBnD_BrBa@dCXtBfAhBTnHK`FC~ASh@OjA{@j@q@`AiBtA_Dr@gAh@k@|@s@j@[hA_@tZyIzBg@zAS|AGnKPrDk@pFyBrJmH`Cu@|B@lCi@pKyE~BUjG?xEbArBN|HgEzBkClA{BfF}QfBqBzAiAzFqAl[kLtBiAjFkFlBaA|JwBnCCxAj@rB|AdSxM`AtAlDvJr@nEbAfPzA`IiE`P_@lDOzEPtFj@xH`AhGtAfDhDdFvB`EfB~Ff@fCx@xF~J`}A^vKEtG]nHaDdTi@~FI~GlCndAlAnOnNtiAn[hnAxQvfAvD`LpQt]rLbRr]vl@hA~ApA|AzKrL\Xp@T\@`@CdC]\?h@JVPZ^R`@bF|Nv@dBh@r@zJpKlA`BtAvBrSh`@xLrO~]tYfNgpAJkA~@cIxIix@fIgv@zBgNf@mBj@kC~@}C`AoChAoC~CuFps@yiAfBsCdG{IzBkDbMwR~BwD|HuLrRyZdWkb@l^kk@zE}H`DgGnCgGtBiFvBuG~AuFbBwG~AiHfA{FvAaJ~@yGh@iEv@uH^uEVuDVsETcFxAi`@dKyqC`EobAr@qTlAqZ|@uWjFswAtAg[jAiVjDc{@fE}hAV_Iz@sZ\wJ~MatD|RsgFl@kQb@oJpC{q@~@oWrE}iAjQ{sEhHagBvPknEdQwvE\oJJqEFiF?kIGwLMsd@@iF\mFNcB\eCh@sCv@_DkBoBcAuAaCcCM]Ia@@i@Hk@~CuOh@iDDmDa@{c@PcCZaBEoKUcC}@oBeJkJaDiCmCe@iCE_BRiCk@sFqCgE}AkCq@aCuAeRqPiIqGgGuIgLcKmFiCqFeDqEkBmF{@aCuAeDwAgHXmF_E}ImEiYej@aGcQiKeOqBmDwAuDwCuEwHqHgCgDm@sA_@i@iCyFeB_E}CoFc@]Y?YLmAbA_BVyCFeAJqDfAs@HcCg@yCcAsCiBuMeKcDkDkC{CcCgDm@w@_BaCcBuCgCiG_@[mIaBk@Wu@y@mAiBy@cBkCsGiC_IqA}Fw@aDu@cBiAuBkEuHy@mByDwOgIwWqAyDcAmDoAuDq@kAsA}AkA}@mAa@q@g@k@yAeCgHqFcKsE_EqGuEkB{A{@qAMkAEmAFgE?c@UeA_@i@w@}Aw@eAaA_@kBg@}BcBmCwA"
                             data-route-points="[{&quot;lat&quot;: 58.00154907522012, &quot;lng&quot;: 33.69369506835938, &quot;address&quot;: &quot;Линево&quot;, &quot;date&quot;: &quot;01.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 58.007415690858345, &quot;lng&quot;: 33.694896697998054, &quot;address&quot;: &quot;Линево&quot;, &quot;date&quot;: &quot;01.02.2026&quot;, &quot;time&quot;: &quot;11:00&quot;}, {&quot;lat&quot;: 58.007415690858345, &quot;lng&quot;: 33.694896697998054, &quot;address&quot;: &quot;Линево&quot;, &quot;date&quot;: &quot;01.02.2026&quot;, &quot;time&quot;: &quot;14:00&quot;}, {&quot;lat&quot;: 58.14546890615111, &quot;lng&quot;: 33.52651834487916, &quot;address&quot;: &quot;Сухое&quot;, &quot;date&quot;: &quot;01.02.2026&quot;, &quot;time&quot;: &quot;17:25&quot;}, {&quot;lat&quot;: 58.00153770487646, &quot;lng&quot;: 33.6937165260315, &quot;address&quot;: &quot;Линево&quot;, &quot;date&quot;: &quot;15.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-121954">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-121954" checked onchange="toggleParkings('121954')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-121954" value="0" min="0" onchange="updateMapFilters('121954')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-121954" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-121954" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-121954" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-121954" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('121954')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('121954')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="121954_0_v0" onclick="selectVehicleV2('121954', '121954_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">У945ТХ72</div>
                                <div class="vehicle-selector-name">С/тягач КамАЗ 53504-50 · ПЛ 1259066309</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-121954">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">У945ТХ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач КамАЗ 53504-50</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">44.5 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">1.5 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">8.0 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">6.5 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">59.4 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">14</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121954_0_v0"
                                    onclick="loadShifts('121954_0_v0', '1259066309_03.02.2026', 5226, '03.02.2026 08:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121954_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-121954">
                        <div data-vehicle-uid="121954_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">У945ТХ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач КамАЗ 53504-50</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">44.5 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">1.5 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">8.0 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">6.5 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">59.4 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">14</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-121954_0_v0"
                                    onclick="loadShifts('121954_0_v0', '1259066309_03.02.2026', 5226, '03.02.2026 08:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-121954_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122058 1259047103 Х998ТА86 С/тягач Volvo FM Truck 6х4" data-date="01.02.2026" data-number="122058" data-start-addr="80К-026 Стерлитамак — Белорецк — Магнитогорск, Стерлитамак" data-end-addr="проспект Братьев Коростелёвых, 181, Оренбург" data-cost-obj="Реконструкция мостового перехода через реку Сакмара (верхового) на проспекте Братьев Коростылевых в городе Оренбурге (АВТОБАН ДСК АО)">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122058', this.querySelector('.copy-btn'));">
                                Заявка №122058
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">80К-026 Стерлитамак — Белорецк — Магнитогорск, Стерлитамак</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">проспект Братьев Коростелёвых, 181, Оренбург</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122058', '80К-026 Стерлитамак — Белорецк — Магнитогорск, Стерлитамак', 'проспект Братьев Коростелёвых, 181, Оренбург', '01.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">01.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">28.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">245.1 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">3ч 24м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 10</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">груз сборный</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">75.0 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Реконструкция мостового перехода через реку Сакмара (верхового) на проспекте Братьев Коростылевых в городе Оренбурге (АВТОБАН ДСК АО)</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122058">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122058">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122058" value="1" min="1" onchange="updateCalcPlan('122058')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122058" value="10" min="1" onchange="updateCalcPlan('122058')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122058" value="245" min="1" onchange="updateCalcPlan('122058')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122058" value="65" min="10" max="120" onchange="updateCalcPlan('122058')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122058" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122058')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122058" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122058')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122058" value="01.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122058')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122058" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122058')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122058">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122058">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122058">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122058">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122058">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122058">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259047103</span>
                                <span class="subheader-pl-dates">03.02 10:00 → 03.02 22:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">Х998ТА86</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122058"></div>

                    <div id="map-122058" class="map-container active">
                        <div class="map-data"
                             data-polyline="abmfIyaxtI`FoCn@gB~@yAWzHqBte@OpBc@jCu@|Bu@tAeAjAaB`A{Bh@q@XsA|@mGhLb@z@Rp@TnAHj@BlA?hBBjAhEfTZhBJ~AB~@\jF`AbJJ\|@zAZZxIlGtJxAjJ`AlLp@dM\|FJ~H~@~Cf@|ANhOjC`HjH|BfCpGcVxCoMfCaKjLxLvB~BRLdQzQle@df@`HnHlIpIhI~E\?RSPe@RqAL]^_@bFgBb@K\AjFV~ENnCb@z_A|FlJb@lA?zB}@pAu@pKeHdEiCtGqEfBgBxBkDpL{S|EuJjJmSzBoB|@]t@St@Gr@BfXrJdNlFve@dZ~G~E|QrOfApAj@|@vAzCpSra@lEbIlZfh@j@v@t@v@^^fAl@lQ`Gpa@dMdD|@v_@jLtD`AlIlC~d@hNvx@~UzJnCjBp@fGjBdQ`Ftr@`T~^hLrBd@~D^ve@|CdFb@|c@|CbBNrARnAXb@PnA`AjXhVz@p@fAp@hAf@bB\trAfMpHUjBUxPo@jG_@pBSfASr@[vEgCdDyAfKuF|PuJ`EsBtI_FfLeGlLwG`NqHzg@kXh@Sr@AxALlDb@|dAzO~En@hBPz[n@fh@t@~IFjN\zNh@z_AxApGRx\bBp@Pn@d@DLTV^HXBVGhBgAPC`o@`DnClA|BfCfEfInClG~E|JjAxB|@xBfAjBn@h@v@Vv@B|MGzHMxA?`BDfKz@lMd@pEHzZBhA^~@`Az@dAp@jAl@r@z@r@n@XfABb@Gj@Ur@w@jA_Cp@eBTc@LOx@[lB?nMOpKGx@@fB^`JjEdBt@t@PjALpVl@|AXrB`ArDrAhHZjCMbKaCnt@nApDLhDq@xAiBhH{KnNaXhQk[~EmHdBcAjB_@de@El@lB|Au@fCw@`FO~e@GbPz@th@rDveD|U~HnAne@dJnhBf\nLrBnAH`CHf^oKpQ_G~TgHvAMjLlBjHlBtH|BxTlGje@rN|TtGh]~Ixp@nPja@xJrDTvE?vGHx@Xn@dA|@|Bh@r@pA^fmBbI`ZbAnoD_HhDOzB_@fCs@pDcBfjBaoA|F}BdG{AnEs@pg@Urt@tFzV]hpA_DvEBjEV~i@bFh[|CrBFlACzAY~x@w^vUkFnDi@n^wD`EWdNfAhHr@xGvBdAf@xAz@xBhBt@~@|@tA|F|KrH`O~CdIjBpFhAxEbBpKrEr]hA|FrAjFbBvExBhFfCpEjDhExCbCfC`BhD~AbD~@xO~C|T~D`QxBdUtA`eBrInSI|z@yAjTQ|CZvFbBhB|@lBp@lMnFd}C`oAvBnApFjEhs@xo@lPpOfGnF`ChBnBlArBdAjBr@jEbAtBP`CCtBe@tBu@|DoBrA_AhAcAlAqAhAeB`CgEfk@qeAps@msAlFsJxByCpC_DvC}BvDeBjKgDnEkBvFmCpHyEjDeCnCaC`FyFvBqCdBoCdUcb@lB}BtAqA`BkA~Y}ObW{MlFiBjV}Hvk@{RvZ_KbCe@nCIjBPdJfBpcAtSxCr@fIlCjIbDtInDxJxDhAdAdBxB|JjNx@z@rAbAj_Aze@zAz@nDjCrBnBhrD`cEhXvb@hLpQnO`UlAzA|CpAjARtCVjPl@hNX~F_BjAa@fAu@dA_AhAwAbAqBr@mBn@mCt@qF|@kO`BaMdCcItGaLtFcL`CuDnDkDhDoBtEoAxGcAxGUpIrAxJtBfIzC|NpIzJhGjJnHdJfItEbFrDfGnEvIfCvFlFrHpI|DhPjHjCpA~GtCjBb@~~@`Jng@dFrl@lF`h@dFzTfCjABpAQpJkBfCa@`JkB~J_CnKmChLcDdTwFjn@}PnAQh@Cr@BlAVbAj@v@z@l@dAVn@t@`C|Krd@|@xCh@xArGjPnXrs@`AnB~KdQxEzHnAfBvAvA|BjBn@^p@\fBp@nAZxATvBRhABp[HpGAfBQrAe@pAu@`As@nCyCvL}OvA{Az@o@|@k@bA_@tBc@np@cKlDo@|CShB?jN`@fCEpBMlQwDh]{H~Da@dEMvLl@`KDrHk@pEs@v^}Gt_@oDrWkB`h@wCxFi@tFy@hTwEdQgDlRmBpCWr@AxB`@hrAjb@t_@`KjwBbd@tv@~Jdw@hInSrAvrBzOj\nCx`Aj@hMRlX|@`FElEk@lf@yHtBKp@DlAR~Af@xDhCbCrAdA^pBTvAC|@OfBg@pRsHvCcAfBi@dAUdAMbA@~@L`AV`A`@dAh@p@f@zAdBh@x@d@~@xKzY|FxOzBnFtBdEhDlFlTxZ|c@dp@tr@dbAlE|FpBrB|BlBjBnAjCpAdDnA|Ct@tZvF`D~@`Bn@zBfAlC~AhCxBbBfB|BzClBnCzCvFjItPjTvd@pJ~Rb@fAx@rBd@xAjA~E`t@ziDvZb_BrH|`@rFrXvM~o@f\~~ApWlnAtRz|@pEdSbPbq@fKpc@fXphA`p@noCbEtPpfAbqErGtXlA|EpsBrtIdAbEfEnQdBdHjDhOxLpg@bFhSzDxM|GnTvFzPrl@pjBps@l{Bz]rfApP`i@jGvQdGnOxDfI`\~o@zWbi@tFfLjXji@xVbf@vVve@jJzP~Z~i@bPvXrElHjOvTdApAp_@ni@xl@fz@f_@`h@tlC|uCrGjHpHhHvF|EdGrE~DnCxDxBdErBlJfEvFxBlRjF~FhBtD|AfD~A`CzAjChBpB|AjB`BlErE~D`Ffa@ni@lYp_@rH|JjMnPbRnVdEfFjF|E|FzDvGtD`FrBzDjA~Cz@dBzA\l@Pd@Ln@Dh@@f@Ar@Gt@Kt@Sv@[|@fEaDrAu@pCkAbBg@jBYzD]`@K~GVhGNnDNbHNrDXbCZroC|b@duB`\tsCzc@fDt@t@\nAXhDh@n@Bj@EtBT~Ez@lDr@pzBno@b~@|Wpm@`Q~R|F~QhFp[nJ`XnHr^vK~GtCtFvDhDpCfDxC|BbClChDxC~D`DnFfCtEnAjCfBhE`BnEnJlZnC`JxClJlQjk@lGxSb@zBdAzDrAnEt@tBz@nBjHfT`AbCvDtIxBdEvAbCxCvEdCdDrCbDdBdBvCfCvBbBvAbAdCzAfE|BnmAzl@fc@nTbq@j\hAf@rCbAfDx@nFdAxARnWzBza@vD`Cb@fDt@`Cn@zGlC|DvBdDzBdDbC|BrBvBxB`DtDvBnC~FlJ`DhGp_@n}@bIvRbBvD`LhX`HdPnJjU|Stf@zZht@lUpj@fHpPxDrIxDtHnGhKxBbDzXf_@tNvRp{DfmF~l@tx@nK~NnFfHtDfE|DtDPn@f@nAb@vA^rALlAH`BB|AE~AIfAS~BhAmCxBqHvEgNhBqE`CsFtDaI~LiVhKeSr@{ArCoF|DmGzD{GhFiKbCkFlAwCnc@m{@`i@giAxFkMpCsFpAsB`AsAh@m@~BgBtAq@bBm@pAWrCSjGBnIHxG`@xK@vAGzHC~L@BpBJpBRtB~@dH|@|Ft@tCp@nBt@dBT^l@f@b@VXHj@@XOd@u@|DiJdLwV^i@b@_@h@WjAYl@Cl@Fz@T\TvBlD`GvKrG|KhR|ZvQhYr@jAVj@mCjG}EhKOb@@`@Vr@hBxCHRDZFfKAlYBjAHTf@XJJHXB`@@bBCbBK|@o@`DyA~EgBhFiH|U}@jDEZoBtIMjAb@p@pDhDpKhLFr@Ap@a@lCNVxAdApBjAnBj@zBd@bACjC{Ad@OZDR\ZvB^xAv@xBfAnDhAdEhJb\jDfMrClJjBlEhDhHh@n@n@RfBFbAIn@O|@k@t@m@Jp@?l@Kh@C^g@xBMNKd@KR?f@"
                             data-route-points="[{&quot;lat&quot;: 53.64763969412718, &quot;lng&quot;: 55.99652291325584, &quot;address&quot;: &quot;80К-026 Стерлитамак — Белорецк — Магнитогорск, Стерлитамак&quot;, &quot;date&quot;: &quot;01.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 51.81280767841902, &quot;lng&quot;: 55.04696011658667, &quot;address&quot;: &quot;проспект Братьев Коростелёвых, 181, Оренбург&quot;, &quot;date&quot;: &quot;28.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122058">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122058" checked onchange="toggleParkings('122058')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122058" value="0" min="0" onchange="updateMapFilters('122058')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122058" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122058" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122058" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122058" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122058')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122058')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122058_0_v0" onclick="selectVehicleV2('122058', '122058_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">Х998ТА86</div>
                                <div class="vehicle-selector-name">С/тягач Volvo FM Truck 6х4 · ПЛ 1259047103</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122058">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">Х998ТА86</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="no-data">Нет данных мониторинга</div>

                            <button class="shift-load-btn" id="shift-btn-122058_0_v0"
                                    onclick="loadShifts('122058_0_v0', '1259047103_03.02.2026', 708, '03.02.2026 10:00:00', '03.02.2026 22:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122058_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122058">
                        <div data-vehicle-uid="122058_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">Х998ТА86</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="no-data">Нет данных мониторинга</div>

                            <button class="shift-load-btn" id="shift-btn-122058_0_v0"
                                    onclick="loadShifts('122058_0_v0', '1259047103_03.02.2026', 708, '03.02.2026 10:00:00', '03.02.2026 22:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122058_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122063 1259047118 К648АА186 С/тягач VOLVO FM-Truck6х4" data-date="01.02.2026" data-number="122063" data-start-addr="80К-026 Стерлитамак — Белорецк — Магнитогорск, Стерлитамак" data-end-addr="проспект Братьев Коростелёвых, 181, Оренбург" data-cost-obj="Реконструкция мостового перехода через реку Сакмара (верхового) на проспекте Братьев Коростылевых в городе Оренбурге (АВТОБАН ДСК АО)">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122063', this.querySelector('.copy-btn'));">
                                Заявка №122063
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">80К-026 Стерлитамак — Белорецк — Магнитогорск, Стерлитамак</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">проспект Братьев Коростелёвых, 181, Оренбург</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122063', '80К-026 Стерлитамак — Белорецк — Магнитогорск, Стерлитамак', 'проспект Братьев Коростелёвых, 181, Оренбург', '01.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">01.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">28.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">245.1 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">3ч 24м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 18</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">груз сборный</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">75.0 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Реконструкция мостового перехода через реку Сакмара (верхового) на проспекте Братьев Коростылевых в городе Оренбурге (АВТОБАН ДСК АО)</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122063">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122063">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122063" value="1" min="1" onchange="updateCalcPlan('122063')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122063" value="18" min="1" onchange="updateCalcPlan('122063')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122063" value="245" min="1" onchange="updateCalcPlan('122063')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122063" value="65" min="10" max="120" onchange="updateCalcPlan('122063')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122063" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122063')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122063" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122063')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122063" value="01.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122063')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122063" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122063')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122063">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122063">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122063">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122063">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122063">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122063">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259047118</span>
                                <span class="subheader-pl-dates">03.02 10:00 → 03.02 22:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">К648АА186</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122063"></div>

                    <div id="map-122063" class="map-container active">
                        <div class="map-data"
                             data-polyline="abmfIyaxtI`FoCn@gB~@yAWzHqBte@OpBc@jCu@|Bu@tAeAjAaB`A{Bh@q@XsA|@mGhLb@z@Rp@TnAHj@BlA?hBBjAhEfTZhBJ~AB~@\jF`AbJJ\|@zAZZxIlGtJxAjJ`AlLp@dM\|FJ~H~@~Cf@|ANhOjC`HjH|BfCpGcVxCoMfCaKjLxLvB~BRLdQzQle@df@`HnHlIpIhI~E\?RSPe@RqAL]^_@bFgBb@K\AjFV~ENnCb@z_A|FlJb@lA?zB}@pAu@pKeHdEiCtGqEfBgBxBkDpL{S|EuJjJmSzBoB|@]t@St@Gr@BfXrJdNlFve@dZ~G~E|QrOfApAj@|@vAzCpSra@lEbIlZfh@j@v@t@v@^^fAl@lQ`Gpa@dMdD|@v_@jLtD`AlIlC~d@hNvx@~UzJnCjBp@fGjBdQ`Ftr@`T~^hLrBd@~D^ve@|CdFb@|c@|CbBNrARnAXb@PnA`AjXhVz@p@fAp@hAf@bB\trAfMpHUjBUxPo@jG_@pBSfASr@[vEgCdDyAfKuF|PuJ`EsBtI_FfLeGlLwG`NqHzg@kXh@Sr@AxALlDb@|dAzO~En@hBPz[n@fh@t@~IFjN\zNh@z_AxApGRx\bBp@Pn@d@DLTV^HXBVGhBgAPC`o@`DnClA|BfCfEfInClG~E|JjAxB|@xBfAjBn@h@v@Vv@B|MGzHMxA?`BDfKz@lMd@pEHzZBhA^~@`Az@dAp@jAl@r@z@r@n@XfABb@Gj@Ur@w@jA_Cp@eBTc@LOx@[lB?nMOpKGx@@fB^`JjEdBt@t@PjALpVl@|AXrB`ArDrAhHZjCMbKaCnt@nApDLhDq@xAiBhH{KnNaXhQk[~EmHdBcAjB_@de@El@lB|Au@fCw@`FO~e@GbPz@th@rDveD|U~HnAne@dJnhBf\nLrBnAH`CHf^oKpQ_G~TgHvAMjLlBjHlBtH|BxTlGje@rN|TtGh]~Ixp@nPja@xJrDTvE?vGHx@Xn@dA|@|Bh@r@pA^fmBbI`ZbAnoD_HhDOzB_@fCs@pDcBfjBaoA|F}BdG{AnEs@pg@Urt@tFzV]hpA_DvEBjEV~i@bFh[|CrBFlACzAY~x@w^vUkFnDi@n^wD`EWdNfAhHr@xGvBdAf@xAz@xBhBt@~@|@tA|F|KrH`O~CdIjBpFhAxEbBpKrEr]hA|FrAjFbBvExBhFfCpEjDhExCbCfC`BhD~AbD~@xO~C|T~D`QxBdUtA`eBrInSI|z@yAjTQ|CZvFbBhB|@lBp@lMnFd}C`oAvBnApFjEhs@xo@lPpOfGnF`ChBnBlArBdAjBr@jEbAtBP`CCtBe@tBu@|DoBrA_AhAcAlAqAhAeB`CgEfk@qeAps@msAlFsJxByCpC_DvC}BvDeBjKgDnEkBvFmCpHyEjDeCnCaC`FyFvBqCdBoCdUcb@lB}BtAqA`BkA~Y}ObW{MlFiBjV}Hvk@{RvZ_KbCe@nCIjBPdJfBpcAtSxCr@fIlCjIbDtInDxJxDhAdAdBxB|JjNx@z@rAbAj_Aze@zAz@nDjCrBnBhrD`cEhXvb@hLpQnO`UlAzA|CpAjARtCVjPl@hNX~F_BjAa@fAu@dA_AhAwAbAqBr@mBn@mCt@qF|@kO`BaMdCcItGaLtFcL`CuDnDkDhDoBtEoAxGcAxGUpIrAxJtBfIzC|NpIzJhGjJnHdJfItEbFrDfGnEvIfCvFlFrHpI|DhPjHjCpA~GtCjBb@~~@`Jng@dFrl@lF`h@dFzTfCjABpAQpJkBfCa@`JkB~J_CnKmChLcDdTwFjn@}PnAQh@Cr@BlAVbAj@v@z@l@dAVn@t@`C|Krd@|@xCh@xArGjPnXrs@`AnB~KdQxEzHnAfBvAvA|BjBn@^p@\fBp@nAZxATvBRhABp[HpGAfBQrAe@pAu@`As@nCyCvL}OvA{Az@o@|@k@bA_@tBc@np@cKlDo@|CShB?jN`@fCEpBMlQwDh]{H~Da@dEMvLl@`KDrHk@pEs@v^}Gt_@oDrWkB`h@wCxFi@tFy@hTwEdQgDlRmBpCWr@AxB`@hrAjb@t_@`KjwBbd@tv@~Jdw@hInSrAvrBzOj\nCx`Aj@hMRlX|@`FElEk@lf@yHtBKp@DlAR~Af@xDhCbCrAdA^pBTvAC|@OfBg@pRsHvCcAfBi@dAUdAMbA@~@L`AV`A`@dAh@p@f@zAdBh@x@d@~@xKzY|FxOzBnFtBdEhDlFlTxZ|c@dp@tr@dbAlE|FpBrB|BlBjBnAjCpAdDnA|Ct@tZvF`D~@`Bn@zBfAlC~AhCxBbBfB|BzClBnCzCvFjItPjTvd@pJ~Rb@fAx@rBd@xAjA~E`t@ziDvZb_BrH|`@rFrXvM~o@f\~~ApWlnAtRz|@pEdSbPbq@fKpc@fXphA`p@noCbEtPpfAbqErGtXlA|EpsBrtIdAbEfEnQdBdHjDhOxLpg@bFhSzDxM|GnTvFzPrl@pjBps@l{Bz]rfApP`i@jGvQdGnOxDfI`\~o@zWbi@tFfLjXji@xVbf@vVve@jJzP~Z~i@bPvXrElHjOvTdApAp_@ni@xl@fz@f_@`h@tlC|uCrGjHpHhHvF|EdGrE~DnCxDxBdErBlJfEvFxBlRjF~FhBtD|AfD~A`CzAjChBpB|AjB`BlErE~D`Ffa@ni@lYp_@rH|JjMnPbRnVdEfFjF|E|FzDvGtD`FrBzDjA~Cz@dBzA\l@Pd@Ln@Dh@@f@Ar@Gt@Kt@Sv@[|@fEaDrAu@pCkAbBg@jBYzD]`@K~GVhGNnDNbHNrDXbCZroC|b@duB`\tsCzc@fDt@t@\nAXhDh@n@Bj@EtBT~Ez@lDr@pzBno@b~@|Wpm@`Q~R|F~QhFp[nJ`XnHr^vK~GtCtFvDhDpCfDxC|BbClChDxC~D`DnFfCtEnAjCfBhE`BnEnJlZnC`JxClJlQjk@lGxSb@zBdAzDrAnEt@tBz@nBjHfT`AbCvDtIxBdEvAbCxCvEdCdDrCbDdBdBvCfCvBbBvAbAdCzAfE|BnmAzl@fc@nTbq@j\hAf@rCbAfDx@nFdAxARnWzBza@vD`Cb@fDt@`Cn@zGlC|DvBdDzBdDbC|BrBvBxB`DtDvBnC~FlJ`DhGp_@n}@bIvRbBvD`LhX`HdPnJjU|Stf@zZht@lUpj@fHpPxDrIxDtHnGhKxBbDzXf_@tNvRp{DfmF~l@tx@nK~NnFfHtDfE|DtDPn@f@nAb@vA^rALlAH`BB|AE~AIfAS~BhAmCxBqHvEgNhBqE`CsFtDaI~LiVhKeSr@{ArCoF|DmGzD{GhFiKbCkFlAwCnc@m{@`i@giAxFkMpCsFpAsB`AsAh@m@~BgBtAq@bBm@pAWrCSjGBnIHxG`@xK@vAGzHC~L@BpBJpBRtB~@dH|@|Ft@tCp@nBt@dBT^l@f@b@VXHj@@XOd@u@|DiJdLwV^i@b@_@h@WjAYl@Cl@Fz@T\TvBlD`GvKrG|KhR|ZvQhYr@jAVj@mCjG}EhKOb@@`@Vr@hBxCHRDZFfKAlYBjAHTf@XJJHXB`@@bBCbBK|@o@`DyA~EgBhFiH|U}@jDEZoBtIMjAb@p@pDhDpKhLFr@Ap@a@lCNVxAdApBjAnBj@zBd@bACjC{Ad@OZDR\ZvB^xAv@xBfAnDhAdEhJb\jDfMrClJjBlEhDhHh@n@n@RfBFbAIn@O|@k@t@m@Jp@?l@Kh@C^g@xBMNKd@KR?f@"
                             data-route-points="[{&quot;lat&quot;: 53.64763969412718, &quot;lng&quot;: 55.99652291325584, &quot;address&quot;: &quot;80К-026 Стерлитамак — Белорецк — Магнитогорск, Стерлитамак&quot;, &quot;date&quot;: &quot;01.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 51.81280767841902, &quot;lng&quot;: 55.04696011658667, &quot;address&quot;: &quot;проспект Братьев Коростелёвых, 181, Оренбург&quot;, &quot;date&quot;: &quot;28.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122063">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122063" checked onchange="toggleParkings('122063')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122063" value="0" min="0" onchange="updateMapFilters('122063')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122063" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122063" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122063" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122063" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122063')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122063')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122063_0_v0" onclick="selectVehicleV2('122063', '122063_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">К648АА186</div>
                                <div class="vehicle-selector-name">С/тягач VOLVO FM-Truck6х4 · ПЛ 1259047118</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122063">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">К648АА186</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач VOLVO FM-Truck6х4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">2.8 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">0.4 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">3.1 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">2.8 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">21.3 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">4</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122063_0_v0"
                                    onclick="loadShifts('122063_0_v0', '1259047118_03.02.2026', 709, '03.02.2026 10:00:00', '03.02.2026 22:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122063_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122063">
                        <div data-vehicle-uid="122063_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">К648АА186</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач VOLVO FM-Truck6х4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">2.8 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">0.4 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">3.1 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">2.8 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">21.3 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">4</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122063_0_v0"
                                    onclick="loadShifts('122063_0_v0', '1259047118_03.02.2026', 709, '03.02.2026 10:00:00', '03.02.2026 22:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122063_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122103 821 Р184УС86 С/тягач КамАЗ 65221" data-date="01.02.2026" data-number="122103" data-start-addr="71Н-1656 Подъезд к промпорту, Тобольск" data-end-addr="Прииртышский, Р-404 Тюмень — Тобольск — Ханты-Мансийск" data-cost-obj="Строительство и реконструкция моста через Ивановский Лог. А/д Р-404">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122103', this.querySelector('.copy-btn'));">
                                Заявка №122103
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">71Н-1656 Подъезд к промпорту, Тобольск</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Прииртышский, Р-404 Тюмень — Тобольск — Ханты-Мансийск</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122103', '71Н-1656 Подъезд к промпорту, Тобольск', 'Прииртышский, Р-404 Тюмень — Тобольск — Ханты-Мансийск', '01.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">01.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">28.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">19.6 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 19м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 2</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">перевозка ТМЦ</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Строительство и реконструкция моста через Ивановский Лог. А/д Р-404</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122103">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122103">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122103" value="1" min="1" onchange="updateCalcPlan('122103')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122103" value="2" min="1" onchange="updateCalcPlan('122103')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122103" value="20" min="1" onchange="updateCalcPlan('122103')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122103" value="65" min="10" max="120" onchange="updateCalcPlan('122103')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122103" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122103')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122103" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122103')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122103" value="01.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122103')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122103" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122103')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122103">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122103">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122103">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122103">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122103">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122103">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№821</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 03.02 20:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">Р184УС86</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122103"></div>

                    <div id="map-122103" class="map-container active">
                        <div class="map-data"
                             data-polyline="yfybJ{~j_LZKoCyq@CsC@yBDeBJoBj@yFh@eD`AwFpEqU|EcXhRccA|BwMhR{mA|Gob@bAoHPq@Vo@p@eAdBaBaBwGkBuIyAqH_@oBs@cFaEkZo@aGEkA?}A^iCXeATq@Zk@h@o@^]rBo@hAWdAg@^]tN_Q|a@ah@~@mA|@sAdB_Dl@sAfc@wgAto@}`B|JuVbRqe@`C_G~@qBrAeCfAeBp@w@dAw@pAe@nBa@lBGnqAWtXMdx@Bbl@]bBDnMK|M?pNIhAEbBQxCc@tDw@hBe@vC_A`C}@vEuBpC}AjA}@rCgC|AaBzDsExFuH`GaJpAyBbCyEtCuHzBsG`GiOvGmNj@kApAwBfB_CvCoDlDwD|HuHrD{CjBsAnBcAnBw@|HkBdDg@nEg@|CWrLi@jD_@vKmBdH_Bn[yJdFmArCY~BGbKEtHR"
                             data-route-points="[{&quot;lat&quot;: 58.298665705539214, &quot;lng&quot;: 68.2185745239258, &quot;address&quot;: &quot;71Н-1656 Подъезд к промпорту, Тобольск&quot;, &quot;date&quot;: &quot;01.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 58.16825802072534, &quot;lng&quot;: 68.37470054626466, &quot;address&quot;: &quot;Прииртышский, Р-404 Тюмень — Тобольск — Ханты-Мансийск&quot;, &quot;date&quot;: &quot;28.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122103">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122103" checked onchange="toggleParkings('122103')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122103" value="0" min="0" onchange="updateMapFilters('122103')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122103" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122103" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122103" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122103" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122103')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122103')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122103_0_v0" onclick="selectVehicleV2('122103', '122103_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">Р184УС86</div>
                                <div class="vehicle-selector-name">С/тягач КамАЗ 65221 · ПЛ 821</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122103">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">Р184УС86</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач КамАЗ 65221</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">44.2 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">1.7 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">10.0 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">8.3 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">69.2 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">18</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122103_0_v0"
                                    onclick="loadShifts('122103_0_v0', '821_03.02.2026', 390, '03.02.2026 08:00:00', '03.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122103_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122103">
                        <div data-vehicle-uid="122103_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">Р184УС86</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач КамАЗ 65221</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">44.2 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">1.7 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">10.0 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">8.3 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">69.2 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">18</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122103_0_v0"
                                    onclick="loadShifts('122103_0_v0', '821_03.02.2026', 390, '03.02.2026 08:00:00', '03.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122103_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122183 1259067514 М118УН72 С/тягач Volvo FM Truck 6х4 1259067512 О526МВ72 С/тягач Камаз 54105 1259067532 О195РВ72 С/тягач Volvo FM Truck 6х4 1259067718 М118УН72 С/тягач Volvo FM Truck 6х4 1259067716 О526МВ72 С/тягач Камаз 54105" data-date="01.02.2026" data-number="122183" data-start-addr="Ялуторовский тракт 11-й км., 9, Тюмень" data-end-addr="Ялуторовский тракт 11-й км., 1А с9, Тюмень" data-cost-obj="Цех металлоконструкций">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122183', this.querySelector('.copy-btn'));">
                                Заявка №122183
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">Ялуторовский тракт 11-й км., 9, Тюмень</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Ялуторовский тракт 11-й км., 1А с9, Тюмень</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122183', 'Ялуторовский тракт 11-й км., 9, Тюмень', 'Ялуторовский тракт 11-й км., 1А с9, Тюмень', '01.02.2026', 5)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">01.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">01.03.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">0.45 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 1м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">2 / 56</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">5</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">металлоконструкции</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">20.0 т</span></div><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">60.0 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Цех металлоконструкций</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122183">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122183">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122183" value="2" min="1" onchange="updateCalcPlan('122183')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122183" value="56" min="1" onchange="updateCalcPlan('122183')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122183" value="0" min="1" onchange="updateCalcPlan('122183')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122183" value="65" min="10" max="120" onchange="updateCalcPlan('122183')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122183" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122183')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122183" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122183')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122183" value="01.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122183')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122183" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122183')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122183">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122183">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122183">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122183">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122183">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122183">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (5)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067514</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 03.02 20:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">М118УН72</span>
                            </div>
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067512</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 03.02 20:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#ed64a6"></span><span class="subheader-pl-vehicle" style="color:#ed64a6">О526МВ72</span>
                            </div>
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067532</span>
                                <span class="subheader-pl-dates">03.02 08:00 → 03.02 20:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#4299e1"></span><span class="subheader-pl-vehicle" style="color:#4299e1">О195РВ72</span>
                            </div>
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067718</span>
                                <span class="subheader-pl-dates">03.02 20:00 → 04.02 08:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#ecc94b"></span><span class="subheader-pl-vehicle" style="color:#ecc94b">М118УН72</span>
                            </div>
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067716</span>
                                <span class="subheader-pl-dates">03.02 20:00 → 04.02 08:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#9f7aea"></span><span class="subheader-pl-vehicle" style="color:#9f7aea">О526МВ72</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122183"></div>

                    <div id="map-122183" class="map-container active">
                        <div class="map-data"
                             data-polyline="ifn{IioxoKPaAlAP`@c@jAe@VSlI{Sh@bA"
                             data-route-points="[{&quot;lat&quot;: 57.09415779178091, &quot;lng&quot;: 65.66648483276369, &quot;address&quot;: &quot;Ялуторовский тракт 11-й км., 9, Тюмень&quot;, &quot;date&quot;: &quot;01.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 57.0912900352022, &quot;lng&quot;: 65.67027211189271, &quot;address&quot;: &quot;Ялуторовский тракт 11-й км., 1А с9, Тюмень&quot;, &quot;date&quot;: &quot;01.03.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122183">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122183" checked onchange="toggleParkings('122183')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122183" value="0" min="0" onchange="updateMapFilters('122183')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122183" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122183" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122183" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122183" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122183')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122183')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122183_0_v0" onclick="selectVehicleV2('122183', '122183_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">М118УН72</div>
                                <div class="vehicle-selector-name">С/тягач Volvo FM Truck 6х4 · ПЛ 1259067514</div>
                            </div>
                        </div>
                        <div class="vehicle-selector-item" data-vehicle-uid="122183_1_v0" onclick="selectVehicleV2('122183', '122183_1_v0', 1)">
                            <span class="vehicle-selector-color" style="background:#ed64a6"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">О526МВ72</div>
                                <div class="vehicle-selector-name">С/тягач Камаз 54105 · ПЛ 1259067512</div>
                            </div>
                        </div>
                        <div class="vehicle-selector-item" data-vehicle-uid="122183_2_v0" onclick="selectVehicleV2('122183', '122183_2_v0', 2)">
                            <span class="vehicle-selector-color" style="background:#4299e1"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">О195РВ72</div>
                                <div class="vehicle-selector-name">С/тягач Volvo FM Truck 6х4 · ПЛ 1259067532</div>
                            </div>
                        </div>
                        <div class="vehicle-selector-item" data-vehicle-uid="122183_3_v0" onclick="selectVehicleV2('122183', '122183_3_v0', 3)">
                            <span class="vehicle-selector-color" style="background:#ecc94b"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">М118УН72</div>
                                <div class="vehicle-selector-name">С/тягач Volvo FM Truck 6х4 · ПЛ 1259067718</div>
                            </div>
                        </div>
                        <div class="vehicle-selector-item" data-vehicle-uid="122183_4_v0" onclick="selectVehicleV2('122183', '122183_4_v0', 4)">
                            <span class="vehicle-selector-color" style="background:#9f7aea"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">О526МВ72</div>
                                <div class="vehicle-selector-name">С/тягач Камаз 54105 · ПЛ 1259067716</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122183">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">М118УН72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">4.6 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">4.6 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">31.9 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">1</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122183_0_v0"
                                    onclick="loadShifts('122183_0_v0', '1259067514_03.02.2026', 112, '03.02.2026 08:00:00', '03.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122183_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122183">
                        <div data-vehicle-uid="122183_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">М118УН72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">4.6 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">4.6 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">31.9 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">1</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122183_0_v0"
                                    onclick="loadShifts('122183_0_v0', '1259067514_03.02.2026', 112, '03.02.2026 08:00:00', '03.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122183_0_v0"></div>
                        </div>
                        </div>
                        <div data-vehicle-uid="122183_1_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">О526МВ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Камаз 54105</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">2.5 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">2.5 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">7.8 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">1</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122183_1_v0"
                                    onclick="loadShifts('122183_1_v0', '1259067512_03.02.2026', 523, '03.02.2026 08:00:00', '03.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122183_1_v0"></div>
                        </div>
                        </div>
                        <div data-vehicle-uid="122183_2_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">О195РВ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">32.5 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">0.8 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">3.0 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">2.2 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">14.7 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">5</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122183_2_v0"
                                    onclick="loadShifts('122183_2_v0', '1259067532_03.02.2026', 114, '03.02.2026 08:00:00', '03.02.2026 20:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122183_2_v0"></div>
                        </div>
                        </div>
                        <div data-vehicle-uid="122183_3_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">М118УН72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Volvo FM Truck 6х4</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">6.0 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">6.0 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">37.8 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">1</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122183_3_v0"
                                    onclick="loadShifts('122183_3_v0', '1259067718_03.02.2026', 112, '03.02.2026 20:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122183_3_v0"></div>
                        </div>
                        </div>
                        <div data-vehicle-uid="122183_4_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">О526МВ72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач Камаз 54105</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">0.1 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">0.0 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">2.7 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">2.7 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">11.5 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">2</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122183_4_v0"
                                    onclick="loadShifts('122183_4_v0', '1259067716_03.02.2026', 523, '03.02.2026 20:00:00', '04.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122183_4_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122184 1259067515 О614МН72 С/тягач МАЗ 6422А-330" data-date="01.02.2026" data-number="122184" data-start-addr="База МО36, Ялуторовский тракт 11-й км., 1А с9, Тюмень" data-end-addr="База МО36, Тюмень" data-cost-obj="Бетонный завод">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122184', this.querySelector('.copy-btn'));">
                                Заявка №122184
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">База МО36, Ялуторовский тракт 11-й км., 1А с9, Тюмень</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">База МО36, Тюмень</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122184', 'База МО36, Ялуторовский тракт 11-й км., 1А с9, Тюмень', 'База МО36, Тюмень', '01.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">01.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">28.02.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">0.18 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 0м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 56</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">бетон</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">📐</span><span class="cargo-value">24.0 м³</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Бетонный завод</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122184">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122184">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122184" value="1" min="1" onchange="updateCalcPlan('122184')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122184" value="56" min="1" onchange="updateCalcPlan('122184')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122184" value="0" min="1" onchange="updateCalcPlan('122184')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122184" value="65" min="10" max="120" onchange="updateCalcPlan('122184')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122184" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122184')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122184" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122184')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122184" value="01.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122184')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122184" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122184')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122184">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122184">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122184">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122184">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122184">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122184">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259067515</span>
                                <span class="subheader-pl-dates">03.02 20:00 → 03.02 23:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">О614МН72</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122184"></div>

                    <div id="map-122184" class="map-container active">
                        <div class="map-data"
                             data-polyline="yqm{I}cyoKfAtBwAzBCz@]x@[k@"
                             data-route-points="[{&quot;lat&quot;: 57.09081205420718, &quot;lng&quot;: 65.67034721374513, &quot;address&quot;: &quot;База МО36, Ялуторовский тракт 11-й км., 1А с9, Тюмень&quot;, &quot;date&quot;: &quot;01.02.2026&quot;, &quot;time&quot;: &quot;20:00&quot;}, {&quot;lat&quot;: 57.09144158886526, &quot;lng&quot;: 65.66826581954957, &quot;address&quot;: &quot;База МО36, Тюмень&quot;, &quot;date&quot;: &quot;28.02.2026&quot;, &quot;time&quot;: &quot;23:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122184">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122184" checked onchange="toggleParkings('122184')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122184" value="0" min="0" onchange="updateMapFilters('122184')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122184" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122184" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122184" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122184" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122184')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122184')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122184_0_v0" onclick="selectVehicleV2('122184', '122184_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">О614МН72</div>
                                <div class="vehicle-selector-name">С/тягач МАЗ 6422А-330 · ПЛ 1259067515</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122184">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">О614МН72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач МАЗ 6422А-330</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="no-data">Нет данных мониторинга</div>

                            <button class="shift-load-btn" id="shift-btn-122184_0_v0"
                                    onclick="loadShifts('122184_0_v0', '1259067515_03.02.2026', 119, '03.02.2026 20:00:00', '03.02.2026 23:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122184_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122184">
                        <div data-vehicle-uid="122184_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">О614МН72</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач МАЗ 6422А-330</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="no-data">Нет данных мониторинга</div>

                            <button class="shift-load-btn" id="shift-btn-122184_0_v0"
                                    onclick="loadShifts('122184_0_v0', '1259067515_03.02.2026', 119, '03.02.2026 20:00:00', '03.02.2026 23:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122184_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="request" data-search="122260 1259006186 К409АН186 С/тягач КамАЗ 44108-24" data-date="01.02.2026" data-number="122260" data-start-addr="Омск, 52Н-335 Красноярский тракт" data-end-addr="Омск" data-cost-obj="Строительство автомобильной дороги «Северный обход г. Омска»">
            <!-- V2: Увеличенный хедер с данными заявки -->
            <div class="request-header-v2" onclick="toggleRequestV2(this)">
                <div class="request-header-top">
                    <div class="request-header-left">
                        <div class="request-title">
                            <span class="expand-arrow down">▼</span>
                            <span class="copyable" onclick="event.stopPropagation(); copyToClipboard('122260', this.querySelector('.copy-btn'));">
                                Заявка №122260
                                <button class="copy-btn" title="Копировать номер заявки">📋</button>
                            </span>
                        </div>
                        <div class="request-route">
                            <div class="route-line"><span class="emoji">🟢</span><span class="addr">Омск, 52Н-335 Красноярский тракт</span></div>
                            <div class="route-line"><span class="emoji">🏁</span><span class="addr">Омск</span></div>
                        </div>
                    </div>
                    <div class="request-header-right">
                        <span class="timezone-tag">МСК+2</span>
                        <button class="archive-btn" onclick="toggleArchive(event, '122260', 'Омск, 52Н-335 Красноярский тракт', 'Омск', '01.02.2026', 1)" title="Добавить в архив просмотренных">★ В архив</button>
                    </div>
                </div>
                <div class="request-header-data">
                    <div class="header-data-main">
                        <div class="header-data-item header-data-period">
                            <div class="period-row">
                                <span class="period-label">от</span>
                                <span class="period-date">01.02.2026</span>
                            </div>
                            <div class="period-row">
                                <span class="period-label">до</span>
                                <span class="period-date">01.03.2026</span>
                            </div>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Расстояние</span>
                            <span class="value">10.3 км</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">Время</span>
                            <span class="value">0ч 12м</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ТС / Ездок</span>
                            <span class="value">1 / 56</span>
                        </div>
                        <div class="header-data-item">
                            <span class="label">ПЛ</span>
                            <span class="value">1</span>
                        </div>
                        <div class="header-data-item header-data-cargo">
                            <div class="cargo-left">
                                <span class="label">Груз</span>
                                <span class="cargo-name">Сборный груз, материалы и оборудование для участка</span>
                            </div>
                            <div class="cargo-details"><div class="cargo-detail"><span class="cargo-label">🏗️</span><span class="cargo-value">1232.0 т</span></div></div>
                        </div>
                    </div>
                    <div class="header-data-cost">
                        <span class="label">Объект затрат</span>
                        <span class="value">Строительство автомобильной дороги «Северный обход г. Омска»</span>
                    </div>
                </div>
            </div>

            <!-- V2: Subheader -->
            <div class="request-subheader" id="subheader-122260">
                <!-- Расчётный план (полная версия) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Расчётный план</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body" id="calc-body-122260">
                        <div class="calc-plan-grid">
                            <div class="calc-input-group">
                                <label>Кол-во ТС</label>
                                <input type="number" id="calc-ts-122260" value="1" min="1" onchange="updateCalcPlan('122260')">
                            </div>
                            <div class="calc-input-group">
                                <label>Кол-во ездок</label>
                                <input type="number" id="calc-trips-122260" value="56" min="1" onchange="updateCalcPlan('122260')">
                            </div>
                            <div class="calc-input-group">
                                <label>Расстояние (км, в 1 сторону)</label>
                                <input type="number" id="calc-dist-122260" value="10" min="1" onchange="updateCalcPlan('122260')">
                            </div>
                            <div class="calc-input-group">
                                <label>Скорость (км/ч)</label>
                                <input type="number" id="calc-speed-122260" value="65" min="10" max="120" onchange="updateCalcPlan('122260')">
                            </div>
                            <div class="calc-input-group">
                                <label>Раб. часов в день</label>
                                <input type="number" id="calc-hours-122260" value="11" min="1" max="24" step="0.5" onchange="updateCalcPlan('122260')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время погрузки (ч)</label>
                                <input type="number" id="calc-load-122260" value="1.5" min="0" max="10" step="0.5" onchange="updateCalcPlan('122260')">
                            </div>
                            <div class="calc-input-group">
                                <label>Дата начала</label>
                                <input type="text" id="calc-start-date-122260" value="01.02.2026" placeholder="ДД.ММ.ГГГГ" onchange="updateCalcPlan('122260')">
                            </div>
                            <div class="calc-input-group">
                                <label>Время начала</label>
                                <input type="text" id="calc-start-time-122260" value="06:00" placeholder="ЧЧ:ММ" onchange="updateCalcPlan('122260')">
                            </div>
                        </div>
                        <div class="calc-results">
                            <div class="calc-results-title">Результат расчёта</div>
                            <div class="calc-result-grid">
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов на 1 ТС:</span>
                                        <span class="value" id="calc-res-trips-per-ts-122260">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Расстояние рейса (туда-обратно):</span>
                                        <span class="value" id="calc-res-round-dist-122260">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Время рейса:</span>
                                        <span class="value" id="calc-res-trip-time-122260">—</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="calc-result-item">
                                        <span class="label">Рейсов в день:</span>
                                        <span class="value" id="calc-res-trips-per-day-122260">—</span>
                                    </div>
                                    <div class="calc-result-item">
                                        <span class="label">Дней на выполнение:</span>
                                        <span class="value" id="calc-res-days-122260">—</span>
                                    </div>
                                    <div class="calc-result-item highlight">
                                        <span class="label">Завершение:</span>
                                        <span class="value" id="calc-res-end-date-122260">—</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Путевые листы (компактный список) -->
                <div class="subheader-section">
                    <div class="subheader-section-header" onclick="toggleSubheaderSection(this)">
                        <span class="subheader-section-title">Путевые листы (1)</span>
                        <span class="subheader-section-toggle">▼</span>
                    </div>
                    <div class="subheader-section-body active">
                        <div class="subheader-pl-list">
                            <div class="subheader-pl-item">
                                <span class="subheader-pl-number">№1259006186</span>
                                <span class="subheader-pl-dates">03.02 20:00 → 06.02 08:00</span>
                                <span class="subheader-pl-vehicle-dot" style="background:#48bb78"></span><span class="subheader-pl-vehicle" style="color:#48bb78">К409АН186</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V2: 2-колоночный Body Layout -->
            <div class="request-body request-body-layout-v2">

                <!-- CENTER COLUMN: Map -->
                <div class="center-column">
                    <div class="vehicle-toggle-bar" id="vehicle-filters-122260"></div>

                    <div id="map-122260" class="map-container active">
                        <div class="map-data"
                             data-polyline="qknoIajc~Lmd@pLgGtA_BZgZzCeKnAia@xF{@HaACk_@aCyAUa@MiCfBW\Qv@KhAw@xTq@`Ug@zMQdCShBWbBg@`CcId\sFdToDxNkF|Sa@bAc@l@WTwKjHLbBThFp@~QD`CBrIY|`@?h@Hb@LRRJtBTnDXdNt@z@VNNHRFd@J~Ld@rQbAbg@GnAyAhR?j@Dp@lCEz@LpKfC~@Lt@?~@IfDsAfCsAbBo@t@KtBGdBLlAGRdC@ZG`CB`A^`ENhCFbBvARfMlAtTdBDtC@pC_@di@M`VIzKKdF"
                             data-route-points="[{&quot;lat&quot;: 55.12909071827204, &quot;lng&quot;: 73.2590675354004, &quot;address&quot;: &quot;Омск, 52Н-335 Красноярский тракт&quot;, &quot;date&quot;: &quot;01.02.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}, {&quot;lat&quot;: 55.14588941054135, &quot;lng&quot;: 73.1748161284486, &quot;address&quot;: &quot;Омск&quot;, &quot;date&quot;: &quot;01.03.2026&quot;, &quot;time&quot;: &quot;08:00&quot;}]"
                             data-vehicles="[]">
                        </div>
                        <div class="map-layout">
                            <div class="map-area">
                                <div class="leaflet-map"></div>
                            </div>
                            <div class="timeline-area" id="timeline-122260">
                                <div class="timeline-header">
                                    <span class="timeline-title">Таймлайн</span>
                                    <div class="timeline-parking-filter">
                                        <label>
                                            <input type="checkbox" id="show-parkings-122260" checked onchange="toggleParkings('122260')">
                                            <span>🅿️</span>
                                        </label>
                                        <input type="number" id="min-parking-122260" value="0" min="0" onchange="updateMapFilters('122260')">
                                        <span>мин</span>
                                    </div>
                                </div>
                                <div class="timeline-time-filter" style="padding:6px 8px;background:#f7fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px;">
                                    <span style="color:#718096;">Период:</span>
                                    <input type="date" id="start-date-122260" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="start-time-122260" value="00:00" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <span style="color:#a0aec0;">—</span>
                                    <input type="date" id="end-date-122260" style="font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <input type="time" id="end-time-122260" value="23:59" style="width:55px;font-size:10px;padding:2px 4px;border:1px solid #e2e8f0;border-radius:3px;">
                                    <button onclick="applyTimeFilter('122260')" style="font-size:10px;padding:2px 6px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;" title="Применить фильтр">✓</button>
                                    <button onclick="clearTimeFilter('122260')" style="font-size:10px;padding:2px 6px;background:#e53e3e;color:white;border:none;border-radius:3px;cursor:pointer;" title="Сбросить фильтр">✕</button>
                                </div>
                                <div class="timeline-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Vehicle Selector + Fact -->
                <div class="right-column">
                    <div class="vehicle-selector">
                        <div class="vehicle-selector-title">Выберите машину</div>
                        <div class="vehicle-selector-item selected" data-vehicle-uid="122260_0_v0" onclick="selectVehicleV2('122260', '122260_0_v0', 0)">
                            <span class="vehicle-selector-color" style="background:#48bb78"></span>
                            <div class="vehicle-selector-info">
                                <div class="vehicle-selector-reg">К409АН186</div>
                                <div class="vehicle-selector-name">С/тягач КамАЗ 44108-24 · ПЛ 1259006186</div>
                            </div>
                        </div>
                    </div>

                    <div class="active-vehicle-panel" id="vehicle-fact-122260">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">К409АН186</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач КамАЗ 44108-24</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">25.8 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">3.9 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">21.7 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">17.9 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">81.6 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">36</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122260_0_v0"
                                    onclick="loadShifts('122260_0_v0', '1259006186_03.02.2026', 2982, '03.02.2026 20:00:00', '06.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122260_0_v0"></div>
                        </div>
                    </div>

                    <!-- Hidden cache of all vehicle panels -->
                    <div class="vehicle-panels-cache" id="vehicle-cache-122260">
                        <div data-vehicle-uid="122260_0_v0">

                        <div class="vehicle-header" style="background:#f7fafc;padding:10px 12px;border-bottom:1px solid #e2e8f0;">
                            <span class="vehicle-reg" style="font-weight:600;font-family:monospace;">К409АН186</span>
                            <span class="vehicle-name" style="color:#718096;font-size:12px;"> — С/тягач КамАЗ 44108-24</span>
                        </div>
                        <div class="fact-section" style="padding:12px;">
                            <div class="fact-title">Факт (мониторинг)</div>
                            <div class="fact-grid">
                                <div class="fact-item"><div class="label">Пробег</div><div class="value">25.8 км</div></div>
                                <div class="fact-item"><div class="label">В движении</div><div class="value">3.9 ч</div></div>
                                <div class="fact-item"><div class="label">Двигатель</div><div class="value">21.7 ч</div></div>
                                <div class="fact-item"><div class="label">Простой</div><div class="value">17.9 ч</div></div>
                                <div class="fact-item"><div class="label">Топливо</div><div class="value">81.6 л</div></div>
                                <div class="fact-item"><div class="label">Стоянок</div><div class="value">36</div></div>
                            </div>

                            <button class="shift-load-btn" id="shift-btn-122260_0_v0"
                                    onclick="loadShifts('122260_0_v0', '1259006186_03.02.2026', 2982, '03.02.2026 20:00:00', '06.02.2026 08:00:00')"
                                    style="margin-top:10px;font-size:11px;padding:6px 12px;">
                                📊 Загрузить по сменам
                            </button>
                            <div class="shift-container" id="shift-container-122260_0_v0"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <div class="footer">
        Сгенерировано: 06.02.2026 21:17
    </div>

    <script>
        // Report ID for shift loading API
        const REPORT_ID = null;

        // Filter data
        const filterData = {
            startAddr: ["71Н-1656 Подъезд к промпорту, Тобольск", "80К-026 Стерлитамак — Белорецк — Магнитогорск, Стерлитамак", "Арматурный цех ВСЖМ, 46К-9253 Лотошино - Суворово - Клин (Клинский район)", "База МО36, Ялуторовский тракт 11-й км., 1 с17, Тюмень", "База МО36, Ялуторовский тракт 11-й км., 1А с9, Тюмень", "База МО36, Ялуторовский тракт 11-й км., с5/9, Тюмень", "ВСЖМ 3 этап, ПК2694, 49Н-1234 Окуловка - Мельница", "ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»", "ВСЖМ, 6 этап, ПК5452, М-11 «Нева»", "ВСЖМ, 6 этап, ПК5514, М-11 «Нева»", "ВСЖМ, 6 этап, ПК5555, Нагорная улица, Решетниково", "ВСЖМ, НАкопитель песка и ЩПС, М-11 «Нева»", "Линево", "Омск", "Омск, 52Н-335 Красноярский тракт", "Пожарная улица, Красная Горка", "Скания, Р351 300 километр, 2 ​Екатеринбург-Тюмень 301 км, 1 с1, Ушакова, Тюменский район, Тюменская область", "Ялуторовский тракт 11-й км., 9 с41, Тюмень", "Ялуторовский тракт 11-й км., 9, Тюмень", "Ялуторовский тракт 11-й км., Тюмень", "улица Бабушкина, Стерлитамак"],
            endAddr: ["База МО36, Тюмень", "База МО36, Ялуторовский тракт 11-й км., 1А с7, Тюмень", "ВСЖМ 6 этап, Мост через р.Шошу ПК5326, М-11 «Нева»", "ВСЖМ, 6 этап, ПК5452, М-11 «Нева»", "ВСЖМ, 6 этап, ПК5555, М-11 «Нева»", "ВСЖМ, 6 этап, ПК5555, Нагорная улица, Решетниково", "ВСЖМ, 6 этап, ПК5600, М-11 «Нева»", "ВСЖМ, 7 этап, ПК5642, городской округ Клин, Московская область", "Вельмогово, М-11 «Нева»", "Красная Горка, Омский район, Омская область", "Линево", "Окуловка, Дубецкая дорога", "Омск", "Прииртышский, Р-404 Тюмень — Тобольск — Ханты-Мансийск", "Сумкино, Р-404 Тюмень — Тобольск — Ханты-Мансийск", "Тобольск", "Тобольск, Р-404 Тюмень — Тобольск — Ханты-Мансийск", "Харино", "Ялуторовский тракт 11-й км., 1А с9, Тюмень", "Ялуторовский тракт 11-й км., Тюмень", "проспект Братьев Коростелёвых, 181, Оренбург"],
            costObj: ["Бетонный завод", "Реконструкция мостового перехода через реку Сакмара (верхового) на проспекте Братьев Коростылевых в городе Оренбурге (АВТОБАН ДСК АО)", "Создание ВСМ Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 3 Этап. Основные работы – Стр-во уч. Валдай ВСМ. Новгородская обл.", "Создание ВСМ Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап. Основные работы – Стр-во уч. Новая Тверь. Московская обл.", "Создание ВСМ Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап. Основные работы – Стр-во уч. Новая Тверь. Тверская обл.", "Создание высокоскоростной ж/д мгстр. Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 3 Этап – Стр-во уч. Валдай ВСМ. Новгородская обл.", "Создание высокоскоростной ж/д мгстр. Санкт-Петербург – Москва (уч. Крюково (Алабушево) – Обухово). 6 Этап – Стр-во уч. Новая Тверь. Московская обл.", "Стр-во нового комплекса пр-ва пропилена дегидрированием пропана и деривативов пропилена (ДГП-2) на ООО «ЗапСибНефтехим».Общестр. работы выше отм. 0.00", "Строительство автомобильной дороги «Северный обход г. Омска»", "Строительство и реконструкция моста через Ивановский Лог. А/д Р-404", "Строительство и реконструкция моста через р. Иртыш. А/д Р-404", "Услуги автотранспорта (с экипажем) (внутригрупповые)", "Цех ЖБИ", "Цех металлоконструкций"]
        };

        // Selected filter values
        const selectedFilters = {
            startAddr: new Set(),
            endAddr: new Set(),
            costObj: new Set()
        };

        // Initialize filters
        document.addEventListener('DOMContentLoaded', function() {
            initFilterOptions('startAddr', filterData.startAddr);
            initFilterOptions('endAddr', filterData.endAddr);
            initFilterOptions('costObj', filterData.costObj);
            updateParkingDisplay();
        });

        function initFilterOptions(filterId, options) {
            const container = document.getElementById(filterId + 'Options');
            container.innerHTML = '';
            options.forEach((opt, idx) => {
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.setAttribute('data-value', opt);
                div.innerHTML = '<input type="checkbox" id="' + filterId + '_' + idx + '"> <label for="' + filterId + '_' + idx + '">' + opt + '</label>';
                div.onclick = function(e) {
                    if (e.target.tagName !== 'INPUT') {
                        const cb = div.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                };
                container.appendChild(div);
            });
        }

        function toggleFilter(filterId) {
            const popup = document.getElementById(filterId + 'Popup');
            const isActive = popup.classList.contains('active');

            // Close all popups
            document.querySelectorAll('.filter-popup').forEach(p => p.classList.remove('active'));

            if (!isActive) {
                popup.classList.add('active');
            }
        }

        // Close popups on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.filter-dropdown')) {
                document.querySelectorAll('.filter-popup').forEach(p => p.classList.remove('active'));
            }
        });

        function searchFilterOptions(filterId, query) {
            const container = document.getElementById(filterId + 'Options');
            const options = container.querySelectorAll('.filter-option');
            const q = query.toLowerCase();

            options.forEach(opt => {
                const value = opt.getAttribute('data-value').toLowerCase();
                if (value.includes(q)) {
                    opt.classList.remove('hidden');
                } else {
                    opt.classList.add('hidden');
                }
            });
        }

        function clearFilter(filterId) {
            const container = document.getElementById(filterId + 'Options');
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            selectedFilters[filterId].clear();
            updateFilterButton(filterId);
        }

        function selectAllFilter(filterId) {
            const container = document.getElementById(filterId + 'Options');
            container.querySelectorAll('.filter-option:not(.hidden) input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function applyFilters() {
            // Collect selected values for each filter
            ['startAddr', 'endAddr', 'costObj'].forEach(filterId => {
                selectedFilters[filterId].clear();
                const container = document.getElementById(filterId + 'Options');
                container.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                    const opt = cb.closest('.filter-option');
                    selectedFilters[filterId].add(opt.getAttribute('data-value'));
                });
                updateFilterButton(filterId);
            });

            // Close popups
            document.querySelectorAll('.filter-popup').forEach(p => p.classList.remove('active'));

            // Apply all filters
            filterRequests();
        }

        function updateFilterButton(filterId) {
            const count = selectedFilters[filterId].size;
            document.getElementById(filterId + 'Count').textContent = count;
            const btn = document.querySelector('#' + filterId + 'Popup').previousElementSibling;
            const label = btn.querySelector('span:first-child');
            if (count === 0) {
                label.textContent = 'Все';
            } else if (count === 1) {
                label.textContent = Array.from(selectedFilters[filterId])[0].substring(0, 20) + '...';
            } else {
                label.textContent = 'Выбрано: ' + count;
            }
        }

        function filterRequests() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const hideArchived = document.getElementById('hideArchived').checked;
            const requests = document.querySelectorAll('.request');
            let visibleCount = 0;

            requests.forEach(req => {
                const text = req.getAttribute('data-search').toLowerCase();
                const startAddr = req.getAttribute('data-start-addr') || '';
                const endAddr = req.getAttribute('data-end-addr') || '';
                const costObj = req.getAttribute('data-cost-obj') || '';
                const isArchived = req.classList.contains('is-archived');

                // Text search
                const matchesSearch = !query || text.includes(query);

                // Filter checks
                const matchesStart = selectedFilters.startAddr.size === 0 || selectedFilters.startAddr.has(startAddr);
                const matchesEnd = selectedFilters.endAddr.size === 0 || selectedFilters.endAddr.has(endAddr);
                const matchesCost = selectedFilters.costObj.size === 0 || selectedFilters.costObj.has(costObj);

                // Archive filter
                const matchesArchive = !hideArchived || !isArchived;

                if (matchesSearch && matchesStart && matchesEnd && matchesCost && matchesArchive) {
                    req.classList.remove('hidden');
                    visibleCount++;
                } else {
                    req.classList.add('hidden');
                }
            });

            document.getElementById('resultsInfo').textContent = 'Показано заявок: ' + visibleCount;
        }

        function sortRequests() {
            const container = document.getElementById('requestsContainer');
            const requests = Array.from(container.querySelectorAll('.request'));
            const sortType = document.getElementById('sortSelect').value;

            requests.sort((a, b) => {
                if (sortType === 'date-desc') {
                    return (b.getAttribute('data-date') || '').localeCompare(a.getAttribute('data-date') || '');
                } else if (sortType === 'date-asc') {
                    return (a.getAttribute('data-date') || '').localeCompare(b.getAttribute('data-date') || '');
                } else if (sortType === 'number-asc') {
                    return parseInt(a.getAttribute('data-number')) - parseInt(b.getAttribute('data-number'));
                }
                return 0;
            });

            requests.forEach(req => container.appendChild(req));
        }

        function togglePL(plId) {
            const body = document.getElementById('pl-body-' + plId);
            if (body) {
                body.style.display = body.style.display === 'none' ? 'block' : 'none';
            }
        }

        function updateParkingDisplay() {
            const minTime = parseInt(document.getElementById('minParkingTime').value) || 0;
            document.querySelectorAll('.parking-day-group').forEach(group => {
                let visibleCount = 0;
                group.querySelectorAll('.parking-item').forEach(item => {
                    const duration = parseInt(item.getAttribute('data-duration')) || 0;
                    if (duration >= minTime) {
                        item.style.display = 'block';
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });
                // Hide day group if no items visible
                group.style.display = visibleCount > 0 ? 'block' : 'none';
            });
            // Also handle flat parking items in fact-panel (not in day groups)
            document.querySelectorAll('.fact-panel .parking-item').forEach(item => {
                if (item.closest('.parking-day-group')) return; // skip if already in group
                const duration = parseInt(item.getAttribute('data-duration')) || 0;
                item.style.display = duration >= minTime ? 'block' : 'none';
            });
        }

        function switchDay(vehicleId, dayIndex) {
            // Update buttons
            const nav = document.getElementById('day-nav-' + vehicleId);
            if (nav) {
                nav.querySelectorAll('.day-nav-btn').forEach((btn, idx) => {
                    btn.classList.toggle('active', idx === dayIndex);
                });
            }

            // Update content
            const container = document.getElementById('day-container-' + vehicleId);
            if (container) {
                container.querySelectorAll('.day-content').forEach((content, idx) => {
                    content.classList.toggle('active', idx === dayIndex);
                });
            }
        }

        function toggleCalcPlan(reqNum) {
            const body = document.getElementById('calc-body-' + reqNum);
            const toggle = document.getElementById('calc-toggle-' + reqNum);
            if (body.classList.contains('active')) {
                body.classList.remove('active');
                toggle.textContent = '▼ развернуть';
            } else {
                body.classList.add('active');
                toggle.textContent = '▲ свернуть';
                updateCalcPlan(reqNum);
            }
        }

        function updateCalcPlan(reqNum) {
            // Get input values
            const ts = parseInt(document.getElementById('calc-ts-' + reqNum).value) || 1;
            const trips = parseInt(document.getElementById('calc-trips-' + reqNum).value) || 1;
            const distOneWay = parseFloat(document.getElementById('calc-dist-' + reqNum).value) || 0;
            const speed = parseFloat(document.getElementById('calc-speed-' + reqNum).value) || 65;
            const workHours = parseFloat(document.getElementById('calc-hours-' + reqNum).value) || 11;
            const loadTime = parseFloat(document.getElementById('calc-load-' + reqNum).value) || 1.5;
            const startDateStr = document.getElementById('calc-start-date-' + reqNum).value;
            const startTimeStr = document.getElementById('calc-start-time-' + reqNum).value;

            // Calculations
            const tripsPerTs = Math.ceil(trips / ts);
            const roundDist = distOneWay * 2;
            const travelTime = roundDist / speed;
            const tripTime = travelTime + loadTime;
            const tripsPerDay = Math.floor(workHours / tripTime);
            const daysNeeded = tripsPerDay > 0 ? Math.ceil(tripsPerTs / tripsPerDay) : 999;

            // Update results
            document.getElementById('calc-res-trips-per-ts-' + reqNum).textContent = tripsPerTs;
            document.getElementById('calc-res-round-dist-' + reqNum).textContent = roundDist.toFixed(0) + ' км (' + distOneWay.toFixed(0) + ' × 2)';
            document.getElementById('calc-res-trip-time-' + reqNum).textContent = tripTime.toFixed(1) + ' ч (' + travelTime.toFixed(1) + 'ч в пути + ' + loadTime + 'ч погрузка)';
            document.getElementById('calc-res-trips-per-day-' + reqNum).textContent = tripsPerDay > 0 ? tripsPerDay : '< 1';
            document.getElementById('calc-res-days-' + reqNum).textContent = daysNeeded < 999 ? daysNeeded : '—';

            // Calculate end date
            if (startDateStr && daysNeeded < 999) {
                const endDate = calculateEndDate(startDateStr, startTimeStr, daysNeeded, workHours, tripTime, tripsPerTs, tripsPerDay);
                document.getElementById('calc-res-end-date-' + reqNum).textContent = endDate;
            } else {
                document.getElementById('calc-res-end-date-' + reqNum).textContent = '—';
            }
        }

        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(function() {
                // Visual feedback
                btn.classList.add('copied');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '✓';
                setTimeout(function() {
                    btn.classList.remove('copied');
                    btn.innerHTML = originalHtml;
                }, 1000);
            }).catch(function(err) {
                console.error('Copy failed:', err);
            });
        }

        function copyValue(event, value) {
            event.stopPropagation();
            const btn = event.currentTarget;
            copyToClipboard(value, btn);
        }

        function calculateEndDate(startDateStr, startTimeStr, daysNeeded, workHours, tripTime, tripsPerTs, tripsPerDay) {
            // Parse start date (DD.MM.YYYY)
            const dateParts = startDateStr.split('.');
            if (dateParts.length !== 3) return '—';

            const day = parseInt(dateParts[0]);
            const month = parseInt(dateParts[1]) - 1;
            const year = parseInt(dateParts[2]);

            // Parse start time (HH:MM)
            const timeParts = startTimeStr.split(':');
            const startHour = parseInt(timeParts[0]) || 6;
            const startMin = parseInt(timeParts[1]) || 0;

            // Create start date
            const startDate = new Date(year, month, day, startHour, startMin);

            // Calculate remaining trips on last day
            const fullDays = daysNeeded - 1;
            const remainingTrips = tripsPerTs - (fullDays * tripsPerDay);
            const lastDayHours = remainingTrips * tripTime;

            // Calculate end date
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + fullDays);
            endDate.setHours(startHour + Math.floor(lastDayHours));
            endDate.setMinutes(startMin + Math.round((lastDayHours % 1) * 60));

            // Format result
            const endDay = String(endDate.getDate()).padStart(2, '0');
            const endMonth = String(endDate.getMonth() + 1).padStart(2, '0');
            const endYear = endDate.getFullYear();
            const endHour = String(endDate.getHours()).padStart(2, '0');
            const endMinute = String(endDate.getMinutes()).padStart(2, '0');

            return endDay + '.' + endMonth + '.' + endYear + ' ~' + endHour + ':' + endMinute;
        }

        // Map functions
        const mapInstances = {};

        function toggleMap(requestId) {
            const container = document.getElementById('map-' + requestId);
            const btn = document.getElementById('map-btn-' + requestId);
            const paramsPanel = document.getElementById('map-params-' + requestId);

            if (container.classList.contains('active')) {
                container.classList.remove('active');
                btn.classList.remove('active');
                btn.innerHTML = '🗺️ Показать карту';
                if (paramsPanel) paramsPanel.classList.remove('active');
                return;
            }

            container.classList.add('active');
            btn.classList.add('active');
            btn.innerHTML = '❌ Скрыть карту';
            if (paramsPanel) paramsPanel.classList.add('active');

            if (!container.dataset.initialized) {
                initMap(requestId, container);
                container.dataset.initialized = 'true';
            } else if (mapInstances[requestId]) {
                // Invalidate size when showing again
                setTimeout(function() {
                    mapInstances[requestId].invalidateSize();
                }, 100);
            }
        }

        // Track colors palette for different vehicles
        const trackColors = ['#48bb78', '#ed64a6', '#4299e1', '#ecc94b', '#9f7aea', '#38b2ac', '#f56565'];

        // Store vehicle data and layers for filtering
        const mapVehiclesData = {};
        const mapVehicleLayers = {};
        const mapTimeFilters = {};

        // Format datetime string "2026-02-01 08:30:00" -> "01.02 08:30"
        function formatDateTime(dtStr) {
            if (!dtStr) return '';
            // Expected format: "YYYY-MM-DD HH:MM:SS" or "DD.MM.YYYY HH:MM:SS"
            const parts = dtStr.split(' ');
            if (parts.length < 2) return dtStr;

            const datePart = parts[0];
            const timePart = parts[1].substring(0, 5); // HH:MM

            // Check date format
            if (datePart.includes('-')) {
                // YYYY-MM-DD
                const dp = datePart.split('-');
                if (dp.length === 3) {
                    return dp[2] + '.' + dp[1] + ' ' + timePart;
                }
            } else if (datePart.includes('.')) {
                // DD.MM.YYYY
                const dp = datePart.split('.');
                if (dp.length === 3) {
                    return dp[0] + '.' + dp[1] + ' ' + timePart;
                }
            }
            return timePart;
        }

        // Build display names with PL numbering for same vehicles
        function buildVehicleDisplayNames(vehicles) {
            // Count occurrences of each reg number
            const counts = {};
            vehicles.forEach(function(v) {
                const reg = v.ts_reg_number || '';
                counts[reg] = (counts[reg] || 0) + 1;
            });

            // Assign display names with numbering if needed
            const indices = {};
            vehicles.forEach(function(v) {
                const reg = v.ts_reg_number || 'ТС';
                if (counts[reg] > 1) {
                    indices[reg] = (indices[reg] || 0) + 1;
                    v.displayName = reg + '-№' + indices[reg];
                } else {
                    v.displayName = reg;
                }
            });
        }

        function initMap(requestId, container) {
            const mapData = container.querySelector('.map-data');
            if (!mapData) return;

            const polyline = mapData.dataset.polyline || '';
            const routePointsStr = mapData.dataset.routePoints || '[]';
            const vehiclesStr = mapData.dataset.vehicles || '[]';

            let routePoints = [];
            let vehicles = [];

            try { routePoints = JSON.parse(routePointsStr); } catch(e) {}
            try { vehicles = JSON.parse(vehiclesStr); } catch(e) {}

            // Build display names with PL numbering for same vehicles
            buildVehicleDisplayNames(vehicles);

            // Store vehicles data for this map
            mapVehiclesData[requestId] = vehicles;
            mapVehicleLayers[requestId] = [];

            const mapEl = container.querySelector('.leaflet-map');
            const map = L.map(mapEl).setView([56, 68], 6);
            mapInstances[requestId] = map;

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const bounds = [];

            // Plan route (blue) - from polyline
            if (polyline) {
                const decoded = decodePolyline(polyline);
                if (decoded.length > 0) {
                    const planLine = L.polyline(decoded, {
                        color: '#3182ce',
                        weight: 4,
                        opacity: 0.8
                    }).addTo(map);
                    bounds.push(...decoded);
                }
            }

            // Route points (markers for start/end)
            if (routePoints.length > 0) {
                // Start point (green)
                const start = routePoints[0];
                if (start.lat && start.lng) {
                    L.marker([start.lat, start.lng], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: '<div style="background:#38a169;width:14px;height:14px;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                            iconSize: [14, 14],
                            iconAnchor: [7, 7]
                        })
                    }).bindPopup('<b>Старт</b><br>' + (start.address || '') + '<br>' + (start.date || '') + ' ' + (start.time || '')).addTo(map);
                    bounds.push([start.lat, start.lng]);
                }

                // End point (red)
                if (routePoints.length > 1) {
                    const end = routePoints[routePoints.length - 1];
                    if (end.lat && end.lng) {
                        L.marker([end.lat, end.lng], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: '<div style="background:#e53e3e;width:14px;height:14px;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                                iconSize: [14, 14],
                                iconAnchor: [7, 7]
                            })
                        }).bindPopup('<b>Финиш</b><br>' + (end.address || '') + '<br>' + (end.date || '') + ' ' + (end.time || '')).addTo(map);
                        bounds.push([end.lat, end.lng]);
                    }
                }
            }

            // Build vehicle checkboxes and render tracks
            const filterContainer = document.getElementById('vehicle-filters-' + requestId);

            vehicles.forEach(function(v, vIdx) {
                const color = trackColors[vIdx % trackColors.length];
                const vehicleId = 'v' + vIdx;

                // Create layer group for this vehicle
                const vehicleGroup = L.layerGroup().addTo(map);
                mapVehicleLayers[requestId].push({
                    id: vehicleId,
                    group: vehicleGroup,
                    color: color,
                    vehicle: v
                });

                // Render track with direction arrows and chronology markers
                if (v.track && v.track.length > 0) {
                    const trackCoords = v.track.map(function(p) { return [p.lat, p.lon]; });
                    const trackLine = L.polyline(trackCoords, {
                        color: color,
                        weight: 3,
                        opacity: 0.9,
                        dashArray: '5, 5'
                    }).addTo(vehicleGroup);
                    bounds.push(...trackCoords);

                    // Add chronology markers at start and end of track
                    if (trackCoords.length > 0) {
                        // Start marker (bright small circle)
                        L.circleMarker(trackCoords[0], {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.8,
                            radius: 4,
                            weight: 2
                        }).bindPopup('Начало трека ' + (v.displayName || v.ts_reg_number) + '<br>' + formatDateTime(v.track[0].time)).addTo(vehicleGroup);

                        // End marker (larger dimmer circle)
                        L.circleMarker(trackCoords[trackCoords.length - 1], {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.5,
                            radius: 6,
                            weight: 2
                        }).bindPopup('Конец трека ' + (v.displayName || v.ts_reg_number) + '<br>' + formatDateTime(v.track[v.track.length - 1].time)).addTo(vehicleGroup);
                    }

                    // Add arrow decorators to show direction
                    if (trackCoords.length > 1) {
                        const arrowInterval = Math.max(Math.floor(trackCoords.length / 5), 1);
                        for (let i = arrowInterval; i < trackCoords.length; i += arrowInterval) {
                            const prevPoint = trackCoords[i - 1];
                            const currPoint = trackCoords[i];
                            const angle = Math.atan2(currPoint[0] - prevPoint[0], currPoint[1] - prevPoint[1]) * 180 / Math.PI;

                            L.marker(currPoint, {
                                icon: L.divIcon({
                                    className: 'direction-arrow',
                                    html: '<div style="width:0;height:0;border-left:4px solid transparent;border-right:4px solid transparent;border-bottom:8px solid ' + color + ';transform:rotate(' + angle + 'deg);opacity:0.7;"></div>',
                                    iconSize: [8, 8],
                                    iconAnchor: [4, 4]
                                })
                            }).addTo(vehicleGroup);
                        }
                    }
                }

                // Render parkings with numbering
                if (v.parkings) {
                    v.parkings.forEach(function(p, pIdx) {
                        if (p.lat && p.lon) {
                            // Format time range
                            const beginTime = formatDateTime(p.begin);
                            const endTime = formatDateTime(p.end);
                            const timeRange = beginTime && endTime ? beginTime + ' — ' + endTime : '';

                            const parkingNum = pIdx + 1;
                            const marker = L.marker([p.lat, p.lon], {
                                icon: L.divIcon({
                                    className: 'parking-marker',
                                    html: '<div style="background:#ed8936;width:20px;height:20px;border-radius:50%;border:2px solid white;box-shadow:0 1px 3px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:11px;">' + parkingNum + '</div>',
                                    iconSize: [20, 20],
                                    iconAnchor: [10, 10]
                                })
                            }).bindPopup('<b>🅿️ Стоянка #' + parkingNum + '</b><br>' + v.displayName + '<br>' + (p.address || '—') + '<br><b>' + timeRange + '</b><br>' + (p.duration_min || 0) + ' мін');
                            marker.parkingDuration = p.duration_min || 0;
                            marker.parkingNumber = parkingNum;
                            marker.addTo(vehicleGroup);
                            bounds.push([p.lat, p.lon]);
                        }
                    });
                }

                // Add compact toggle for this vehicle
                if (filterContainer) {
                    const label = document.createElement('label');
                    label.className = 'vehicle-toggle-item';
                    label.title = v.displayName || v.ts_reg_number || 'ТС ' + (vIdx+1);
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = true;
                    checkbox.dataset.vehicleIdx = vIdx;
                    checkbox.onchange = function() { updateMapFilters(requestId); };
                    label.appendChild(checkbox);
                    const dot = document.createElement('span');
                    dot.className = 'vehicle-toggle-dot';
                    dot.style.background = color;
                    label.appendChild(dot);
                    filterContainer.appendChild(label);
                }
            });

            // Fit bounds
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [30, 30] });
            }

            // Add legend
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'map-legend');
                let legendHtml = '<div class="map-legend-item"><div class="map-legend-line" style="background:#3182ce;"></div>План</div>' +
                    '<div class="map-legend-item"><div class="map-legend-marker" style="background:#38a169;"></div>Старт</div>' +
                    '<div class="map-legend-item"><div class="map-legend-marker" style="background:#e53e3e;"></div>Финиш</div>' +
                    '<div class="map-legend-item"><div class="map-legend-marker" style="background:#ed8936;"></div>Стоянка</div>';

                // Add vehicle colors to legend
                vehicles.forEach(function(v, vIdx) {
                    const color = trackColors[vIdx % trackColors.length];
                    legendHtml += '<div class="map-legend-item"><div class="map-legend-line" style="background:'+color+';border-style:dashed;"></div>' + (v.displayName || v.ts_reg_number || 'ТС ' + (vIdx+1)) + '</div>';
                });

                div.innerHTML = legendHtml;
                return div;
            };
            legend.addTo(map);

            // Build initial timeline
            buildTimeline(requestId);
        }

        function updateMapFilters(requestId) {
            const map = mapInstances[requestId];
            const layers = mapVehicleLayers[requestId];
            if (!map || !layers) return;

            const minParking = parseInt(document.getElementById('min-parking-' + requestId).value) || 0;
            const filterContainer = document.getElementById('vehicle-filters-' + requestId);
            const checkboxes = filterContainer ? filterContainer.querySelectorAll('input[type="checkbox"]') : [];

            // Get visible vehicle indices
            const visibleVehicles = [];
            checkboxes.forEach(function(cb) {
                if (cb.checked) {
                    visibleVehicles.push(parseInt(cb.dataset.vehicleIdx));
                }
            });

            // Toggle visibility and filter parkings
            layers.forEach(function(layerData, idx) {
                if (visibleVehicles.indexOf(idx) >= 0) {
                    if (!map.hasLayer(layerData.group)) {
                        map.addLayer(layerData.group);
                    }
                    // Filter parkings by duration
                    layerData.group.eachLayer(function(layer) {
                        if (layer.parkingDuration !== undefined) {
                            if (layer.parkingDuration >= minParking) {
                                layer.setOpacity(1);
                            } else {
                                layer.setOpacity(0);
                            }
                        }
                    });
                } else {
                    if (map.hasLayer(layerData.group)) {
                        map.removeLayer(layerData.group);
                    }
                }
            });

            // Rebuild timeline with filters
            buildTimeline(requestId);
        }

        function buildTimeline(requestId) {
            const timelineEl = document.getElementById('timeline-' + requestId);
            if (!timelineEl) return;

            const vehicles = mapVehiclesData[requestId] || [];
            const layers = mapVehicleLayers[requestId] || [];
            const minParking = parseInt(document.getElementById('min-parking-' + requestId).value) || 0;
            const showParkings = document.getElementById('show-parkings-' + requestId) ? document.getElementById('show-parkings-' + requestId).checked : true;

            // Get time filter if active
            const timeFilter = mapTimeFilters[requestId];

            // Get visible vehicles
            const filterContainer = document.getElementById('vehicle-filters-' + requestId);
            const checkboxes = filterContainer ? filterContainer.querySelectorAll('input[type="checkbox"]') : [];
            const visibleVehicles = [];
            checkboxes.forEach(function(cb) {
                if (cb.checked) {
                    visibleVehicles.push(parseInt(cb.dataset.vehicleIdx));
                }
            });

            let html = '';

            vehicles.forEach(function(v, vIdx) {
                if (visibleVehicles.length > 0 && visibleVehicles.indexOf(vIdx) < 0) return;

                const color = trackColors[vIdx % trackColors.length];

                html += '<div class="timeline-vehicle-group">';
                html += '<div class="timeline-vehicle-header" style="border-left-color:'+color+'">' + (v.displayName || v.ts_reg_number || 'ТС ' + (vIdx+1)) + '</div>';

                // Collect timeline items (points + parkings)
                const items = [];

                // Add track points with adaptive interval (20 min base + gap filling between parkings)
                if (v.track && v.track.length > 0) {
                    const baseIntervalMs = 20 * 60 * 1000; // 20 minutes (matches new API interval)
                    let lastShownTime = null;

                    // Collect parking times for gap detection
                    const parkingTimes = [];
                    if (v.parkings) {
                        v.parkings.forEach(function(p) {
                            if (p.begin) {
                                parkingTimes.push({
                                    time: parseTimeToMs(p.begin),
                                    end: p.end ? parseTimeToMs(p.end) : null
                                });
                            }
                        });
                        parkingTimes.sort(function(a, b) { return a.time - b.time; });
                    }

                    // Track which gaps between parkings have been filled
                    const filledGaps = new Set();

                    v.track.forEach(function(point) {
                        if (point.time && point.lat && point.lon) {
                            const pointTime = parseTimeToMs(point.time);

                            let shouldShow = false;

                            // Rule 1: Always show first point
                            if (lastShownTime === null) {
                                shouldShow = true;
                            }
                            // Rule 2: Show if base interval (20 min) has passed
                            else if ((pointTime - lastShownTime) >= baseIntervalMs) {
                                shouldShow = true;
                            }
                            // Rule 3: Adaptive - fill gaps between close parkings
                            else {
                                // Check if this point fills a gap between consecutive parkings
                                for (let i = 0; i < parkingTimes.length - 1; i++) {
                                    const parking1 = parkingTimes[i];
                                    const parking2 = parkingTimes[i + 1];
                                    const gapKey = i + '-' + (i + 1);

                                    // If parkings are close (< 20 min apart) and no point shown between them yet
                                    if ((parking2.time - parking1.time) < baseIntervalMs && !filledGaps.has(gapKey)) {
                                        // Check if this point is between these parkings
                                        if (pointTime > parking1.time && pointTime < parking2.time) {
                                            shouldShow = true;
                                            filledGaps.add(gapKey);  // Mark gap as filled
                                            break;
                                        }
                                    }
                                }
                            }

                            if (shouldShow) {
                                // Apply time filter if active
                                let includePoint = true;
                                if (timeFilter) {
                                    includePoint = pointTime >= timeFilter.startMs && pointTime <= timeFilter.endMs;
                                }

                                if (includePoint) {
                                    items.push({
                                        type: 'point',
                                        time: point.time,
                                        timeMs: pointTime,
                                        lat: point.lat,
                                        lon: point.lon,
                                        speed: point.speed,
                                        inTimeRange: !timeFilter
                                    });
                                }

                                lastShownTime = pointTime;
                            }
                        }
                    });
                }

                // Add parkings with filter and numbering
                if (v.parkings && showParkings) {
                    let parkingNum = 0;
                    v.parkings.forEach(function(p) {
                        if (p.lat && p.lon && (p.duration_min || 0) >= minParking) {
                            const beginTime = p.begin || '';
                            const beginMs = parseTimeToMs(beginTime);

                            // Apply time filter if active
                            let includeParking = true;
                            if (timeFilter) {
                                includeParking = beginMs >= timeFilter.startMs && beginMs <= timeFilter.endMs;
                            }

                            if (includeParking) {
                                parkingNum++;
                                items.push({
                                    type: 'parking',
                                    parkingNumber: parkingNum,
                                    begin: beginTime,
                                    end: p.end || '',
                                    timeMs: beginMs,
                                    lat: p.lat,
                                    lon: p.lon,
                                    duration: p.duration_min,
                                    address: p.address,
                                    inTimeRange: !timeFilter
                                });
                            }
                        }
                    });
                }

                // Sort by time
                items.sort(function(a, b) { return a.timeMs - b.timeMs; });

                // Render items
                items.forEach(function(item) {
                    const highlightStyle = item.inTimeRange ? '' : 'opacity:0.4;';

                    if (item.type === 'point') {
                        html += '<div class="timeline-item point" style="border-left-color:'+color+';'+highlightStyle+';position:relative;">';
                        html += '<div style="display:flex;justify-content:space-between;align-items:start;">';
                        html += "<div style='flex:1;cursor:pointer;' onclick='focusOnPoint(\""+requestId+"\", "+item.lat+", "+item.lon+", false)'>";
                        html += '<div class="time">📍 ' + formatDateTime(item.time) + '</div>';
                        if (item.speed) html += '<div class="info">' + item.speed + ' км/ч</div>';
                        html += '</div>';
                        html += "<div style='display:flex;gap:2px;flex-shrink:0;'>";
                        html += "<button onclick='event.stopPropagation();setTimeFilterFrom(\""+requestId+"\", \""+item.time+"\")' style='font-size:9px;padding:2px 4px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;' title='Установить как начало'>От</button>";
                        html += "<button onclick='event.stopPropagation();setTimeFilterTo(\""+requestId+"\", \""+item.time+"\")' style='font-size:9px;padding:2px 4px;background:#ed8936;color:white;border:none;border-radius:3px;cursor:pointer;' title='Установить как конец'>До</button>";
                        html += '</div></div></div>';
                    } else {
                        // Format time range for parking
                        const beginFmt = formatDateTime(item.begin);
                        const endFmt = formatDateTime(item.end);
                        const timeRange = beginFmt + ' — ' + endFmt;

                        html += '<div class="timeline-item parking" style="'+highlightStyle+';position:relative;">';
                        html += "<div style='display:flex;justify-content:space-between;align-items:start;'>";
                        html += "<div style='flex:1;cursor:pointer;' onclick='focusOnPoint(\""+requestId+"\", "+item.lat+", "+item.lon+", true)'>";
                        html += '<div class="time">🅿️ Стоянка #' + item.parkingNumber + '</div>';
                        html += '<div class="info">' + timeRange + '</div>';
                        html += '<div class="info">' + (item.duration || 0) + ' мин</div>';
                        if (item.address) html += '<div class="info address">' + item.address + '</div>';
                        html += '</div>';
                        html += "<div style='display:flex;gap:2px;flex-shrink:0;'>";
                        html += "<button onclick='event.stopPropagation();setTimeFilterFrom(\""+requestId+"\", \""+item.begin+"\")' style='font-size:9px;padding:2px 4px;background:#48bb78;color:white;border:none;border-radius:3px;cursor:pointer;' title='Установить как начало'>От</button>";
                        html += "<button onclick='event.stopPropagation();setTimeFilterTo(\""+requestId+"\", \""+item.end+"\")' style='font-size:9px;padding:2px 4px;background:#ed8936;color:white;border:none;border-radius:3px;cursor:pointer;' title='Установить как конец'>До</button>";
                        html += '</div></div></div>';
                    }
                });

                html += '</div>';
            });

            const itemsEl = timelineEl.querySelector('.timeline-items');
            if (itemsEl) {
                itemsEl.innerHTML = html || '<div style="padding:12px;color:#718096;font-size:11px;">Нет данных</div>';
                // Add click handlers via delegation
                itemsEl.onclick = function(e) {
                    const item = e.target.closest('.timeline-item');
                    if (item && item.dataset.lat && item.dataset.lon) {
                        focusOnPoint(item.dataset.reqid, parseFloat(item.dataset.lat), parseFloat(item.dataset.lon));
                    }
                };
            }
        }

        function parseTimeToMs(dtStr) {
            if (!dtStr) return 0;
            // Handle formats: "DD.MM.YYYY HH:MM:SS" or "HH:MM:SS" or "HH:MM"
            const parts = dtStr.split(' ');

            if (parts.length >= 2) {
                // Full datetime: "DD.MM.YYYY HH:MM:SS"
                const datePart = parts[0];
                const timePart = parts[1];
                const dp = datePart.split('.');
                const tp = timePart.split(':');

                if (dp.length === 3 && tp.length >= 2) {
                    const day = parseInt(dp[0]) || 1;
                    const month = parseInt(dp[1]) || 1;
                    const year = parseInt(dp[2]) || 2026;
                    const h = parseInt(tp[0]) || 0;
                    const m = parseInt(tp[1]) || 0;
                    const s = parseInt(tp[2]) || 0;
                    return new Date(year, month - 1, day, h, m, s).getTime();
                }
            }

            // Time only: "HH:MM:SS" or "HH:MM"
            const tp = dtStr.split(':');
            if (tp.length >= 2) {
                const h = parseInt(tp[0]) || 0;
                const m = parseInt(tp[1]) || 0;
                const s = parseInt(tp[2]) || 0;
                return (h * 3600 + m * 60 + s) * 1000;
            }
            return 0;
        }

        function toggleParkings(requestId) {
            const map = mapInstances[requestId];
            const layers = mapVehicleLayers[requestId];
            const showParkings = document.getElementById('show-parkings-' + requestId).checked;

            if (!map || !layers) return;

            // Show/hide parking markers
            layers.forEach(function(layerData) {
                layerData.group.eachLayer(function(layer) {
                    if (layer.options.icon && layer.options.icon.options.className === 'parking-marker') {
                        if (showParkings) {
                            layer.setOpacity(1);
                        } else {
                            layer.setOpacity(0);
                        }
                    }
                });
            });

            buildTimeline(requestId);
        }

        function focusOnPoint(requestId, lat, lon, openPopup) {
            const map = mapInstances[requestId];
            if (map) {
                map.setView([lat, lon], 16, { animate: true, duration: 0.5 });

                // Open popup if requested
                if (openPopup) {
                    setTimeout(function() {
                        map.eachLayer(function(layer) {
                            if (layer.getLatLng && layer.getLatLng().lat === lat && layer.getLatLng().lng === lon) {
                                layer.openPopup();
                            }
                        });
                    }, 500);
                }
            }
        }

        function setTimeFilterFrom(requestId, timeStr) {
            // Parse time string "04.02.2026 08:30:00" or "2026-02-04 08:30:00"
            const parts = timeStr.split(' ');
            if (parts.length >= 2) {
                const datePart = parts[0];
                const timeParts = parts[1].split(':');

                let yyyy, mm, dd;
                if (datePart.indexOf('.') > 0) {
                    // DD.MM.YYYY format
                    const dateParts = datePart.split('.');
                    dd = dateParts[0];
                    mm = dateParts[1];
                    yyyy = dateParts[2];
                } else {
                    // YYYY-MM-DD format
                    const dateParts = datePart.split('-');
                    yyyy = dateParts[0];
                    mm = dateParts[1];
                    dd = dateParts[2];
                }

                document.getElementById('start-date-' + requestId).value = yyyy + '-' + mm + '-' + dd;
                document.getElementById('start-time-' + requestId).value = timeParts[0] + ':' + timeParts[1];
            }
        }

        function setTimeFilterTo(requestId, timeStr) {
            // Parse time string "04.02.2026 08:30:00" or "2026-02-04 08:30:00"
            const parts = timeStr.split(' ');
            if (parts.length >= 2) {
                const datePart = parts[0];
                const timeParts = parts[1].split(':');

                let yyyy, mm, dd;
                if (datePart.indexOf('.') > 0) {
                    // DD.MM.YYYY format
                    const dateParts = datePart.split('.');
                    dd = dateParts[0];
                    mm = dateParts[1];
                    yyyy = dateParts[2];
                } else {
                    // YYYY-MM-DD format
                    const dateParts = datePart.split('-');
                    yyyy = dateParts[0];
                    mm = dateParts[1];
                    dd = dateParts[2];
                }

                document.getElementById('end-date-' + requestId).value = yyyy + '-' + mm + '-' + dd;
                document.getElementById('end-time-' + requestId).value = timeParts[0] + ':' + timeParts[1];
            }
        }

        function applyTimeFilter(requestId) {
            const startDate = document.getElementById('start-date-' + requestId).value;
            const startTime = document.getElementById('start-time-' + requestId).value || '00:00';
            const endDate = document.getElementById('end-date-' + requestId).value;
            const endTime = document.getElementById('end-time-' + requestId).value || '23:59';

            if (!startDate || !endDate) {
                alert('Пожалуйста, выберите даты начала и конца');
                return;
            }

            // Convert YYYY-MM-DD to DD.MM.YYYY for parseTimeToMs
            const startDateParts = startDate.split('-');
            const endDateParts = endDate.split('-');
            const startDateStr = startDateParts[2] + '.' + startDateParts[1] + '.' + startDateParts[0];
            const endDateStr = endDateParts[2] + '.' + endDateParts[1] + '.' + endDateParts[0];

            // Parse dates to milliseconds
            const startMs = parseTimeToMs(startDateStr + ' ' + startTime + ':00');
            const endMs = parseTimeToMs(endDateStr + ' ' + endTime + ':59');

            if (startMs >= endMs) {
                alert('Дата начала должна быть раньше даты конца');
                return;
            }

            mapTimeFilters[requestId] = {
                startMs: startMs,
                endMs: endMs
            };

            // Update track visualization on map
            updateTrackHighlight(requestId);

            // Rebuild timeline with filter
            buildTimeline(requestId);
        }

        function clearTimeFilter(requestId) {
            delete mapTimeFilters[requestId];

            // Clear input fields
            document.getElementById('start-date-' + requestId).value = '';
            document.getElementById('start-time-' + requestId).value = '00:00';
            document.getElementById('end-date-' + requestId).value = '';
            document.getElementById('end-time-' + requestId).value = '23:59';

            // Clear track highlight
            updateTrackHighlight(requestId);

            // Rebuild timeline without filter
            buildTimeline(requestId);
        }

        function updateTrackHighlight(requestId) {
            const vehicles = mapVehiclesData[requestId] || [];
            const layers = mapVehicleLayers[requestId] || [];
            const timeFilter = mapTimeFilters[requestId];
            const map = mapInstances[requestId];

            if (!map) return;

            // Remove old highlight layers
            if (!window.highlightLayers) window.highlightLayers = {};
            if (window.highlightLayers[requestId]) {
                window.highlightLayers[requestId].forEach(layer => map.removeLayer(layer));
            }
            window.highlightLayers[requestId] = [];

            vehicles.forEach(function(v, vIdx) {
                const color = trackColors[vIdx % trackColors.length];
                const layerData = layers[vIdx];

                if (!layerData || !v.track || v.track.length === 0) return;

                if (timeFilter) {
                    // Dim all elements in this vehicle's layer
                    layerData.group.eachLayer(function(layer) {
                        // Dim track lines
                        if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
                            layer.setStyle({ opacity: 0.2, weight: 2 });
                        }
                        // Dim parking markers
                        if (layer.options.icon && layer.options.icon.options.className === 'parking-marker') {
                            layer.setOpacity(0.3);
                        }
                        // Dim direction arrows
                        if (layer.options.icon && layer.options.icon.options.className === 'direction-arrow') {
                            layer.setOpacity(0.2);
                        }
                        // Dim chronology markers
                        if (layer instanceof L.CircleMarker) {
                            layer.setStyle({ opacity: 0.3, fillOpacity: 0.2 });
                        }
                    });

                    // Find and highlight parkings in time range
                    if (v.parkings) {
                        v.parkings.forEach(function(p, pIdx) {
                            if (p.lat && p.lon && p.begin) {
                                const beginMs = parseTimeToMs(p.begin);
                                if (beginMs >= timeFilter.startMs && beginMs <= timeFilter.endMs) {
                                    // Find and restore opacity for this parking marker
                                    layerData.group.eachLayer(function(layer) {
                                        if (layer.getLatLng &&
                                            layer.getLatLng().lat === p.lat &&
                                            layer.getLatLng().lng === p.lon &&
                                            layer.parkingNumber === (pIdx + 1)) {
                                            layer.setOpacity(1);
                                        }
                                    });
                                }
                            }
                        });
                    }

                    // Find track points in time range and draw thick highlight
                    const highlightCoords = [];
                    v.track.forEach(function(point) {
                        if (point.time) {
                            const pointMs = parseTimeToMs(point.time);
                            if (pointMs >= timeFilter.startMs && pointMs <= timeFilter.endMs) {
                                highlightCoords.push([point.lat, point.lon]);
                            }
                        }
                    });

                    // Draw thick highlighted segment
                    if (highlightCoords.length > 0) {
                        const highlightLine = L.polyline(highlightCoords, {
                            color: color,
                            weight: 6,
                            opacity: 1,
                            dashArray: '5, 5'
                        }).addTo(map);
                        window.highlightLayers[requestId].push(highlightLine);

                        // Add arrows on highlighted segment
                        if (highlightCoords.length > 1) {
                            const arrowInterval = Math.max(Math.floor(highlightCoords.length / 3), 1);
                            for (let i = arrowInterval; i < highlightCoords.length; i += arrowInterval) {
                                const prevPoint = highlightCoords[i - 1];
                                const currPoint = highlightCoords[i];
                                const angle = Math.atan2(currPoint[0] - prevPoint[0], currPoint[1] - prevPoint[1]) * 180 / Math.PI;

                                const arrow = L.marker(currPoint, {
                                    icon: L.divIcon({
                                        className: 'direction-arrow-highlight',
                                        html: '<div style="width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-bottom:10px solid ' + color + ';transform:rotate(' + angle + 'deg);opacity:1;"></div>',
                                        iconSize: [10, 10],
                                        iconAnchor: [5, 5]
                                    })
                                }).addTo(map);
                                window.highlightLayers[requestId].push(arrow);
                            }
                        }
                    }
                } else {
                    // No filter - restore full visibility
                    layerData.group.eachLayer(function(layer) {
                        if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
                            layer.setStyle({ opacity: 0.9, weight: 3 });
                        }
                        if (layer.options.icon && layer.options.icon.options.className === 'parking-marker') {
                            layer.setOpacity(1);
                        }
                        if (layer.options.icon && layer.options.icon.options.className === 'direction-arrow') {
                            layer.setOpacity(0.7);
                        }
                        if (layer instanceof L.CircleMarker) {
                            layer.setStyle({ opacity: 1, fillOpacity: 0.8 });
                        }
                    });
                }
            });
        }

        function decodePolyline(encoded) {
            // Google Polyline decoding algorithm
            const points = [];
            let index = 0, lat = 0, lng = 0;

            while (index < encoded.length) {
                let b, shift = 0, result = 0;

                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);

                const dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lat += dlat;

                shift = 0;
                result = 0;

                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);

                const dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lng += dlng;

                points.push([lat / 1e5, lng / 1e5]);
            }

            return points;
        }

        // Archive functionality
        const archivedRequests = new Set();

        async function loadArchivedRequests() {
            try {
                const response = await fetch('/api/archived-numbers');
                if (response.ok) {
                    const data = await response.json();
                    data.numbers.forEach(num => archivedRequests.add(num));
                    updateArchivedUI();
                }
            } catch (e) {
                // Not in web mode or server not available
                console.log('Archive API not available (standalone mode)');
            }
        }

        function updateArchivedUI() {
            document.querySelectorAll('.request').forEach(req => {
                const reqNum = req.getAttribute('data-number');
                if (archivedRequests.has(reqNum)) {
                    req.classList.add('is-archived');
                    const btn = req.querySelector('.archive-btn');
                    if (btn) {
                        btn.classList.add('archived');
                        btn.innerHTML = '✓ Просмотрено';
                    }
                }
            });
        }

        async function toggleArchive(event, reqNum, startAddr, endAddr, startDate, plCount) {
            event.stopPropagation();
            const btn = event.currentTarget;
            const req = btn.closest('.request');

            if (archivedRequests.has(reqNum)) {
                // Unarchive
                try {
                    const response = await fetch('/api/archive', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ request_number: reqNum })
                    });
                    if (response.ok) {
                        archivedRequests.delete(reqNum);
                        req.classList.remove('is-archived');
                        btn.classList.remove('archived');
                        btn.innerHTML = '★ В архив';
                    }
                } catch (e) {
                    console.error('Unarchive failed:', e);
                }
            } else {
                // Archive
                try {
                    const response = await fetch('/api/archive', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            request_number: reqNum,
                            route_start_address: startAddr,
                            route_end_address: endAddr,
                            route_start_date: startDate,
                            pl_count: plCount
                        })
                    });
                    if (response.ok) {
                        archivedRequests.add(reqNum);
                        req.classList.add('is-archived');
                        btn.classList.add('archived');
                        btn.innerHTML = '✓ Просмотрено';
                    }
                } catch (e) {
                    console.error('Archive failed:', e);
                }
            }
        }

        // Load archived on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadArchivedRequests();
        });

        // Shift loading functionality
        async function loadShifts(vehicleUid, plId, tsIdMo, fromDate, toDate) {
            if (!REPORT_ID) {
                alert('Загрузка смен недоступна в автономном режиме');
                return;
            }

            const btn = document.getElementById('shift-btn-' + vehicleUid);
            const container = document.getElementById('shift-container-' + vehicleUid);

            if (!btn || !container) return;

            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '⏳ Загрузка...';

            try {
                const response = await fetch('/api/reports/' + REPORT_ID + '/shifts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pl_id: plId,
                        ts_id_mo: tsIdMo,
                        from_date: fromDate,
                        to_date: toDate
                    })
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки');
                }

                const data = await response.json();
                displayShifts(vehicleUid, data.shifts, data.from_cache);

                // Hide button after successful load
                btn.style.display = 'none';

            } catch (e) {
                console.error('Shift loading failed:', e);
                btn.innerHTML = '❌ Ошибка';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '📊 Загрузить по сменам';
                }, 2000);
            }
        }

        function displayShifts(vehicleUid, shifts, fromCache) {
            const container = document.getElementById('shift-container-' + vehicleUid);
            if (!container || !shifts || shifts.length === 0) {
                container.innerHTML = '<div class="no-data">Нет данных по сменам</div>';
                container.style.display = 'block';
                return;
            }

            // Build tabs for shifts
            let tabsHtml = '<div class="shift-tabs">';
            let contentHtml = '';

            shifts.forEach((shift, idx) => {
                const activeClass = idx === 0 ? ' active' : '';
                const label = shift.label || shift.key;

                tabsHtml += '<button class="shift-tab' + activeClass + '" onclick="switchShift(\'' + vehicleUid + '\', ' + idx + ')">' + label + '</button>';

                // Format shift data
                const d = shift.data || {};
                const distance = (d.mon_distance || 0).toFixed(1);
                const movingHours = (d.mon_moving_time_hours || 0).toFixed(1);
                const engineHours = (d.mon_engine_time_hours || 0).toFixed(1);
                const idlingHours = (d.mon_idling_time_hours || 0).toFixed(1);
                const fuelRate = (d.mon_fuel_rate || 0).toFixed(1);

                contentHtml += '<div class="shift-content' + activeClass + '">';
                contentHtml += '<div class="shift-period">' + (shift.from || '') + ' — ' + (shift.to || '') + '</div>';
                contentHtml += '<div class="shift-grid">';

                if (parseFloat(distance) > 0) {
                    contentHtml += '<div class="shift-item"><div class="label">Пробег</div><div class="value">' + distance + ' км</div></div>';
                }
                if (parseFloat(movingHours) > 0) {
                    contentHtml += '<div class="shift-item"><div class="label">В движении</div><div class="value">' + movingHours + ' ч</div></div>';
                }
                if (parseFloat(engineHours) > 0) {
                    contentHtml += '<div class="shift-item"><div class="label">Двигатель</div><div class="value">' + engineHours + ' ч</div></div>';
                }
                if (parseFloat(idlingHours) > 0) {
                    contentHtml += '<div class="shift-item"><div class="label">Простой</div><div class="value">' + idlingHours + ' ч</div></div>';
                }
                if (parseFloat(fuelRate) > 0) {
                    contentHtml += '<div class="shift-item"><div class="label">Расход топлива</div><div class="value">' + fuelRate + ' л</div></div>';
                }

                contentHtml += '</div></div>';
            });

            tabsHtml += '</div>';

            const cacheNote = fromCache ? '<div class="cache-note">Загружено из кэша</div>' : '';
            container.innerHTML = cacheNote + tabsHtml + '<div class="shift-contents">' + contentHtml + '</div>';
            container.style.display = 'block';
        }

        function switchShift(vehicleUid, shiftIdx) {
            const container = document.getElementById('shift-container-' + vehicleUid);
            if (!container) return;

            // Update tabs
            container.querySelectorAll('.shift-tab').forEach((tab, idx) => {
                tab.classList.toggle('active', idx === shiftIdx);
            });

            // Update content
            container.querySelectorAll('.shift-content').forEach((content, idx) => {
                content.classList.toggle('active', idx === shiftIdx);
            });
        }

        // V2 Layout Functions

        function toggleRequestV2(header) {
            const request = header.closest('.request');
            const requestId = request.dataset.number;
            const subheader = document.getElementById('subheader-' + requestId);
            const body = request.querySelector('.request-body-layout-v2');
            const arrow = header.querySelector('.expand-arrow');

            const isExpanded = body && body.style.display === 'grid';

            if (!isExpanded) {
                // Expand
                if (subheader) subheader.classList.add('active');
                if (body) body.style.display = 'grid';
                if (arrow) arrow.classList.add('up');

                // Init map if not initialized
                setTimeout(function() {
                    const mapContainer = body ? body.querySelector('.map-container') : null;
                    if (mapContainer && !mapContainer.dataset.initialized) {
                        initMap(requestId, mapContainer);
                        mapContainer.dataset.initialized = 'true';
                    } else if (mapContainer && mapInstances[requestId]) {
                        mapInstances[requestId].invalidateSize();
                    }
                }, 150);
            } else {
                // Collapse
                if (subheader) subheader.classList.remove('active');
                if (body) body.style.display = 'none';
                if (arrow) arrow.classList.remove('up');
            }
        }

        function toggleSubheaderSection(headerEl) {
            const section = headerEl.closest('.subheader-section');
            const body = section.querySelector('.subheader-section-body');
            const toggle = section.querySelector('.subheader-section-toggle');
            if (body.classList.contains('active')) {
                body.classList.remove('active');
                toggle.textContent = '▼';
            } else {
                body.classList.add('active');
                toggle.textContent = '▲';
            }
        }

        function selectPLInSubheader(requestId, plIdx) {
            // Mark selected PL
            const subheader = document.getElementById('subheader-' + requestId);
            if (subheader) {
                subheader.querySelectorAll('.subheader-pl-item').forEach((item, idx) => {
                    item.classList.toggle('selected', idx === plIdx);
                });
            }
        }

        function togglePLCompact(el) {
            el.classList.toggle('expanded');
        }

        function selectVehicleV2(requestId, vehicleUid, vehicleIdx) {
            // Update vehicle selector in right column
            const request = document.querySelector('.request[data-number="' + requestId + '"]');
            if (!request) return;

            const selector = request.querySelector('.vehicle-selector');
            if (selector) {
                selector.querySelectorAll('.vehicle-selector-item').forEach(item => {
                    item.classList.remove('selected');
                    if (item.dataset.vehicleUid === vehicleUid) {
                        item.classList.add('selected');
                    }
                });
            }

            // Update compact PL list selection in subheader
            const subheader = document.getElementById('subheader-' + requestId);
            if (subheader) {
                subheader.querySelectorAll('.subheader-pl-item').forEach(item => {
                    item.classList.remove('selected');
                });
            }

            // Swap vehicle fact panel from cache
            const factPanel = document.getElementById('vehicle-fact-' + requestId);
            const cache = document.getElementById('vehicle-cache-' + requestId);
            if (factPanel && cache) {
                const cachedContent = cache.querySelector('[data-vehicle-uid="' + vehicleUid + '"]');
                if (cachedContent) {
                    factPanel.innerHTML = cachedContent.innerHTML;
                }
            }

            // Sync checkboxes above map - uncheck all, check only selected
            const filterContainer = document.getElementById('vehicle-filters-' + requestId);
            if (filterContainer) {
                filterContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = (parseInt(cb.dataset.vehicleIdx) === vehicleIdx);
                });
                updateMapFilters(requestId);
            }

            // Highlight vehicle on map
            highlightVehicleOnMapV2(requestId, vehicleIdx);
        }

        function highlightVehicleOnMapV2(requestId, selectedIdx) {
            const layers = mapVehicleLayers[requestId];
            if (!layers) return;

            layers.forEach((layerData, idx) => {
                layerData.group.eachLayer(function(layer) {
                    if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
                        if (idx === selectedIdx) {
                            layer.setStyle({ opacity: 1, weight: 5 });
                        } else {
                            layer.setStyle({ opacity: 0.3, weight: 2 });
                        }
                    }
                    if (layer.options && layer.options.icon) {
                        // Markers
                        if (idx === selectedIdx) {
                            layer.setOpacity(1);
                        } else {
                            layer.setOpacity(0.4);
                        }
                    }
                });
            });
        }

    </script>
</body>
</html>
